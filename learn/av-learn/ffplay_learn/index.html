<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.120.4"><meta name="theme-color" content="#fff" />
    <meta name="color-scheme" content="light dark">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title> | Hugo 主题 MemE</title>

    <link rel="stylesheet" href="/css/meme.min.5527d02073dfaacd1f5939643079a5eb7534305bd6d96b622afe1782aa234ff1.css"/>

    
    
        
            <script src="/js/meme.min.e46abe484398824efc70edec3126437916974df592d7c395b44f8f60e0f57e9d.js"></script>

        
    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" /></noscript>

    <meta name="author" content="reuixiy" /><meta name="description" content="[TOC] ffplay源码分析 熟悉FFmpeg项目从源码看起，以下是我阅读FFplay的源代……" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Hugo 主题 MemE" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Hugo 主题 MemE" />
    <meta name="msapplication-starturl" content="../../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
        <link rel="canonical" href="https://example.com/learn/av-learn/ffplay_learn/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "1969-07-20T20:17:43+00:00",
        "dateModified": "2023-11-28T21:40:44+08:00",
        "url": "https://example.com/learn/av-learn/ffplay_learn/",
        "headline": "",
        "description": "[TOC] ffplay源码分析 熟悉FFmpeg项目从源码看起，以下是我阅读FFplay的源代……",
        "inLanguage" : "zh-CN",
        "articleSection": "learn",
        "wordCount":  20311 ,
        "image": ["https://example.com/img/ffplay.png","https://example.com/img/ffplay_video.png","https://example.com/img/ffplay_clock.png","https://example.com/img/ffplay_video_clock.png","https://example.com/img/ffplay_delay.png","https://example.com/img/ffplay_sync_threshold.png","https://example.com/img/ffplay_framequeue.png","https://example.com/img/ffplay_framequeue_read.png","https://example.com/img/ffplay_framequeue_index.png"],
        "author": {
            "@type": "Person",
            "description": "Viva La Vida",
            "email": "reuixiy@gmail.com",
            "image": "https://example.com/icons/apple-touch-icon.png",
            "url": "https://io-oi.me/",
            "name": "reuixiy"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)",
        "publisher": {
            "@type": "Organization",
            "name": "Hugo 主题 MemE",
            "logo": {
                "@type": "ImageObject",
                "url": "https://example.com/icons/apple-touch-icon.png"
            },
            "url": "https://example.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://example.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />


<meta name="twitter:site" content="@reuixiy" />
<meta name="twitter:creator" content="@reuixiy" />

    



<meta property="og:title" content="" />
<meta property="og:description" content="[TOC] ffplay源码分析 熟悉FFmpeg项目从源码看起，以下是我阅读FFplay的源代……" />
<meta property="og:url" content="https://example.com/learn/av-learn/ffplay_learn/" />
<meta property="og:site_name" content="Hugo 主题 MemE" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://example.com/img/ffplay.png" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="1969-07-20T20:17:43&#43;00:00" />
    <meta property="article:modified_time" content="2023-11-28T21:40:44&#43;08:00" />
    
    <meta property="article:section" content="learn" />



    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">Hugo 主题 MemE</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">文章</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">分类</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">标签</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">关于</span></a>
                </li>
            
        
            
                
                    
                    
                        <li class="menu-item">
                            <a id="theme-switcher" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5l48.8-97.5a18 18 0 0128 0l48.8 97.5 103.4 -34.5a18 18 0 0119.8 19.8l-34.5 103.4l97.5 48.8a18 18 0 010 28l-97.5 48.8 34.5 103.4a18 18 0 01-19.8 19.8l-103.4-34.5-48.8 97.5a18 18 0 01-28 0l-48.8-97.5l-103.4 34.5a18 18 0 01-19.8-19.8l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8-34.5-103.4a18 18 0 0119.8-19.8zM256 128a128 128 0 10.01 0M256 160a96 96 0 10.01 0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412a256 256 0 10154-407a11.5 11.5 0 00-5 20a201.5 201.5 0 01-134 374a11.5 11.5 0 00-15 13"/></svg></a>
                        </li>
                    
                
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="justify" data-type="learn" data-toc-num="true">

            <h1 class="post-title p-name"></h1>

            

            
                
            

            
                

<div class="post-meta">
    
    
        
        <time datetime="2023-11-28T21:40:44&#43;08:00" class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2023.11.28</time>
    
    
    
        
        
        
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;20311</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;41&nbsp;分钟</span>
    
    
    
</div>

            

            <div class="post-body e-content">
                <p>[TOC]</p>
<h1 id="ffplay源码分析"><a href="#ffplay源码分析" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ffplay源码分析</h1>
<p>熟悉FFmpeg项目从源码看起，以下是我阅读FFplay的源代码的总结；FFplay是FFmpeg项目提供的播放器示例，它的源代码的量也是不少的，其中很多知识点是我们可以学习和借鉴的。</p>
<h2 id="总结构图"><a href="#总结构图" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>总结构图</h2>
<p>参照雷神（<a href="https://blog.csdn.net/leixiaohua1020" target="_blank" rel="noopener">雷霄骅</a>）的FFplay的总体函数调用结构图，自己总结了一个最新版本的结构，其中还有诸多不足，以后有机会慢慢完善；如下图所示。</p>
<img src="img/ffplay.png" alt="总结构图" style="zoom:50%;" />
<p>这就不对主要函数分别解析，我来学习一下其中关键性的思想和ffplay的体系结构。</p>
<h2 id="视频部分"><a href="#视频部分" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>视频部分</h2>
<h3 id="ffplay-video的线程模式"><a href="#ffplay-video的线程模式" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ffplay video的线程模式</h3>
<img src="img/ffplay_video.png" style="zoom:50%;" />
<p>ffplay选择了sdl作为显示SDK，以实现跨平台支持；因为使用了SDL，而video的显示也依赖SDL的窗口显示系统，所以先从main函数的SDL初始化看起：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">       <span class="cm">/* register all codecs, demux and protocols */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if CONFIG_AVDEVICE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="nf">avdevice_register_all</span><span class="p">();</span> <span class="c1">//注册所有解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="nf">avformat_network_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">init_opts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigterm_handler</span><span class="p">);</span>  <span class="cm">/* Interrupt (ANSI).    */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">sigterm_handler</span><span class="p">);</span> <span class="cm">/* Termination (ANSI).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">show_banner</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span> <span class="c1">//打印ffmpag库版本信息，编译时间，编译选项，类库信息等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">parse_options</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">opt_input_file</span><span class="p">);</span> <span class="c1">//解析输入的命令。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="nf">SDL_Init</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">//初始化sdl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;Could not initialize SDL - %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;(Did you set the DISPLAY variable?)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_EventState</span><span class="p">(</span><span class="n">SDL_SYSWMEVENT</span><span class="p">,</span> <span class="n">SDL_IGNORE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_EventState</span><span class="p">(</span><span class="n">SDL_USEREVENT</span><span class="p">,</span> <span class="n">SDL_IGNORE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">  	<span class="c1">//注册flush packet 只是一个标记作用，用于packet队列中，在对packet队列分析时有说明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_init_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flush_pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">flush_pkt</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flush_pkt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> <span class="p">...</span>
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_disable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">SDL_WINDOW_HIDDEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">alwaysontop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if SDL_VERSION_ATLEAST(2, 0, 5)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SDL_WINDOW_ALWAYS_ON_TOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_WARNING</span><span class="p">,</span> <span class="s">&#34;Your SDL version doesn&#39;t support SDL_WINDOW_ALWAYS_ON_TOP. Feature will be inactive.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">borderless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SDL_WINDOW_BORDERLESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SDL_WINDOW_RESIZABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//创建sdl 窗口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">window</span> <span class="o">=</span> <span class="nf">SDL_CreateWindow</span><span class="p">(</span><span class="n">program_name</span><span class="p">,</span> <span class="n">SDL_WINDOWPOS_UNDEFINED</span><span class="p">,</span> <span class="n">SDL_WINDOWPOS_UNDEFINED</span><span class="p">,</span> <span class="n">default_width</span><span class="p">,</span> <span class="n">default_height</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SDL_SetHint</span><span class="p">(</span><span class="n">SDL_HINT_RENDER_SCALE_QUALITY</span><span class="p">,</span> <span class="s">&#34;linear&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//创建sdl 窗口的渲染器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">renderer</span> <span class="o">=</span> <span class="nf">SDL_CreateRenderer</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SDL_RENDERER_ACCELERATED</span> <span class="o">|</span> <span class="n">SDL_RENDERER_PRESENTVSYNC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">renderer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_WARNING</span><span class="p">,</span> <span class="s">&#34;Failed to initialize a hardware accelerated renderer: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">renderer</span> <span class="o">=</span> <span class="nf">SDL_CreateRenderer</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">SDL_GetRendererInfo</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">renderer_info</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_VERBOSE</span><span class="p">,</span> <span class="s">&#34;Initialized %s renderer.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">renderer_info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">window</span> <span class="o">||</span> <span class="o">!</span><span class="n">renderer</span> <span class="o">||</span> <span class="o">!</span><span class="n">renderer_info</span><span class="p">.</span><span class="n">num_texture_formats</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;Failed to create window or renderer: %s&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="nf">do_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">is</span> <span class="o">=</span> <span class="nf">stream_open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">file_iformat</span><span class="p">);</span> <span class="c1">//创建read_thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;Failed to initialize VideoState!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">do_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">event_loop</span><span class="p">(</span><span class="n">is</span><span class="p">);</span> <span class="c1">//主线程 ，sdl——event事件监听和处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>而这里我们主要的两个函数是<code>stream_open</code>和<code>event_loop</code>；<code>stream_open</code>函数的作用是创建<code>read_thread</code>，<code>read_thread</code>会打开文件，解析封装，获取<code>AVStream</code>信息，启动解码器（创建解码线程），并开始读取文件；<code>event_loop</code>函数的作用是处理SDL事件队列中的事件和刷新显示数据，下面会针对这两个函数视频部分的内容进行详细说明。</p>
<h4 id="stream_open"><a href="#stream_open" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>stream_open</h4>
<p>其实在<code>stream_open</code>函数里的关键内容都是初始化一些参数，主要的处理逻辑在<code>read_thread</code>中进行。</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VideoState</span> <span class="o">*</span><span class="nf">stream_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">iformat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">is</span> <span class="o">=</span> <span class="nf">av_mallocz</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VideoState</span><span class="p">));</span> <span class="c1">//创建VideoState 这个很重要，它贯穿整个ffplay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* start video display */</span> <span class="c1">//初始化解码后的帧队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">frame_queue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">VIDEO_PICTURE_QUEUE_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//初始化解码前的帧队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">packet_queue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建读线程的条件信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span> <span class="o">=</span> <span class="nf">SDL_CreateCond</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;SDL_CreateCond(): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//初始化时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">init_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">vidclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">serial</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">is</span><span class="o">-&gt;</span><span class="n">read_tid</span> <span class="o">=</span> <span class="nf">SDL_CreateThread</span><span class="p">(</span><span class="n">read_thread</span><span class="p">,</span> <span class="s">&#34;read_thread&#34;</span><span class="p">,</span> <span class="n">is</span><span class="p">);</span> <span class="c1">//创建读线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">stream_close</span><span class="p">(</span><span class="n">is</span><span class="p">);</span><span class="c1">//出错free一些初始化参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>**<code>VideoState</code>**结构的参数详细说明：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*视频状态器，贯穿整个ffplay的结构*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">VideoState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SDL_Thread</span> <span class="o">*</span><span class="n">read_tid</span><span class="p">;</span>      <span class="c1">//解复用（或读）线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">iformat</span><span class="p">;</span>    <span class="c1">//输入格式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">abort_request</span><span class="p">;</span>         <span class="c1">//中止请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">force_refresh</span><span class="p">;</span>         <span class="c1">//强制刷新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">paused</span><span class="p">;</span>                <span class="c1">//暂停
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">last_paused</span><span class="p">;</span>           <span class="c1">//最后一次暂停状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">queue_attachments_req</span><span class="p">;</span> <span class="c1">//队列附件请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">seek_req</span><span class="p">;</span>              <span class="c1">//快进请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">seek_flags</span><span class="p">;</span>            <span class="c1">//快进标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">seek_pos</span><span class="p">;</span>          <span class="c1">//快进位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">seek_rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">read_pause_return</span><span class="p">;</span> <span class="c1">//读暂停
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>   <span class="c1">//解码格式上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">realtime</span><span class="p">;</span>          <span class="c1">//是否实时码流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">Clock</span> <span class="n">audclk</span><span class="p">;</span> <span class="c1">//音频时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Clock</span> <span class="n">vidclk</span><span class="p">;</span> <span class="c1">//视频时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Clock</span> <span class="n">extclk</span><span class="p">;</span> <span class="c1">//外部时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">FrameQueue</span> <span class="n">pictq</span><span class="p">;</span> <span class="c1">//视频队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FrameQueue</span> <span class="n">subpq</span><span class="p">;</span> <span class="c1">//字幕队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FrameQueue</span> <span class="n">sampq</span><span class="p">;</span> <span class="c1">//pcm流队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">Decoder</span> <span class="n">auddec</span><span class="p">;</span> <span class="c1">//音频解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Decoder</span> <span class="n">viddec</span><span class="p">;</span> <span class="c1">//视频解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Decoder</span> <span class="n">subdec</span><span class="p">;</span> <span class="c1">//字幕解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">audio_stream</span><span class="p">;</span> <span class="c1">//音频码流id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">av_sync_type</span><span class="p">;</span> <span class="c1">//时钟同步类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">audio_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">audio_clock_serial</span><span class="p">;</span> <span class="c1">//音频时钟序号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">audio_diff_cum</span><span class="p">;</span>  <span class="c1">// 用于音频差分计算 /* used for AV difference average computation */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">audio_diff_avg_coef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">audio_diff_threshold</span><span class="p">;</span>        <span class="c1">//音频差分阈值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audio_diff_avg_count</span><span class="p">;</span>           <span class="c1">// 平均差分数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVStream</span> <span class="o">*</span><span class="n">audio_st</span><span class="p">;</span>                 <span class="c1">// 音频码流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PacketQueue</span> <span class="n">audioq</span><span class="p">;</span>                 <span class="c1">// 音频源包队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audio_hw_buf_size</span><span class="p">;</span>              <span class="c1">// 硬件缓冲大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">audio_buf</span><span class="p">;</span>                 <span class="c1">// 音频缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">audio_buf1</span><span class="p">;</span>                <span class="c1">// 音频缓冲区1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_buf_size</span><span class="p">;</span>        <span class="c1">// 音频缓冲大小 /* in bytes */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_buf1_size</span><span class="p">;</span>       <span class="c1">// 音频缓冲大小 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audio_buf_index</span><span class="p">;</span> <span class="cm">/* in bytes */</span> <span class="c1">// 音频缓冲索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audio_write_buf_size</span><span class="p">;</span>           <span class="c1">// 音频写入缓冲大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audio_volume</span><span class="p">;</span>                   <span class="c1">// 音量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">muted</span><span class="p">;</span>                          <span class="c1">// 是否静音
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">AudioParams</span> <span class="n">audio_src</span><span class="p">;</span>       <span class="c1">// 音频参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if CONFIG_AVFILTER
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">struct</span> <span class="n">AudioParams</span> <span class="n">audio_filter_src</span><span class="p">;</span> <span class="c1">// 音频过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">struct</span> <span class="n">AudioParams</span> <span class="n">audio_tgt</span><span class="p">;</span> <span class="c1">// 音频参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">SwrContext</span> <span class="o">*</span><span class="n">swr_ctx</span><span class="p">;</span>   <span class="c1">// 音频转码上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">frame_drops_early</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">frame_drops_late</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">ShowMode</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">// 显示类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SHOW_MODE_NONE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">SHOW_MODE_VIDEO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">SHOW_MODE_WAVES</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">SHOW_MODE_RDFT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">SHOW_MODE_NB</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">show_mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int16_t</span> <span class="n">sample_array</span><span class="p">[</span><span class="n">SAMPLE_ARRAY_SIZE</span><span class="p">];</span> <span class="c1">// 采样数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sample_array_index</span><span class="p">;</span>                  <span class="c1">// 采样索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">last_i_start</span><span class="p">;</span>                        <span class="c1">// 上一开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RDFTContext</span> <span class="o">*</span><span class="n">rdft</span><span class="p">;</span>                       <span class="c1">// 自适应滤波器上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rdft_bits</span><span class="p">;</span>                           <span class="c1">// 自使用比特率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FFTSample</span> <span class="o">*</span><span class="n">rdft_data</span><span class="p">;</span>                    <span class="c1">// 快速傅里叶采样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">xpos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">last_vis_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SDL_Texture</span> <span class="o">*</span><span class="n">vis_texture</span><span class="p">;</span> <span class="c1">// 音频Texture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SDL_Texture</span> <span class="o">*</span><span class="n">sub_texture</span><span class="p">;</span> <span class="c1">// 字幕Texture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SDL_Texture</span> <span class="o">*</span><span class="n">vid_texture</span><span class="p">;</span> <span class="c1">// 视频Texture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">subtitle_stream</span><span class="p">;</span>   <span class="c1">// 字幕码流Id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVStream</span> <span class="o">*</span><span class="n">subtitle_st</span><span class="p">;</span> <span class="c1">// 字幕码流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PacketQueue</span> <span class="n">subtitleq</span><span class="p">;</span> <span class="c1">// 字幕源包队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">frame_timer</span><span class="p">;</span>                 <span class="c1">// 帧计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">frame_last_returned_time</span><span class="p">;</span>    <span class="c1">// 上一次返回时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">frame_last_filter_delay</span><span class="p">;</span>     <span class="c1">// 上一个过滤器延时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">video_stream</span><span class="p">;</span>                   <span class="c1">// 视频码流Id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVStream</span> <span class="o">*</span><span class="n">video_st</span><span class="p">;</span>                 <span class="c1">// 视频码流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PacketQueue</span> <span class="n">videoq</span><span class="p">;</span>                 <span class="c1">// 视频包队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">max_frame_duration</span><span class="p">;</span>          <span class="c1">// 最大帧间显示时间     // maximum duration of a frame - above this, we consider the jump a timestamp discontinuity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">img_convert_ctx</span><span class="p">;</span> <span class="c1">// 视频转码上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">sub_convert_ctx</span><span class="p">;</span> <span class="c1">// 字幕转码上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">eof</span><span class="p">;</span>                            <span class="c1">// 结束标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>                 <span class="c1">// 文件名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">xleft</span><span class="p">,</span> <span class="n">ytop</span><span class="p">;</span> <span class="c1">// 宽高，其实坐标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">step</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if CONFIG_AVFILTER
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="kt">int</span> <span class="n">vfilter_idx</span><span class="p">;</span>                   <span class="c1">// 过滤器索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFilterContext</span> <span class="o">*</span><span class="n">in_video_filter</span><span class="p">;</span>  <span class="c1">// the first filter in the video chain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFilterContext</span> <span class="o">*</span><span class="n">out_video_filter</span><span class="p">;</span> <span class="c1">// the last filter in the video chain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFilterContext</span> <span class="o">*</span><span class="n">in_audio_filter</span><span class="p">;</span>  <span class="c1">// the first filter in the audio chain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFilterContext</span> <span class="o">*</span><span class="n">out_audio_filter</span><span class="p">;</span> <span class="c1">// the last filter in the audio chain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFilterGraph</span> <span class="o">*</span><span class="n">agraph</span><span class="p">;</span>             <span class="c1">// audio filter graph
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">last_video_stream</span><span class="p">,</span> <span class="n">last_audio_stream</span><span class="p">,</span> <span class="n">last_subtitle_stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SDL_cond</span> <span class="o">*</span><span class="n">continue_read_thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">VideoState</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="读取线程read_thread"><a href="#读取线程read_thread" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>读取线程(read_thread)</h4>
<p>read_thread主要按以下步骤执行：</p>
<ol>
<li>准备阶段：打开文件，检测Stream信息，打开解码器</li>
<li>主循环读数据，解封装：读取Packet，存入PacketQueue</li>
</ol>
<p>read_thread的函数比较长，这里不贴完整代码，直接根据其功能分步分析。</p>
<h5 id="准备阶段"><a href="#准备阶段" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>准备阶段</h5>
<p>主要执行一下几个步骤的函数：</p>
<ol>
<li><code>avformat_open_input</code></li>
<li><code>avformat_find_stream_info</code></li>
<li><code>av_find_best_stream</code></li>
<li><code>stream_component_open</code></li>
</ol>
<h6 id="avformat_open_input"><a href="#avformat_open_input" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><strong><code>avformat_open_input</code></strong></h6>
<p>该函数用于打开输入流（这个包括文件和网络流，在ffmpeg内部会把每一个协议封装成<code>URLProtocol</code>，文件对于ffmpeg也是一种协议“file”）</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">ic</span> <span class="o">=</span> <span class="nf">avformat_alloc_context</span><span class="p">();</span> <span class="c1">//创建 AVformatContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;Could not allocate context.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置解码中断回调方法 ，这很重要，在网络中断的时候，发生调用；不设置很容易造成阻塞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ic</span><span class="o">-&gt;</span><span class="n">interrupt_callback</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">decode_interrupt_cb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ic</span><span class="o">-&gt;</span><span class="n">interrupt_callback</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">av_dict_get</span><span class="p">(</span><span class="n">format_opts</span><span class="p">,</span> <span class="s">&#34;scan_all_pmts&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_DICT_MATCH_CASE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_dict_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format_opts</span><span class="p">,</span> <span class="s">&#34;scan_all_pmts&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="n">AV_DICT_DONT_OVERWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">scan_all_pmts_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">iformat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_opts</span><span class="p">);</span> <span class="c1">//打开文件或网络流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">print_error</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>重点强调：**<code>interrupt_callback</code>**用于ffmpeg内部在执行耗时操作时检查是否有退出请求，并提前中断，避免用户退出请求没有及时响应；</p>
<h6 id="avformat_find_stream_info"><a href="#avformat_find_stream_info" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><strong><code>avformat_find_stream_info</code></strong></h6>
<p>该函数是通过读取媒体文件的部分数据来分析流信息；在一些缺少头信息的封装下特别有用，如注释：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">packets</span> <span class="n">of</span> <span class="n">a</span> <span class="n">media</span> <span class="n">file</span> <span class="n">to</span> <span class="n">get</span> <span class="n">stream</span> <span class="n">information</span><span class="p">.</span> <span class="n">This</span>
</span></span><span class="line"><span class="cl"><span class="n">is</span> <span class="n">useful</span> <span class="k">for</span> <span class="n">file</span> <span class="n">formats</span> <span class="n">with</span> <span class="n">no</span> <span class="n">headers</span> <span class="n">such</span> <span class="n">as</span> <span class="n">MPEG</span><span class="p">.</span> <span class="n">This</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span> <span class="n">also</span> <span class="n">computes</span> <span class="n">the</span> <span class="n">real</span> <span class="n">framerate</span> <span class="n">in</span> <span class="k">case</span> <span class="n">of</span> <span class="n">MPEG</span><span class="o">-</span><span class="mi">2</span> <span class="n">repeat</span>
</span></span><span class="line"><span class="cl"><span class="n">rame</span> <span class="n">mode</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">logical</span> <span class="n">file</span> <span class="n">position</span> <span class="n">is</span> <span class="n">not</span> <span class="n">changed</span> <span class="n">by</span> <span class="n">this</span> <span class="n">function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">examined</span> <span class="n">packets</span> <span class="n">may</span> <span class="n">be</span> <span class="n">buffered</span> <span class="k">for</span> <span class="n">later</span> <span class="n">processing</span><span class="p">.</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="av_find_best_stream"><a href="#av_find_best_stream" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><strong><code>av_find_best_stream</code></strong></h6>
<p>该函数选择对应的媒体流，ffplay主要通过下述注释中的3个参数找到“最佳流”；</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">ic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">enum</span> <span class="n">AVMediaType</span> <span class="n">type</span><span class="p">,</span><span class="c1">//要选择的流类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">int</span> <span class="n">wanted_stream_nb</span><span class="p">,</span><span class="c1">//目标流索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">int</span> <span class="n">related_stream</span><span class="p">,</span><span class="c1">//参考流索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">AVCodec</span> <span class="o">**</span><span class="n">decoder_ret</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="stream_component_open"><a href="#stream_component_open" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><strong><code>stream_component_open</code></strong></h6>
<p>该函数是根据目标流打开对应的解码器；<code>stream_component_open</code>的函数内容比较长，接下来就逐步分析一下ffplay是如何打开解码器的：</p>
<ol>
<li>创建和初始化<code>AVCodecContex</code>，然后通过<code>avcodec_parameters_to_context</code>把所选流的解码参数赋给<code>avctx</code>，最后设了<code>time_base</code>.代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">   <span class="c1">//创建编解码器上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">avctx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">avctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从找到对应的流中的codecpar，codecpar其实是avcodec_parameters，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 然后将它完全复制到创建的AVCodecContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">avctx</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">pkt_timebase</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><ol start="2">
<li>
<p>通过<code>avcodec_find_decoder</code>找到对应的解码器（<code>AVCodec</code>）,如果用户设置了<code>forced_codec_name</code>，则通过<code>avcodec_find_decoder_by_name</code>找到对应的解码器；在找到解码器后通过<code>avcodec_open2</code>是否能打开解码器</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">codec</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">avctx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span> <span class="c1">//找到对应的解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">avctx</span><span class="o">-&gt;</span><span class="n">codec_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">AVMEDIA_TYPE_AUDIO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_audio_stream</span> <span class="o">=</span> <span class="n">stream_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">forced_codec_name</span> <span class="o">=</span> <span class="n">audio_codec_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">AVMEDIA_TYPE_SUBTITLE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_subtitle_stream</span> <span class="o">=</span> <span class="n">stream_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">forced_codec_name</span> <span class="o">=</span> <span class="n">subtitle_codec_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">AVMEDIA_TYPE_VIDEO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_video_stream</span> <span class="o">=</span> <span class="n">stream_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">forced_codec_name</span> <span class="o">=</span> <span class="n">video_codec_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//通过编码器的名字，来打开对应的解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">forced_codec_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">codec</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder_by_name</span><span class="p">(</span><span class="n">forced_codec_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">forced_codec_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_WARNING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="s">&#34;No codec could be found with name &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">forced_codec_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_WARNING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="s">&#34;No decoder could be found for codec %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">avcodec_get_name</span><span class="p">(</span><span class="n">avctx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//打开解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">avctx</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
<li>
<p>对于解码器特定参数的初始化和创建对应流的解码线程；（节选自AVMEDIA_TYPE_VIDEO分支）</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> <span class="o">=</span> <span class="n">stream_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream_index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">decoder_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">,</span> <span class="n">avctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="nf">decoder_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">,</span> <span class="n">video_thread</span><span class="p">,</span> <span class="s">&#34;video_decoder&#34;</span><span class="p">,</span> <span class="n">is</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">queue_attachments_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>看看<code>decoder_init</code>和<code>decoder_start</code>两个函数的定义：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decoder_init</span><span class="p">(</span><span class="n">Decoder</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">avctx</span><span class="p">,</span> <span class="n">PacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">SDL_cond</span> <span class="o">*</span><span class="n">empty_queue_cond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Decoder</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span> <span class="o">=</span> <span class="n">avctx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">empty_queue_cond</span> <span class="o">=</span> <span class="n">empty_queue_cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">start_pts</span> <span class="o">=</span> <span class="n">AV_NOPTS_VALUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt_serial</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">decoder_start</span><span class="p">(</span><span class="n">Decoder</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">thread_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">packet_queue_start</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">-&gt;</span><span class="n">decoder_tid</span> <span class="o">=</span> <span class="nf">SDL_CreateThread</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">thread_name</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">decoder_tid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;SDL_CreateThread(): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>decoder_init</code>比较简单，看<code>decoder_start</code>。<code>decoder_start</code>中“启动”了PacketQueue，并创建了一个名为&quot;decoder&quot;的线程专门用于解码，具体的解码流程由传入参数fn决定。比如对于视频，是<code>video_thread</code>。</p>
</li>
</ol>
<h5 id="主循环读数据"><a href="#主循环读数据" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>主循环读数据</h5>
<p>在读线程中的主循环读数据阶段，主要的代码就<code>av_read_frame</code>和<code>packet_queue_put</code>，<code>av_read_frame</code>从文件中读取视频数据，并获取一个AVPacket，<code>packet_queue_put</code>把它放入到对应的PacketQueue中。</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span> <span class="c1">//中断，结束播放
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_paused</span><span class="p">)</span><span class="c1">//暂停/恢复的处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">seek_req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="c1">//跳帧请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="p">...</span>
</span></span><span class="line"><span class="cl">       	<span class="p">}</span>
</span></span><span class="line"><span class="cl">      	   <span class="cm">/* if the queue are full, no need to read more */</span> <span class="c1">//数据队列满的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">infinite_buffer</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_QUEUE_SIZE</span> <span class="o">||</span> <span class="p">(</span><span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                                                                         <span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                                                                         <span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* wait 10 ms */</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_CondWaitTimeout</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">,</span> <span class="n">wait_mutex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//循环播放处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span> <span class="o">||</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">.</span><span class="n">finished</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">.</span><span class="n">serial</span> <span class="o">&amp;&amp;</span> <span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">sampq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span> <span class="o">||</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">.</span><span class="n">finished</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">serial</span> <span class="o">&amp;&amp;</span> <span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">loop</span> <span class="o">||</span> <span class="o">--</span><span class="n">loop</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">stream_seek</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">autoexit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="n">AVERROR_EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_read_frame</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span> <span class="c1">//将数据读取出，送入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span> <span class="o">||</span> <span class="nf">avio_feof</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span> <span class="o">&amp;&amp;</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">autoexit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*读取失败的话，读取失败的原因有很多，其他地方可能会重新Signal这个锁condition。如果没有singal这个condition的话，就会等待10ms之后，
</span></span></span><span class="line"><span class="cl"><span class="cm">            再释放，重新循环读取. 那这个continue_read_thread 到底是锁了哪呢？*/</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_CondWaitTimeout</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">,</span> <span class="n">wait_mutex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* check if packet is in play range specified by user, then queue, otherwise discard */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//记录stream_start_time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">stream_start_time</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果没有pts, 就用dts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pkt_ts</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">==</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="nl">dts</span> <span class="p">:</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*判断是否在范围内。如果duration还没被定义的话，通过
</span></span></span><span class="line"><span class="cl"><span class="cm">        或者在定义的duration内才可以，用当前的pts-start_time .
</span></span></span><span class="line"><span class="cl"><span class="cm">        duration 会在解码器打开之后，才会被初始化*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkt_in_play_range</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">==</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="n">pkt_ts</span> <span class="o">-</span> <span class="p">(</span><span class="n">stream_start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">stream_start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">                                        <span class="nf">av_q2d</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">)</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">&lt;=</span>
</span></span><span class="line"><span class="cl">                                <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将解复用得到的数据包添加到对应的待解码队列中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="o">-&gt;</span><span class="n">disposition</span> <span class="o">&amp;</span> <span class="n">AV_DISPOSITION_ATTACHED_PIC</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="暂停恢复处理"><a href="#暂停恢复处理" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>暂停/恢复处理：</h6>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_paused</span><span class="p">)</span> <span class="p">{</span><span class="c1">//如果paused变量改变，说明暂停状态改变
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_paused</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span><span class="c1">//如果暂停调用av_read_pause
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">is</span><span class="o">-&gt;</span><span class="n">read_pause_return</span> <span class="o">=</span> <span class="nf">av_read_pause</span><span class="p">(</span><span class="n">ic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="c1">//如果恢复播放调用av_read_play
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_read_play</span><span class="p">(</span><span class="n">ic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>ffmpeg有专门针对暂停和恢复的函数，所以直接调用就可以了。</p>
<h6 id="seek的处理"><a href="#seek的处理" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>seek的处理：</h6>
<p>主要的seek操作通过avformat_seek_file完成。根据avformat_seek_file的返回值，如果seek成功，需要：</p>
<ol>
<li>清除PacketQueue的缓存，并放入一个flush_pkt。放入的flush_pkt可以让PacketQueue的serial增1，以区分seek前后的数据;(在分析PacketQueue会详细说明)</li>
<li>同步外部时钟；（在音视频同步部分会详细说明）</li>
<li>最后清理一些变量，通过<code>step_to_next_frame</code>完成</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> 						<span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_seek_file</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">seek_min</span><span class="p">,</span> <span class="n">seek_target</span><span class="p">,</span> <span class="n">seek_max</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">seek_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="s">&#34;%s: error while seeking</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//清空缓冲队列，向解码线程传入flush事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flush_pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flush_pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flush_pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              	<span class="c1">//同步外部时钟信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">seek_flags</span> <span class="o">&amp;</span> <span class="n">AVSEEK_FLAG_BYTE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">set_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">extclk</span><span class="p">,</span> <span class="n">NAN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">set_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">extclk</span><span class="p">,</span> <span class="n">seek_target</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">AV_TIME_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">seek_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">queue_attachments_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">step_to_next_frame</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="缓冲区大小判断"><a href="#缓冲区大小判断" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>缓冲区大小判断：</h6>
<p>缓冲区大小满的情况判断有两种：</p>
<ol>
<li>所有流队列缓冲大小总和大于MAX_QUEUE_SIZE（15M）时；</li>
<li>各种流的队列都已有够用的包；</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* if the queue are full, no need to read more */</span> <span class="c1">//数据队列满的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">infinite_buffer</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_QUEUE_SIZE</span> <span class="c1">//所有流队列缓冲大小总和大于MAX_QUEUE_SIZE（15M）时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">||</span> <span class="p">(</span><span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">)</span> <span class="c1">//各种流都已有够用的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">&amp;&amp;</span><span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="o">&amp;&amp;</span><span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_st</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* wait 10 ms */</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_CondWaitTimeout</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">,</span> <span class="n">wait_mutex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>在看看函数<code>stream_has_enough_packets</code>是如何判断流队列都已有够用的包</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">stream_has_enough_packets</span><span class="p">(</span><span class="n">AVStream</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream_id</span><span class="p">,</span> <span class="n">PacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">stream_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">queue</span><span class="o">-&gt;</span><span class="n">abort_request</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">disposition</span> <span class="o">&amp;</span> <span class="n">AV_DISPOSITION_ATTACHED_PIC</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">queue</span><span class="o">-&gt;</span><span class="n">nb_packets</span> <span class="o">&gt;</span> <span class="n">MIN_FRAMES</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">||</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>从函数内部结构可以看出，在满足PacketQueue总时长为0，或总时长超过1s的前提下：</p>
<p>有这么几种情况包是够用的：</p>
<ol>
<li>流没有打开（stream_id &lt; 0）</li>
<li>有退出请求（queue-&gt;abort_request）</li>
<li>配置了AV_DISPOSITION_ATTACHED_PIC，流以附件图片/“封面图片”的形式存储在文件；</li>
<li>队列内包个数大于MIN_FRAMES（=25）</li>
</ol>
<h6 id="在播放完的情况下处理"><a href="#在播放完的情况下处理" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>在播放完的情况下处理：</h6>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span> <span class="o">||</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">.</span><span class="n">finished</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">.</span><span class="n">serial</span> 
</span></span><span class="line"><span class="cl">                               <span class="o">&amp;&amp;</span> <span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">sampq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">        											<span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span> <span class="o">||</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">.</span><span class="n">finished</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">serial</span> 
</span></span><span class="line"><span class="cl">                             <span class="o">&amp;&amp;</span> <span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">loop</span> <span class="o">||</span> <span class="o">--</span><span class="n">loop</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">stream_seek</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">autoexit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="n">AVERROR_EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>判断播放已完成的条件，需要满足：</p>
<ol>
<li>不在暂停状态</li>
<li>音频未打开，或者打开了，但是解码已解码完毕，serial等于PacketQueue的serial，并且PacketQueue中没有节点了</li>
<li>视频未打开，或者打开了，但是解码已解码完毕，serial等于PacketQueue的serial，并且PacketQueue中没有节点了</li>
</ol>
<p>在确认已结束的情况下，用户有两个变量可以控制播放器行为：</p>
<ol>
<li>loop: 控制播放次数（当前这次也算在内，也就是最小就是1次了），0表示无限次</li>
<li>autoexit：自动退出，也就是播放完成后自动退出。</li>
</ol>
<h6 id="读解复用处理"><a href="#读解复用处理" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>读（解复用）处理：</h6>
<p>解复用处理的步骤如下：</p>
<ol>
<li>通过<code>av_read_frame</code>读取一个包（<code>AVPacket</code>）</li>
<li>返回值处理，一些出错处理过程</li>
<li><code>pkt_ts</code>重计算过程</li>
<li><code>packet_queue_put</code>放入各自队列，或者丢弃</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_read_frame</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span> <span class="c1">//将数据读取出，送入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="c1">//文件读取完了，调用packet_queue_put_nullpacket通知解码线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span> <span class="o">||</span> <span class="nf">avio_feof</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">packet_queue_put_nullpacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//发生错误了，退出主循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span> <span class="o">&amp;&amp;</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">autoexit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*读取失败的话，读取失败的原因有很多，其他地方可能会重新Signal这个锁condition。
</span></span></span><span class="line"><span class="cl"><span class="cm">            如果没有singal这个condition的话，就会等待10ms之后，
</span></span></span><span class="line"><span class="cl"><span class="cm">            再释放，重新循环读取. 那这个continue_read_thread 到底是锁了哪呢？*/</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_CondWaitTimeout</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">,</span> <span class="n">wait_mutex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">wait_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* check if packet is in play range specified by user, then queue, otherwise discard */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//记录stream_start_time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">stream_start_time</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果没有pts, 就用dts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pkt_ts</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">==</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="nl">dts</span> <span class="p">:</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*判断是否在范围内。如果duration还没被定义的话，通过
</span></span></span><span class="line"><span class="cl"><span class="cm">        或者在定义的duration内才可以，用当前的pts-start_time .
</span></span></span><span class="line"><span class="cl"><span class="cm">        duration 会在解码器打开之后，才会被初始化*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkt_in_play_range</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">==</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="n">pkt_ts</span> <span class="o">-</span> <span class="p">(</span><span class="n">stream_start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">stream_start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">                                        <span class="nf">av_q2d</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">)</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">start_time</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span> <span class="o">?</span> <span class="nl">start_time</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">&lt;=</span>
</span></span><span class="line"><span class="cl">                                <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将解复用得到的数据包添加到对应的待解码队列中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_stream</span> 
</span></span><span class="line"><span class="cl">                 <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span> 
</span></span><span class="line"><span class="cl">                 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="o">-&gt;</span><span class="n">disposition</span> 
</span></span><span class="line"><span class="cl">                      <span class="o">&amp;</span> <span class="n">AV_DISPOSITION_ATTACHED_PIC</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitle_stream</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_in_play_range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">packet_queue_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">subtitleq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="视频解码线程video_thread"><a href="#视频解码线程video_thread" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>视频解码线程(video_thread)</h4>
<p>在read_thread中已经创建了对应需要的解码器(<code>AVCodec</code>)；而在video_thread中需要创建<code>AVFrame</code>,来接收解码后的数据；确定视频帧率，开启循环解码；</p>
<h5 id="参数初始化"><a href="#参数初始化" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>参数初始化</h5>
<p>创建AVFrame和得到大致的视频帧率</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span> <span class="c1">//创建AVFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVRational</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//猜测视频帧率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVRational</span> <span class="n">frame_rate</span> <span class="o">=</span> <span class="nf">av_guess_frame_rate</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h5 id="循环解码"><a href="#循环解码" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>循环解码</h5>
<p>循环解码的总流：</p>
<ol>
<li><code>get_video_frame</code>获取解码后的一帧图像</li>
<li>“计算”时长和pts</li>
<li>调用<code>queue_picture</code>将一帧图像放入FrameQueue</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> <span class="k">for</span> <span class="p">(;;)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_video_frame</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">the_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取当前帧播放时长
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_rate</span><span class="p">.</span><span class="n">num</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">frame_rate</span><span class="p">.</span><span class="n">den</span> <span class="o">?</span> 
</span></span><span class="line"><span class="cl">                        <span class="nf">av_q2d</span><span class="p">((</span><span class="n">AVRational</span><span class="p">){</span><span class="n">frame_rate</span><span class="p">.</span><span class="n">den</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">.</span><span class="n">num</span><span class="p">})</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//当前帧显示时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">pts</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">==</span> <span class="n">AV_NOPTS_VALUE</span><span class="p">)</span> <span class="o">?</span> <span class="nl">NAN</span> <span class="p">:</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">*</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 将当前帧压入frame_queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ret</span> <span class="o">=</span> <span class="nf">queue_picture</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pkt_pos</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">.</span><span class="n">pkt_serial</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_frame_unref</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span> <span class="c1">//释放frame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">the_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="get_video_frame"><a href="#get_video_frame" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>get_video_frame</code></h6>
<p>​		调用<code>decoder_decode_frame</code>解码,获取成功后主要做丢帧处理，丢帧的主要条件是<code>diff - is-&gt;frame_last_filter_delay &lt; 0</code>，<code>frame_last_filter_delay</code>与滤镜有关，可以先忽略，也就是<code>diff &lt; 0</code>的时候丢帧——<code>pts &lt; get_master_clock(is)</code>的时候丢帧。<code>decoder_decode_frame</code>真正解码函数；</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_video_frame</span><span class="p">(</span><span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">got_picture</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">got_picture</span> <span class="o">=</span> <span class="nf">decoder_decode_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">got_picture</span><span class="p">)</span><span class="c1">//解码是否成功，主要做丢帧处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">dpts</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span><span class="p">)</span><span class="c1">//通过 pts*av_q2d(timebase)可以得到准确的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">dpts</span> <span class="o">=</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//重新得到视频的比例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_aspect_ratio</span> <span class="o">=</span> <span class="nf">av_guess_sample_aspect_ratio</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">framedrop</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">framedrop</span> <span class="o">&amp;&amp;</span> <span class="nf">get_master_sync_type</span><span class="p">(</span><span class="n">is</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AV_SYNC_VIDEO_MASTER</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">!=</span> <span class="n">AV_NOPTS_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//得到的是当前的时间和时间钟之间的差值。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">double</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">dpts</span> <span class="o">-</span> <span class="nf">get_master_clock</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isnan</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">fabs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">AV_NOSYNC_THRESHOLD</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">diff</span> <span class="o">-</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_last_filter_delay</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">is</span><span class="o">-&gt;</span><span class="n">viddec</span><span class="p">.</span><span class="n">pkt_serial</span> <span class="o">==</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">vidclk</span><span class="p">.</span><span class="n">serial</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">nb_packets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_drops_early</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">av_frame_unref</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">got_picture</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">got_picture</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="decoder_decode_frame"><a href="#decoder_decode_frame" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>decoder_decode_frame</code></h6>
<p><code>decoder_decode_frame</code>的主干代码是一个循环，要拿到一帧解码数据，或解码出错、文件结束，才会返回。</p>
<p>循环总共3个步骤：</p>
<ol>
<li>流连续的情况下，不断调用avcodec_receive_frame获取解码后的frame</li>
<li>取一个packet，顺带过滤“过时”的packet</li>
<li>将packet送入解码器</li>
</ol>
<p>有一个<code>packet_pending</code>的概念，用于在send失败时重新发送；当收到flush_pkt时进行相应的flush事件处理，PacketQueue发生改变时第一个pkt将是flush_pkt，根据ffmpeg的API要求，需要调用<code>avcodec_flush_buffers</code>。</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">decoder_decode_frame</span><span class="p">(</span><span class="n">Decoder</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">AVSubtitle</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVPacket</span> <span class="n">pkt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1. 流连续的情况下，不断调用avcodec_receive_frame获取解码后的frame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt_serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="o">-&gt;</span><span class="n">codec_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">AVMEDIA_TYPE_VIDEO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">decoder_reorder_pts</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">best_effort_timestamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decoder_reorder_pts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pkt_dts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">d</span><span class="o">-&gt;</span><span class="n">finished</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt_serial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">avcodec_flush_buffers</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//2. 取一个packet，顺带过滤“过时”的packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 队列为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">nb_packets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">SDL_CondSignal</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">empty_queue_cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果有待重发的pkt，则先取待重发的pkt，否则从队列中取一个pkt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">packet_pending</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_packet_move_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">d</span><span class="o">-&gt;</span><span class="n">packet_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//取出下一帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nf">packet_queue_get</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt_serial</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//队列的序列不相同时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt_serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//针对flush_pkt的处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">flush_pkt</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">avcodec_flush_buffers</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">d</span><span class="o">-&gt;</span><span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">d</span><span class="o">-&gt;</span><span class="n">next_pts</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">start_pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">d</span><span class="o">-&gt;</span><span class="n">next_pts_tb</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">start_pts_tb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//3. 将packet送入解码器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">)</span> <span class="o">==</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">av_log</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">avctx</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Receive_frame and send_packet both returned EAGAIN, which is an API violation.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">d</span><span class="o">-&gt;</span><span class="n">packet_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">av_packet_move_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h6 id="queue_picture"><a href="#queue_picture" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>queue_picture</code></h6>
<p><code>queue_picture</code>主要用于把<code>get_video_frame</code>函数取到正确解码后的一帧数据放入FrameQueue；</p>
<ol>
<li><code>frame_queue_peek_writable</code>取FrameQueue的当前写节点；</li>
<li>把该解码后的帧数据拷贝给节点(struct Frame)保存</li>
<li><code>frame_queue_push</code>，“push”节点到队列中</li>
</ol>
<p>AVFrame的拷贝是通过<code>av_frame_move_ref</code>实现的，所以拷贝后<code>src_frame</code>就是无效的；</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_picture</span><span class="p">(</span><span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">src_frame</span><span class="p">,</span> <span class="kt">double</span> <span class="n">pts</span><span class="p">,</span> <span class="kt">double</span> <span class="n">duration</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Frame</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(DEBUG_SYNC)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;frame_type=%c pts=%0.3f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="nf">av_get_picture_type_char</span><span class="p">(</span><span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">pict_type</span><span class="p">),</span> <span class="n">pts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vp</span> <span class="o">=</span> <span class="nf">frame_queue_peek_writable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">)))</span> <span class="c1">//判断是否有空间可以写入，并取FrameQueue的当前写节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">sample_aspect_ratio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">uploaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//修改窗口大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">set_default_window_size</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">sar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">av_frame_move_ref</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="n">src_frame</span><span class="p">);</span> <span class="c1">//将src_frame的内存空间指向vp-&gt;frame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">frame_queue_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span>            <span class="c1">//重新推入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="ffplay-audio输出的线程分析"><a href="#ffplay-audio输出的线程分析" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ffplay audio输出的线程分析</h3>
<p>ffplay audio的解码过程与video的一样，都在<code>decoder_decode_frame</code>函数中执行，在 video已经进行分析，这里就不做单独分析了，主要分析audio的输出；ffplay的audio输出同样也是通过SDL实现的;audio输出相关内容，且尽量不涉及音视频同步知识，音视频同步将专门一个章节分析。</p>
<p>audio的输出在SDL下是被动输出，即在开启SDL会在需要输出时，回调通知，在回调函数中，SDL会告知要发送多少的数据。</p>
<p>sdl通过sdl_audio_callback函数向ffplay要音频数据，ffplay将sampq中的数据通过<code>audio_decode_frame</code>函数取出，放入<code>is-&gt;audio_buf</code>，然后送出给sdl。在后续回调时先找<code>audio_buf</code>要数据，数据不足的情况下，再调用<code>audio_decode_frame</code>补充<code>audio_buf</code></p>
<h4 id="sdl打开音频输出"><a href="#sdl打开音频输出" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>sdl打开音频输出</h4>
<p>在<code>stream_component_open</code>中的audio分支进行调用<code>audio_open</code>打开sdl音频输出；代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">AVMEDIA_TYPE_AUDIO</span><span class="p">:</span> <span class="c1">//音频相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if CONFIG_AVFILTER          </span><span class="c1">//过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVFilterContext</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//从avctx(即AVCodecContext)中获取音频格式参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_filter_src</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_filter_src</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_filter_src</span><span class="p">.</span><span class="n">channel_layout</span> <span class="o">=</span> <span class="nf">get_valid_channel_layout</span><span class="p">(</span><span class="n">avctx</span><span class="o">-&gt;</span><span class="n">channel_layout</span><span class="p">,</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_filter_src</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">sample_fmt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="nf">configure_audio_filters</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">afilters</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sink</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">out_audio_filter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sample_rate</span> <span class="o">=</span> <span class="nf">av_buffersink_get_sample_rate</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">nb_channels</span> <span class="o">=</span> <span class="nf">av_buffersink_get_channels</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel_layout</span> <span class="o">=</span> <span class="nf">av_buffersink_get_channel_layout</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nb_channels</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel_layout</span> <span class="o">=</span> <span class="n">avctx</span><span class="o">-&gt;</span><span class="n">channel_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* prepare audio output */</span> <span class="c1">//打开音频输出通道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/*调用audio_open打开sdl音频输出，实际打开的设备参数保存在audio_tgt，返回值表示输出设备的缓冲区大小*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="nf">audio_open</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">channel_layout</span><span class="p">,</span> <span class="n">nb_channels</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_hw_buf_size</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//初始化audio_buf相关参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* init averaging filter */</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_diff_avg_coef</span> <span class="o">=</span> <span class="nf">exp</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">/</span> <span class="n">AUDIO_DIFF_AVG_NB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_diff_avg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* since we do not have a precise anough audio FIFO fullness,
</span></span></span><span class="line"><span class="cl"><span class="cm">           we correct audio sync only if larger than this threshold */</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_diff_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_hw_buf_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">bytes_per_sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_stream</span> <span class="o">=</span> <span class="n">stream_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream_index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">decoder_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">,</span> <span class="n">avctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">continue_read_thread</span><span class="p">);</span> <span class="c1">//初始化对应的解码线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">((</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">iformat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AVFMT_NOBINSEARCH</span> <span class="o">|</span> <span class="n">AVFMT_NOGENSEARCH</span> <span class="o">|</span> <span class="n">AVFMT_NO_BYTE_SEEK</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">iformat</span><span class="o">-&gt;</span><span class="n">read_seek</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">.</span><span class="n">start_pts</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">.</span><span class="n">start_pts_tb</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_st</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="nf">decoder_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">auddec</span><span class="p">,</span> <span class="n">audio_thread</span><span class="p">,</span> <span class="s">&#34;audio_decoder&#34;</span><span class="p">,</span> <span class="n">is</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// 正式开启解码线程。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SDL_PauseAudioDevice</span><span class="p">(</span><span class="n">audio_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>由于不同的音频输出设备支持的参数不同，音轨的参数不一定能被输出设备支持（此时就需要重采样了），<code>audio_tgt</code>就保存了输出设备参数。</p>
<p>介绍下audio_buf相关的几个变量：</p>
<ul>
<li>audio_buf: 从要输出的AVFrame中取出的音频数据（PCM），如果有必要，则对该数据重采样。</li>
<li>audio_buf_size: audio_buf的总大小</li>
<li>audio_buf_index: 下一次可读的audio_buf的index位置。</li>
<li>audio_write_buf_size：audio_buf已经输出的大小，即audio_buf_size - audio_buf_index</li>
</ul>
<h4 id="音频输出逻辑"><a href="#音频输出逻辑" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>音频输出逻辑</h4>
<p>在<code>audio_open</code>函数内，通过通过<code>SDL_OpenAudioDevice</code>注册<code>sdl_audio_callback</code>函数为音频输出的回调函数。那么，主要的音频输出的逻辑就在<code>sdl_audio_callback</code>函数内了。</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* prepare a new audio buffer */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sdl_audio_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">Uint8</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">audio_size</span><span class="p">,</span> <span class="n">len1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">audio_callback_time</span> <span class="o">=</span> <span class="nf">av_gettime_relative</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="c1">//循环发送，直到发够所需数据长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//如果audio_buf消耗完了，就调用audio_decode_frame重新填充audio_buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span> <span class="o">&gt;=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">audio_size</span> <span class="o">=</span> <span class="nf">audio_decode_frame</span><span class="p">(</span><span class="n">is</span><span class="p">);</span><span class="c1">//填充audio_buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">audio_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* if error, just output silence */</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span> <span class="o">=</span> <span class="n">SDL_AUDIO_MIN_BUFFER_SIZE</span> <span class="o">/</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">frame_size</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">frame_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">show_mode</span> <span class="o">!=</span> <span class="n">SHOW_MODE_VIDEO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">update_sample_display</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="p">(</span><span class="kt">int16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span><span class="p">,</span> <span class="n">audio_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span> <span class="o">=</span> <span class="n">audio_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       	<span class="c1">//根据缓冲区剩余大小量力而行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">len1</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span> <span class="o">-</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">len1</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">len1</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">//根据audio_volume决定如何输出audio_buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">muted</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_volume</span> <span class="o">==</span> <span class="n">SDL_MIX_MAXVOLUME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span><span class="p">,</span> <span class="n">len1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memset</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">muted</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">SDL_MixAudioFormat</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span><span class="p">,</span> <span class="n">AUDIO_S16SYS</span><span class="p">,</span> <span class="n">len1</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_volume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       	<span class="c1">//调整各buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">len</span> <span class="o">-=</span> <span class="n">len1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span> <span class="o">+=</span> <span class="n">len1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span> <span class="o">+=</span> <span class="n">len1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_write_buf_size</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_size</span> <span class="o">-</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Let&#39;s assume the audio driver that is used by SDL has two periods. */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isnan</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span><span class="p">))</span><span class="c1">//更新audclk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">set_clock_at</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audclk</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span> <span class="o">-</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_hw_buf_size</span> <span class="o">+</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_write_buf_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">bytes_per_sec</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock_serial</span><span class="p">,</span> <span class="n">audio_callback_time</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sync_clock_to_slave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">extclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audclk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>sdl_audio_callback</code>的缓冲区输出过程:</p>
<ol>
<li>输出audio_buf到stream，如果audio_volume为最大音量，则只需memcpy复制给stream即可。否则，可以利用SDL_MixAudioFormat进行音量调整和混音</li>
<li>如果audio_buf消耗完了，就调用<code>audio_decode_frame</code>重新填充audio_buf</li>
<li>set_clock_at更新audclk时，完整的帧包含的时间戳-实际写入的帧数+2个硬件buffer的延迟，audio_clock是当前audio_buf的显示结束时间(pts+duration)，由于audio driver本身会持有一小块缓冲区，典型地，会是两块交替使用，所以有<code>2 * is-&gt;audio_hw_buf_size</code>. 因为我们的写入的时候，还需要考虑传入的buffer的大小，预期情况下，如果buffer相同，则这里就是原来的pts-硬件延迟的时间。</li>
</ol>
<h4 id="填充audio_buf"><a href="#填充audio_buf" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>填充audio_buf</h4>
<p>调用<code>audio_decode_frame</code>重新填充audio_buf，<code>audio_decode_frame</code>并没有真正意义上的<code>decode</code>代码，最多是进行了重采样。主流程有以下步骤：</p>
<ol>
<li>从sampq取一帧，必要时丢帧。如发生了seek，此时serial会不连续，就需要丢帧处理</li>
<li>计算这一帧的字节数。通过av_samples_get_buffer_size可以方便计算出结果</li>
<li>获取这一帧的数据。对于frame格式和输出设备不同的，需要重采样；如果格式相同，则直接拷贝指针输出即可。总之，需要在audio_buf中保存与输出设备格式相同的音频数据</li>
<li>更新audio_clock，audio_clock_serial。用于设置audclk.</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Decode one audio frame and return its uncompressed size.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The processed audio frame is decoded, converted if required, and
</span></span></span><span class="line"><span class="cl"><span class="cm"> * stored in is-&gt;audio_buf, with size in bytes given by the return
</span></span></span><span class="line"><span class="cl"><span class="cm"> * value.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">audio_decode_frame</span><span class="p">(</span><span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">resampled_data_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">dec_channel_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">av_unused</span> <span class="kt">double</span> <span class="n">audio_clock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">wanted_nb_samples</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Frame</span> <span class="o">*</span><span class="n">af</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span><span class="c1">//暂停状态，返回-1，sdl_audio_callback会处理为输出静音
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(_WIN32)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">while</span> <span class="p">(</span><span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">sampq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="nf">av_gettime_relative</span><span class="p">()</span> <span class="o">-</span> <span class="n">audio_callback_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000LL</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_hw_buf_size</span> <span class="o">/</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">bytes_per_sec</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">af</span> <span class="o">=</span> <span class="nf">frame_queue_peek_readable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">sampq</span><span class="p">)))</span><span class="c1">//1. 从sampq取一帧，必要时丢帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">frame_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">sampq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audioq</span><span class="p">.</span><span class="n">serial</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2. 计算这一帧的字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_size</span> <span class="o">=</span> <span class="nf">av_samples_get_buffer_size</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//[]计算dec_channel_layout，用于确认是否需要重新初始化重采样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dec_channel_layout</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channel_layout</span> <span class="o">&amp;&amp;</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="nf">av_get_channel_layout_nb_channels</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channel_layout</span><span class="p">))</span> <span class="o">?</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="nl">channel_layout</span> <span class="p">:</span> <span class="nf">av_get_default_channel_layout</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">wanted_nb_samples</span> <span class="o">=</span> <span class="nf">synchronize_audio</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">//[]判断是否需要重新初始化重采样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">fmt</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_channel_layout</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">channel_layout</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">freq</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">wanted_nb_samples</span> <span class="o">!=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">swr_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建和设置swr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span> <span class="o">=</span> <span class="nf">swr_alloc_set_opts</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">channel_layout</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">fmt</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">freq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">dec_channel_layout</span><span class="p">,</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span> <span class="o">||</span> <span class="nf">swr_init</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="s">&#34;Cannot create sample rate converter for conversion of %d Hz %s %d channels to %d Hz %s %d channels!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">,</span> <span class="nf">av_get_sample_fmt_name</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">),</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">freq</span><span class="p">,</span> <span class="nf">av_get_sample_fmt_name</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">fmt</span><span class="p">),</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">swr_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">channel_layout</span> <span class="o">=</span> <span class="n">dec_channel_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_src</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//3. 获取这一帧的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">)</span><span class="c1">//[]如果初始化了重采样，则对这一帧数据重采样输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">**</span><span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">**</span><span class="p">)</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">extended_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="o">**</span><span class="n">out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">out_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">wanted_nb_samples</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">freq</span> <span class="o">/</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">out_size</span> <span class="o">=</span> <span class="nf">av_samples_get_buffer_size</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">out_count</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">len2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">out_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;av_samples_get_buffer_size() failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">wanted_nb_samples</span> <span class="o">!=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">swr_set_compensation</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">,</span> <span class="p">(</span><span class="n">wanted_nb_samples</span> <span class="o">-</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">freq</span> <span class="o">/</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">wanted_nb_samples</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">freq</span> <span class="o">/</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;swr_set_compensation() failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_fast_malloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf1_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//进行转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">len2</span> <span class="o">=</span> <span class="nf">swr_convert</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_count</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;swr_convert() failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">==</span> <span class="n">out_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_WARNING</span><span class="p">,</span> <span class="s">&#34;audio buffer is probably too small</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">swr_init</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">swr_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">swr_ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//重新计算采样的数据大小，并返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resampled_data_size</span> <span class="o">=</span> <span class="n">len2</span> <span class="o">*</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">channels</span> <span class="o">*</span> <span class="nf">av_get_bytes_per_sample</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_tgt</span><span class="p">.</span><span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_buf</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">resampled_data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//audio_clock0用于打印调试信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">audio_clock0</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* update the audio clock with the pts */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//4. 更新audio_clock，audio_clock_serial,更新pts  这个pts 等于当前的帧包含的所有帧数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isnan</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">+</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span> <span class="o">/</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock_serial</span> <span class="o">=</span> <span class="n">af</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef DEBUG
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">static</span> <span class="kt">double</span> <span class="n">last_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;audio: delay=%0.3f clock=%0.3f clock0=%0.3f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span> <span class="o">-</span> <span class="n">last_clock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span><span class="p">,</span> <span class="n">audio_clock0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_clock</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">audio_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">return</span> <span class="n">resampled_data_size</span><span class="p">;</span><span class="c1">//返回audio_buf的数据大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="ffplay时间同步"><a href="#ffplay时间同步" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ffplay时间同步</h3>
<p>由于音频和视频的输出不在同一个线程，而且，也不一定会同时解出同一个pts的音频帧和视频帧。因此，在进行音频和视频的播放时，需要对音频和视频的播放速度、播放时刻进行控制，以实现音频和视频保持同步，即所谓的音视频同步。</p>
<p>在ffplay中，音频（audio）和视频（video）有各自的输出线程，其中音频的输出线程是sdl的音频输出回调线程，video的输出线程是程序的主线程。</p>
<p>音视频的同步策略，一般有如下几种：</p>
<ul>
<li>视频同步到音频，即音频为主时钟</li>
<li>音频同步到视频，即视频为主时钟</li>
<li>视频、音频同步到外部时钟，即外部时钟（系统时间）为主时钟</li>
<li>视频和音频各自输出，即不作同步处理，或称之为各自为主时钟</li>
</ul>
<p>由于人耳对于声音变化的敏感度比视觉高，因此，一般采样的策略是将视频同步到音频，即对画面进行适当的丢帧或重复以追赶或等待音频。</p>
<h4 id="dts和pts"><a href="#dts和pts" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>DTS和PTS</h4>
<p>在音视频流中的包都含有<strong>DTS</strong>和<strong>PTS</strong>，我们以此作为选择基准，到底是播放快了还是慢了，或者正以同步的速度播放。</p>
<ul>
<li>DTS：Decoding Time Stamp 解码时间戳——告诉解码器packet解码顺序</li>
<li>PTS：Presenting Time Stamp 显示时间戳——指示从packet中解码出来的数据的显示顺序</li>
</ul>
<h4 id="计算视频frame的显示时间"><a href="#计算视频frame的显示时间" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>计算视频Frame的显示时间</h4>
<p>要想知道ffmpeg如果计算视频一帧的显示时间，就需先了解ffmpeg的timebase；因为pts的单位就是timebase；</p>
<p>timebase的类型是结构体AVRational（用于表示分数），如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">AVRational</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span> <span class="c1">///&lt; Numerator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">den</span><span class="p">;</span> <span class="c1">///&lt; Denominator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">AVRational</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>如<code>timebase={1, 1000}</code>表示千分之一秒，那么pts=1000，即为1秒，那么这一帧就需要在第一秒的时候呈现在ffplay中，将pts转化为秒，一般做法是：<code>pts * av_q2d(timebase)</code></p>
<p>&quot;时钟&quot;的概念，ffplay定义的结构体是Clock：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Clock</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">pts</span><span class="p">;</span>       <span class="cm">/* clock base */</span><span class="c1">// 时钟基准
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">pts_drift</span><span class="p">;</span> <span class="cm">/* clock base minus time at which we updated the clock */</span><span class="c1">// 更新时钟的差值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">last_updated</span><span class="p">;</span><span class="c1">// 上一次更新的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">speed</span><span class="p">;</span><span class="c1">// 速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>  <span class="c1">// 时钟基于使用该序列的包 /* clock is based on a packet with this serial */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">paused</span><span class="p">;</span><span class="c1">// 停止标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="o">*</span><span class="n">queue_serial</span><span class="p">;</span> <span class="c1">// 指向当前数据包队列序列的指针，用于过时的时钟检测 /* pointer to the current packet queue serial, used for obsolete clock detection */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">Clock</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>时钟的工作原理：</p>
<ol>
<li>通过<code>set_clock_at</code>不断对时；</li>
<li>获取的时间是一个估算值。估算是通过对时时记录的pts_drift估算的</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 更新视频的pts
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param is     [description]
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param pts    [description]
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param pos    [description]
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param serial [description]
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">static</span> <span class="k">void</span> <span class="nx">update_video_pts</span><span class="p">(</span><span class="nx">VideoState</span> <span class="o">*</span><span class="nx">is</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">pts</span><span class="p">,</span> <span class="nx">int64_t</span> <span class="nx">pos</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">serial</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* update current video pts */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">set_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">is</span><span class="o">-&gt;</span><span class="nx">vidclk</span><span class="p">,</span> <span class="nx">pts</span><span class="p">,</span> <span class="nx">serial</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//将尾部的时间钟，用视频的时机钟来进行同步
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sync_clock_to_slave</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">is</span><span class="o">-&gt;</span><span class="nx">extclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">is</span><span class="o">-&gt;</span><span class="nx">vidclk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">static</span> <span class="k">void</span> <span class="nx">set_clock</span><span class="p">(</span><span class="nx">Clock</span> <span class="o">*</span><span class="nx">c</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">pts</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">double</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">av_gettime_relative</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">set_clock_at</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">pts</span><span class="p">,</span> <span class="nx">serial</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//使用当前的事来计算这几个值。也就是这一帧送显之前的操作的时间。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">static</span> <span class="k">void</span> <span class="nx">set_clock_at</span><span class="p">(</span><span class="nx">Clock</span> <span class="o">*</span><span class="nx">c</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">pts</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">serial</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="o">-&gt;</span><span class="nx">pts</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="o">-&gt;</span><span class="nx">last_updated</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="o">-&gt;</span><span class="nx">pts_drift</span> <span class="o">=</span> <span class="nx">c</span><span class="o">-&gt;</span><span class="nx">pts</span> <span class="o">-</span> <span class="nx">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="o">-&gt;</span><span class="nx">serial</span> <span class="o">=</span> <span class="nx">serial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>以一个时间轴，从左往右看。首先我们调用<code>set_clock_at</code>进行一次对时，假设这时的<code>pts</code>是落后系统时间<code>time</code>的，那么计算<code>pts_drift = pts - time</code>。</p>
<p>接着，过了一会儿，且在下次对时前，通过<code>get_clock</code>来查询时间，因为这时的<code>pts</code>已经过时，不能直接拿pts当做这个时钟的时间。不过我们前面计算过<code>pts_drift</code>，也就是<code>pts</code>和<code>time</code>的差值，所以我们可以通过当前时刻的系统时间来估算这个时刻的pts：<code>pts = time + pts_drift</code>.</p>
<p>当然，由于pts_drift是一直在变动的(drift与漂移、抖动的意思)，所以get_clock是估算值，真实的pts可能落在比如图示虚线圆的位置。</p>
<img src="./img/ffplay_clock.png" style="zoom:50%;" />
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">double</span> <span class="nf">get_clock</span><span class="p">(</span><span class="n">Clock</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">queue_serial</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">NAN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//pts_drift 是更新的时间钟的差值？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//最后的时间是 更新的差值+ 当前的时间-当前的时间和上一次更新的时间之间的差值*速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//默认的情况下，根据上一次的drift计算下一次要出现的时间。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="n">time</span> <span class="o">=</span> <span class="nf">av_gettime_relative</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pts_drift</span> <span class="o">+</span> <span class="n">time</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">last_updated</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="以音频为主时钟同步"><a href="#以音频为主时钟同步" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>以音频为主时钟同步</h4>
<p>接下来主要讲以音频为主时钟的部分，大致流程如下：</p>
<img src="img/ffplay_video_clock.png" style="zoom:60%;" />
<p>在这个流程中，“计算上一帧显示时长”这一步骤至关重要。代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* called to display each frame */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">video_refresh</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">remaining_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">video_st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span> <span class="c1">//判断队列是否有数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="c1">// nothing to do, no picture to display in the queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="kt">double</span> <span class="n">last_duration</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">Frame</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="o">*</span><span class="n">lastvp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="c1">//lastvp上一帧，vp当前帧 ，nextvp下一帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">              <span class="cm">/* dequeue the picture */</span> <span class="c1">//出队
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="n">lastvp</span> <span class="o">=</span> <span class="nf">frame_queue_peek_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">vp</span> <span class="o">=</span> <span class="nf">frame_queue_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">              1、刚开始的时候（第一帧）lastvp == vp ，因为还没有调用frame_queue_next f-&gt;rindex_shown还未为1
</span></span></span><span class="line"><span class="cl"><span class="cm">              2、调用frame_queue_next，将f-&gt;rindex_shown置1，还没有增加f-&gt;rindex
</span></span></span><span class="line"><span class="cl"><span class="cm">              3、第二帧开始lastvp上一帧，vp 将要显示的一帧
</span></span></span><span class="line"><span class="cl"><span class="cm">              */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="cm">/*如果将要显示的一帧的序列与现在解码的不同就直接抛弃*/</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">videoq</span><span class="p">.</span><span class="n">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                  <span class="nf">frame_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span><span class="c1">//移动读索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span><span class="c1">//重新获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="c1">//如果上一帧序号不等于将要显示的一帧序号，表示将要显示的一帧是新的播放序列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">              新的播放序列重置当前时间，这样就会走到正常显示将要显示的一帧（新序的第一帧）
</span></span></span><span class="line"><span class="cl"><span class="cm">              */</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">lastvp</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">=</span> <span class="nf">av_gettime_relative</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">;</span> <span class="c1">//获取当前时间，用于帧间对比
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span> <span class="c1">//暂停后重新开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">goto</span> <span class="n">display</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="cm">/* compute nominal last_duration */</span>
</span></span><span class="line"><span class="cl">              <span class="n">last_duration</span> <span class="o">=</span> <span class="nf">vp_duration</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">lastvp</span><span class="p">,</span> <span class="n">vp</span><span class="p">);</span><span class="c1">//计算上一帧的持续时长
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="n">delay</span> <span class="o">=</span> <span class="nf">compute_target_delay</span><span class="p">(</span><span class="n">last_duration</span><span class="p">,</span> <span class="n">is</span><span class="p">);</span> <span class="c1">//音视频同步信息，参考audio clock计算上一帧真正的持续时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">              <span class="n">time</span> <span class="o">=</span> <span class="nf">av_gettime_relative</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">;</span><span class="c1">//取系统时刻
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="cm">/*delay ： 是上一帧要持续显示的时长，也就是将要显示的一帧的开始显示时间
</span></span></span><span class="line"><span class="cl"><span class="cm">              is-&gt;frame_timer ： 上一帧显示的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">              is-&gt;frame_timer + delay ： 将要显示这一帧的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">              如果time 还没达到显示这一帧的时间，就计算等待时间用于上一层等待，继续显示上一帧
</span></span></span><span class="line"><span class="cl"><span class="cm">              如果seek后，delay = 0 ，time 就会大于is-&gt;frame_timer + delay，就往下走显示
</span></span></span><span class="line"><span class="cl"><span class="cm">              */</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">+</span> <span class="n">delay</span><span class="p">)</span><span class="c1">//如果上一帧显示时长未满，重复显示上一帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="p">{</span> <span class="c1">//进入视频显示，计算一个等待时间返回上一层，现在视频快了，让视频继续显示上一帧等待
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">*</span><span class="n">remaining_time</span> <span class="o">=</span> <span class="nf">FFMIN</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">-</span> <span class="n">time</span><span class="p">,</span> <span class="o">*</span><span class="n">remaining_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">goto</span> <span class="n">display</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="cm">/*第一帧数据时is-&gt;frame_timer = 0，会执行到time - is-&gt;frame_timer &gt; AV_SYNC_THRESHOLD_MAX
</span></span></span><span class="line"><span class="cl"><span class="cm">              如果与系统时间的偏离太大，则修正为系统时间*/</span>
</span></span><span class="line"><span class="cl">              <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">+=</span> <span class="n">delay</span><span class="p">;</span><span class="c1">//frame_timer更新为上一帧结束时刻，也是当前帧开始时刻
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time</span> <span class="o">-</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">&gt;</span> <span class="n">AV_SYNC_THRESHOLD_MAX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span><span class="c1">//如果与系统时间的偏离太大，则修正为系统时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">              <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="cm">/*更新视频时钟
</span></span></span><span class="line"><span class="cl"><span class="cm">              注意：这个更新视频时钟在丢帧之前，那么如果这帧pts设置视频时钟后
</span></span></span><span class="line"><span class="cl"><span class="cm">              下面又将这帧丢弃，视频时钟就是被丢弃的这一帧*/</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isnan</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">update_video_pts</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span> <span class="c1">//更新视频时钟检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="cm">/*drop帧处理
</span></span></span><span class="line"><span class="cl"><span class="cm">              队列要有将要显示这一帧的下一帧
</span></span></span><span class="line"><span class="cl"><span class="cm">              第一帧，队列内有2帧
</span></span></span><span class="line"><span class="cl"><span class="cm">              后面就是，队列内有3帧，因为保留了上一帧（显示帧）*/</span>
</span></span><span class="line"><span class="cl">              <span class="c1">//丢帧逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span><span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Frame</span> <span class="o">*</span><span class="n">nextvp</span> <span class="o">=</span> <span class="nf">frame_queue_peek_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span><span class="c1">//获取将要显示帧的下一帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="n">duration</span> <span class="o">=</span> <span class="nf">vp_duration</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">nextvp</span><span class="p">);</span><span class="c1">//当前帧显示时长
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="c1">//如果系统时间已经大于当前帧，则丢弃当前帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">step</span> <span class="c1">//非逐帧模式播放情况下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">framedrop</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1">//允许drop帧处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">||</span> <span class="p">(</span><span class="n">framedrop</span> <span class="o">&amp;&amp;</span> <span class="nf">get_master_sync_type</span><span class="p">(</span><span class="n">is</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AV_SYNC_VIDEO_MASTER</span><span class="p">))</span> <span class="c1">//主时钟不是视频
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">&amp;&amp;</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_timer</span> <span class="o">+</span> <span class="n">duration</span><span class="p">)</span><span class="c1">//当前时间已经到了nextvp的播放时间，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="c1">//此时is-&gt;frame_timer就是将要显示这一帧vp的播放时间了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="n">is</span><span class="o">-&gt;</span><span class="n">frame_drops_late</span><span class="o">++</span><span class="p">;</span><span class="c1">//丢帧统计
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="nf">frame_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span><span class="c1">//丢弃将要显示这一帧，移动读索引读到下一帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span><span class="c1">//回到函数开始位置，继续重试(这里不能直接while丢帧，因为很可能audio clock重新对时了，这样delay值需要重新计算)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="cm">/*上一帧与将要显示这一帧之间的duration用来计算将要显示这一帧的播放时间
</span></span></span><span class="line"><span class="cl"><span class="cm">              将要显示这一帧与上一帧之间的duration用来计算是否丢弃将要显示这一帧*/</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">              <span class="nf">frame_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">              <span class="n">is</span><span class="o">-&gt;</span><span class="n">force_refresh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//刷新画面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">stream_toggle_pause</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nl">display</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/* display picture */</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_disable</span> 
</span></span><span class="line"><span class="cl">              <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">force_refresh</span> 
</span></span><span class="line"><span class="cl">              <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">show_mode</span> <span class="o">==</span> <span class="n">SHOW_MODE_VIDEO</span> 
</span></span><span class="line"><span class="cl">              <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">pictq</span><span class="p">.</span><span class="n">rindex_shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="nf">video_display</span><span class="p">(</span><span class="n">is</span><span class="p">);</span><span class="c1">//显示视频
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>如果视频播放过快，则重复播放上一帧，以等待音频；如果视频播放过慢，则丢帧追赶音频。实现的方式是，参考audio clock，计算上一帧（在屏幕上的那个画面）还应显示多久（含帧本身时长），然后与系统时刻对比，是否该显示下一帧了。</p>
<h5 id="frame_timer"><a href="#frame_timer" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>frame_timer</code></h5>
<p><code>frame_timer</code>:可以理解为帧显示时刻，如更新前，是上一帧的显示时刻；对于更新后（<code>is-&gt;frame_timer += delay</code>），则为当前帧显示时刻。</p>
<p>上一帧显示时刻加上delay（还应显示多久（含帧本身时长））即为上一帧应结束显示的时刻。具体原理看如下示意图：</p>
<img src="img/ffplay_delay.png" style="zoom:50%;" />
<p>这里给出了3种情况的示意图：</p>
<ul>
<li>time1：系统时刻小于lastvp结束显示的时刻（frame_timer+dealy），即虚线圆圈位置。此时应该继续显示lastvp</li>
<li>time2：系统时刻大于lastvp的结束显示时刻，但小于vp的结束显示时刻（vp的显示时间开始于虚线圆圈，结束于黑色圆圈）。此时既不重复显示lastvp，也不丢弃vp，即应显示vp</li>
<li>time3：系统时刻大于vp结束显示时刻（黑色圆圈位置，也是nextvp预计的开始显示时刻）。此时应该丢弃vp。</li>
</ul>
<h5 id="dealy计算"><a href="#dealy计算" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dealy计算</h5>
<p>lastvp的显示时长delay是如何计算的，主要在<code>compute_target_delay</code>中实现，代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">double</span> <span class="nf">compute_target_delay</span><span class="p">(</span><span class="kt">double</span> <span class="n">delay</span><span class="p">,</span> <span class="n">VideoState</span> <span class="o">*</span><span class="n">is</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">sync_threshold</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* update delay to follow master synchronisation source */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//只有同步时钟不是视频时钟时才计算，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">get_master_sync_type</span><span class="p">(</span><span class="n">is</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AV_SYNC_VIDEO_MASTER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">// 判断同步类型，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* if video is slave, we try to correct big delays by
</span></span></span><span class="line"><span class="cl"><span class="cm">           duplicating or deleting a frame */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        get_clock(&amp;is-&gt;vidclk) ：返回经过从上次设置时钟到现在数据时间到了什么时间位置
</span></span></span><span class="line"><span class="cl"><span class="cm">        get_master_clock(is) ： 返回主时钟到了什么时间位置（音频时钟或者外部时钟）
</span></span></span><span class="line"><span class="cl"><span class="cm">        diff ： 就是当前视频播放的位置与主时钟之前的差值
</span></span></span><span class="line"><span class="cl"><span class="cm">        &lt;0 ： 视频慢了
</span></span></span><span class="line"><span class="cl"><span class="cm">        &gt;0 ：视频快了
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="n">diff</span> <span class="o">=</span> <span class="nf">get_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">vidclk</span><span class="p">)</span> <span class="o">-</span> <span class="nf">get_master_clock</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* skip or repeat frame. We take into account the
</span></span></span><span class="line"><span class="cl"><span class="cm">           delay to compute the threshold. I still don&#39;t know
</span></span></span><span class="line"><span class="cl"><span class="cm">           if it is the best guess */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*AV_SYNC_THRESHOLD_MIN 同步阀值最小范围：0.04 （秒） 1/25帧的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">        AV_SYNC_THRESHOLD_MAX 同步阀值最大范围：0.1 （秒） 1/10帧的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">        delay ： 理论上的两帧之间的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">        返回一个同步阀值在同步阀值范围内，使用delay设置
</span></span></span><span class="line"><span class="cl"><span class="cm">        因为delay上层传来是两帧之间的时间，那只要在阀值范围内，这个时间就是sync_threshold*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">sync_threshold</span> <span class="o">=</span> <span class="nf">FFMAX</span><span class="p">(</span><span class="n">AV_SYNC_THRESHOLD_MIN</span><span class="p">,</span> <span class="nf">FFMIN</span><span class="p">(</span><span class="n">AV_SYNC_THRESHOLD_MAX</span><span class="p">,</span> <span class="n">delay</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isnan</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">fabs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">max_frame_duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//根据阀值判断是快了还是慢了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">sync_threshold</span><span class="p">)</span><span class="c1">//差值已经超出阀值最小，视频慢了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">delay</span> <span class="o">=</span> <span class="nf">FFMAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">delay</span> <span class="o">+</span> <span class="n">diff</span><span class="p">);</span><span class="cm">/*上一帧需要加快，delay + -diff，这样算出来的delay基本都是0，上一帧还要显示delay时间*/</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="n">sync_threshold</span> <span class="o">&amp;&amp;</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">AV_SYNC_FRAMEDUP_THRESHOLD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span><span class="cm">/*视频快了，上一帧就要减慢，delay+diff，AV_SYNC_FRAMEDUP_THRESHOLD 0.1秒，如果帧持续时间超过这个值，它将不会被成倍来补偿进行同步*/</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="n">sync_threshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delay</span><span class="p">;</span><span class="cm">/*视频快了，delay 相当上一帧显示两次，因为diff == sync_threshold也是快了一帧*/</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_TRACE</span><span class="p">,</span> <span class="s">&#34;video: delay=%0.3f A-V=%f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">delay</span><span class="p">,</span> <span class="o">-</span><span class="n">diff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">delay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h5 id="sync_threshold理解"><a href="#sync_threshold理解" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>sync_threshold</code>理解：</h5>
<img src="img/ffplay_sync_threshold.png" style="zoom:50%;" />
<p>从图上可以看出来sync_threshold是建立一块区域，在这块区域内无需调整lastvp的显示时长，直接返回delay即可。也就是在这块区域内认为是准同步的。</p>
<p>如果小于-sync_threshold，那就是视频播放较慢，需要适当丢帧。具体是返回一个最大为0的值。根据前面frame_timer的图，至少应更新画面为vp。</p>
<p>如果大于sync_threshold，那么视频播放太快，需要适当重复显示lastvp。具体是返回2倍的delay，也就是2倍的lastvp显示时长，也就是让lastvp再显示一帧。</p>
<h5 id="总结"><a href="#总结" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>总结</h5>
<ul>
<li>基本策略是：如果视频播放过快，则重复播放上一帧，以等待音频；如果视频播放过慢，则丢帧追赶音频。</li>
<li>这一策略的实现方式是：引入frame_timer概念，标记帧的显示时刻和应结束显示的时刻，再与系统时刻对比，决定重复还是丢帧。</li>
<li>lastvp的应结束显示的时刻，除了考虑这一帧本身的显示时长，还应考虑了video clock与audio clock的差值。</li>
<li>并不是每时每刻都在同步，而是有一个“准同步”的差值区域。</li>
</ul>
<h3 id="framequeue的分析"><a href="#framequeue的分析" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>FrameQueue</code>的分析</h3>
<p>ffplay 是通过<code>FrameQueue</code>来保存解码后的数据；</p>
<h4 id="frame结构体"><a href="#frame结构体" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>Frame</code>结构体</h4>
<p><code>Frame</code>是用来存储解码后的一帧数据，其中包括视频、音频和字幕；</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Frame</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span><span class="c1">//音视频解码数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVSubtitle</span> <span class="n">sub</span><span class="p">;</span><span class="c1">//字幕解码数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">pts</span><span class="p">;</span>      <span class="cm">/* presentation timestamp for the frame */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">duration</span><span class="p">;</span> <span class="cm">/* estimated duration of the frame */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">pos</span><span class="p">;</span>     <span class="cm">/* byte position of the frame in the input file */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">format</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVRational</span> <span class="n">sar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">uploaded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">flip_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Frame</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="framequeue结构体"><a href="#framequeue结构体" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>FrameQueue</code>结构体</h4>
<p><code>FrameQueue</code>是用来表示整个帧队列；</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FrameQueue</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Frame</span> <span class="n">queue</span><span class="p">[</span><span class="n">FRAME_QUEUE_SIZE</span><span class="p">];</span><span class="c1">//队列元素，用数组模拟队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rindex</span><span class="p">;</span><span class="c1">//读指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">windex</span><span class="p">;</span><span class="c1">//写指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span><span class="c1">//当前存储的节点个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">max_size</span><span class="p">;</span><span class="c1">//最大允许存储的节点个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">keep_last</span><span class="p">;</span><span class="c1">//是否要保留最后一个读节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rindex_shown</span><span class="p">;</span><span class="c1">//当前节点是否已经显示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SDL_mutex</span> <span class="o">*</span><span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SDL_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PacketQueue</span> <span class="o">*</span><span class="n">pktq</span><span class="p">;</span><span class="c1">//关联的PacketQueue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">FrameQueue</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>FrameQueue</code>的设计思想是通过数组实现队列（环形缓冲区）；</p>
<p>设计理念：</p>
<ul>
<li>高效率的读写模型</li>
<li>高效的内存模型</li>
<li>环形缓冲区设计，同时可以访问上一读节点</li>
</ul>
<h4 id="framequeue实现函数分析"><a href="#framequeue实现函数分析" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><code>FrameQueue</code>实现函数分析</h4>
<h5 id="初始化函数"><a href="#初始化函数" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>初始化函数</h5>
<p><code>FrameQueue</code>的初始化函数是<code>frame_queue_init</code>;</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_queue_init</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">PacketQueue</span> <span class="o">*</span><span class="n">pktq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keep_last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FrameQueue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span> <span class="o">=</span> <span class="nf">SDL_CreateMutex</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;SDL_CreateMutex(): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span> <span class="o">=</span> <span class="nf">SDL_CreateCond</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_FATAL</span><span class="p">,</span> <span class="s">&#34;SDL_CreateCond(): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">SDL_GetError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span> <span class="o">=</span> <span class="n">pktq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="nf">FFMIN</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">FRAME_QUEUE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">keep_last</span> <span class="o">=</span> <span class="o">!!</span><span class="n">keep_last</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>其中主要是内存初始化和锁初始化，关键参数是<code>max_size</code>和<code>keep_last</code>;<code>max_size</code>是最大允许存储的节点个数,最大不能超过</p>
<p><code>FRAME_QUEUE_SIZE</code>，<code>FRAME_QUEUE_SIZE</code>定义如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define VIDEO_PICTURE_QUEUE_SIZE 3 </span><span class="c1">//视频显示缓存最大帧数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SUBPICTURE_QUEUE_SIZE 16   </span><span class="c1">//字幕缓存最大帧数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SAMPLE_QUEUE_SIZE 9        </span><span class="c1">//默认最大帧数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define FRAME_QUEUE_SIZE FFMAX(SAMPLE_QUEUE_SIZE, FFMAX(VIDEO_PICTURE_QUEUE_SIZE, SUBPICTURE_QUEUE_SIZE))
</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>如此看来最大不能超过16；</p>
<p><code>keep_last</code>是一个bool值，表示是否在环形缓冲区的读写过程中保留最后一个读节点不被覆写。<code>f-&gt;keep_last = !!keep_last;</code>里的双感叹号是C中的一种技巧，旨在让int参数规整为0/1的“bool值”。</p>
<p>数组queue中的每个元素的frame(AVFrame*)的字段调用<code>av_frame_alloc</code>分配内存。</p>
<h5 id="反初始化函数"><a href="#反初始化函数" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>反初始化函数</h5>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">frame_queue_destory</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Frame</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nf">frame_queue_unref_item</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_DestroyMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_DestroyCond</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>queue元素的释放分两步；</p>
<ol>
<li><code>frame_queue_unref_item</code>,释放的内存都是<strong>关联</strong>的内存，而非结构体自身内存;</li>
<li><code>av_frame_free</code>,<code>av_frame_free</code>与初始化中的<code>av_frame_alloc</code>对应，用于释放AVFrame.</li>
</ol>
<p><code>frame_queue_unref_item</code>定义如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">frame_queue_unref_item</span><span class="p">(</span><span class="n">Frame</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_frame_unref</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">);</span><span class="c1">//frame计数减1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">avsubtitle_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">sub</span><span class="p">);</span><span class="c1">//sub关联的内存释放
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>AVFrame内部有许多的AVBufferRef类型字段，而AVBufferRef只是AVBuffer的引用，AVBuffer通过引用计数自动管理内存（简易垃圾回收机制）。因此AVFrame在不需要的时候，需要通过<code>av_frame_unref</code>减少引用计数。(这个还在学习阶段)</p>
<h5 id="framequeue的写操作"><a href="#framequeue的写操作" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>FrameQueue的‘写’操作</h5>
<p>FrameQueue的‘写’操作分为两个步骤；</p>
<ol>
<li><code>frame_queue_peek_writable</code>获取一个可写节点；</li>
<li><code>frame_queue_push</code>告知FrameQueue“存入”该节点。</li>
</ol>
<p>FrameQueue始终是一个线程写，另一个线程读。读写没有其他线程产生竞争，唯一需要的是读与写线程间的同步。FrameQueue的整个优化和设计思路正是基于这一点的。这个设计思想类似于Linux内核中的kfifo。</p>
<p><code>frame_queue_peek_writable</code>定义如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Frame</span> <span class="o">*</span><span class="nf">frame_queue_peek_writable</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* wait until we have space to put a new frame */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SDL_CondWait</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">windex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>函数分3步：</p>
<ol>
<li>加锁情况下，等待直到队列有空余空间可写（<code>f-&gt;size &lt; f-&gt;max_size</code>）</li>
<li>如果有退出请求（<code>f-&gt;pktq-&gt;abort_request</code>），则返回NULL</li>
<li>返回<code>windex</code>位置的元素（<code>windex</code>指向当前应写位置）</li>
</ol>
<p>因为queue数组被当做一个环形缓冲区使用，那么的确存在underrun和overrun的情况，即读过快，或写过快的情况，这时如果不加控制，就会呈现缓冲区覆盖。</p>
<p>FrameQueue的精明之处在于，先通过size判断当前缓冲区内空间是否够写，或者够读，比如这里先通过一个循环的条件等待，判断<code>f-&gt;size &gt;= f-&gt;max_size</code>，如果<code>f-&gt;size &gt;= f-&gt;max_size</code>，那么说明队列中的节点已经写满，也就是已经overrun了，此时如果再写，肯定会覆写未读数据，那么就需要继续等待。当无需等待时，windex指向的内存一定是已经读过的（除非代码异常了）。</p>
<p>调用<code>frame_queue_peek_writable</code>取到Frame指针后，就可以对Frame内的字段自由改写，因为只有一个写进程，且无需担心读进程覆写（如上分析，读进程要读一个节点时，也会先判断underrun的情况）。</p>
<p>实现步骤：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Frame</span><span class="o">*</span> <span class="n">vp</span> <span class="o">=</span> <span class="nf">frame_queue_peek_writable</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//将要存储的数据写入frame字段，比如：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">av_frame_move_ref</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="n">src_frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//存入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">frame_queue_push</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>frame_queue_push</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">frame_queue_push</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">windex</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">-&gt;</span><span class="n">windex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_CondSignal</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>执行两个步骤：</p>
<ol>
<li>windex加1，如果超过max_size，则回环为0</li>
<li>加锁情况下大小加1.</li>
</ol>
<p>frame_queue的写过程总结示意图如下：</p>
<img src="img/ffplay_framequeue.png" style="zoom:50%;" />
<h5 id="framequeue的读操作"><a href="#framequeue的读操作" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>FrameQueue的'读'操作</h5>
<p>FrameQueue的‘读’操作分为两个步骤；</p>
<ol>
<li><code>frame_queue_peek_readable</code>获取一个可读节点</li>
<li><code>frame_queue_next</code>告知FrameQueue“取出”该节点。</li>
</ol>
<p><code>frame_queue_peek_readable</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Frame</span> <span class="o">*</span><span class="nf">frame_queue_peek_readable</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* wait until we have a readable a new frame */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//加锁情况下，判断是否有可读节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SDL_CondWait</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果有退出请求，则返回NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span><span class="o">-&gt;</span><span class="n">abort_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//读取当前可读节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>frame_queue_next</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">frame_queue_next</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果支持keep_last，且rindex_shown为0，则rindex_shown赋1，返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">keep_last</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//否则，移动rindex指针，并减小size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">frame_queue_unref_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_LockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_CondSignal</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDL_UnlockMutex</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>frame_queue_next</code>用于在读完一个节点后调用，用于标记一个节点已经被读过。</p>
<p>读过程可以描述为：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Frame</span><span class="o">*</span> <span class="n">vp</span> <span class="o">=</span> <span class="nf">frame_queue_peek_readable</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//读取vp的数据，比如
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;pict_type=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pict_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">frame_queue_next</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>标记一个节点为已读，执行两个步骤：</p>
<ol>
<li>rindex加1，如果超过max_size，则回环为0</li>
<li>加锁情况下大小减1.</li>
</ol>
<p><em><strong>对于以及读过的节点，需要调用<code>frame_queue_unref_item</code>释放关联内存。</strong></em></p>
<p>执行rindex操作前，需要先判断<code>rindex_shown</code>的值，如果为0，则赋1。如下图：</p>
<img src="img/ffplay_framequeue_read.png" style="zoom:50%;" />
<p>这里模拟了从初始化开始的2次“读”。</p>
<p>还没开始读，rindex和rindex_shown均为0。这时要peek的读节点是节点0(图中黑色块）。</p>
<p>第一次读，调用next，满足条件<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>，所以rindex仍然是0，而rindex_shown为1.此时节点0（灰色块）是已读节点，也是要keep的last节点，将要读的节点是节点1（黑色块）。（恰好是rindex+rindex_shown）</p>
<p>第二次读，peek了黑色块后，调用next，不满足条件<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>，所以rindex为1，而rindex_shown为2.此时节点1（灰色块）是last节点，节点2（黑色块）是将要读的节点。（也恰好是rindex+rindex_shown）</p>
<p>继续往后分析，会一直重复第二次读的情况，始终是rindex指向了last，而rindex_shown一直为1，rindex+rindex_shown刚好是将要读的节点。</p>
<p>FrameQueue的读过程也分析完了。</p>
<h5 id="辅助函数"><a href="#辅助函数" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>辅助函数</h5>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//（上文中的用词是“将要读的节点”，也就是黑色块），与frame_queue_peek_readable等效，但没有检查是否有可读节点
</span></span></span><span class="line"><span class="cl"><span class="c1">//读当前节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">Frame</span> <span class="o">*</span><span class="nf">frame_queue_peek</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//读下一个节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">Frame</span> <span class="o">*</span><span class="nf">frame_queue_peek_next</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">max_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//读上一个节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">Frame</span> <span class="o">*</span><span class="nf">frame_queue_peek_last</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* return the number of undisplayed frames in the queue */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_queue_nb_remaining</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* return last shown position */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int64_t</span> <span class="nf">frame_queue_last_pos</span><span class="p">(</span><span class="n">FrameQueue</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rindex_shown</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">pktq</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>看下节点位置：</p>
<img src="img/ffplay_framequeue_index.png" style="zoom:50%;" />
<h2 id="参考链接"><a href="#参考链接" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>参考链接：</h2>
<p><a href="https://www.zhihu.com/column/avtec" target="_blank" rel="noopener">https://www.zhihu.com/column/avtec</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1373966" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1373966</a></p>

            </div>

            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">作者</span>：<a href="https://io-oi.me/" class="p-author h-card" target="_blank" rel="noopener">reuixiy</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">链接</span>：<a href="/learn/av-learn/ffplay_learn/" target="_blank" rel="noopener">https://example.com/learn/av-learn/ffplay_learn/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">许可</span>：<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></li>
            
        </ul>
    



        </article>

        

        
    <div class="updated-badge-container">
        <span title="Updated @ 2023-11-28 21:40:44 CST" style="cursor:help">

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2023-11-28</text><text x="915" y="140" textLength="650" transform="scale(.1)">2023-11-28</text></g></svg>
        </span></div>



        


        <div class="post-share">

        

        <div class="share-items">

            
            
                
                    <div class="share-item facebook">
                        
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://example.com/learn/av-learn/ffplay_learn/&amp;hashtag=%23" title="分享到「Facebook」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item mastodon">
                            <a href="/fedishare.html#title=&amp;description=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6&amp;url=https://example.com/learn/av-learn/ffplay_learn/" title="分享到「Mastodon」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon mastodon-icon"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a>
                        </div>
                    
            
                
                    <div class="share-item fediverse">
                            <a href="/fedishare.html#title=&amp;description=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6&amp;url=https://example.com/learn/av-learn/ffplay_learn/" title="分享到「Fediverse」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="64 163 873 873" class="icon fediverse-icon"><defs><linearGradient id="fediverse-gradient"><stop offset="0%" stop-color="#ff0101"/><stop offset="10%" stop-color="#9501ff"/><stop offset="50%" stop-color="#ffca01"/><stop offset="75%" stop-color="#01a3ff"/><stop offset="100%" stop-color="#65ff01"/></linearGradient></defs><path d="M539 176q-32 0 -55 22t-25 55t20.5 58t56 27t58.5 -20.5t27 -56t-20.5 -59t-56.5 -26.5h-5zM452 271l-232 118q20 20 25 48l231 -118q-19 -20 -24 -48zM619 298q-13 25 -38 38l183 184q13 -25 39 -38zM477 320l-135 265l40 40l143 -280q-28 -5 -48 -25zM581 336 q-22 11 -46 10l-8 -1l21 132l56 9zM155 370q-32 0 -55 22.5t-25 55t20.5 58t56.5 27t59 -21t26.5 -56t-21 -58.5t-55.5 -27h-6zM245 438q1 9 1 18q-1 19 -10 35l132 21l26 -50zM470 474l-26 51l311 49q-1 -8 -1 -17q1 -19 10 -36zM842 480q-32 1 -55 23t-24.5 55t21 58 t56 27t58.5 -20.5t27 -56.5t-20.5 -59t-56.5 -27h-6zM236 493q-13 25 -39 38l210 210l51 -25zM196 531q-21 11 -44 10l-9 -1l40 256q21 -10 45 -9l8 1zM560 553l48 311q21 -10 44 -9l10 1l-46 -294zM755 576l-118 60l8 56l135 -68q-20 -20 -25 -48zM781 625l-119 231 q28 5 48 25l119 -231q-28 -5 -48 -25zM306 654l-68 134q28 5 48 25l60 -119zM568 671l-281 143q19 20 24 48l265 -135zM513 771l-51 25l106 107q13 -25 39 -38zM222 795q-32 0 -55.5 22.5t-25 55t21 57.5t56 27t58.5 -20.5t27 -56t-20.5 -58.5t-56.5 -27h-5zM311 863 q2 9 1 18q-1 19 -9 35l256 41q-1 -9 -1 -18q1 -18 10 -35zM646 863q-32 0 -55 22.5t-24.5 55t20.5 58t56 27t59 -21t27 -56t-20.5 -58.5t-56.5 -27h-6z"/></svg></a>
                        </div>
                    
            
                
                    <div class="share-item twitter">
                        
                        <a href="https://twitter.com/share?url=https://example.com/learn/av-learn/ffplay_learn/&amp;text=&amp;hashtags=&amp;via=reuixiy" title="分享到「Twitter」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item linkedin">
                        
                        <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://example.com/learn/av-learn/ffplay_learn/&amp;title=&amp;summary=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6&amp;source=Hugo%20%e4%b8%bb%e9%a2%98%20MemE" title="分享到「LinkedIn」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item telegram">
                        
                        <a href="https://t.me/share/url?url=https://example.com/learn/av-learn/ffplay_learn/&amp;text=" title="分享到「Telegram」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item weibo">
                        
                        <a href="https://service.weibo.com/share/share.php?&amp;url=https://example.com/learn/av-learn/ffplay_learn/&amp;title=&amp;pic=https://example.com/img/ffplay.png&amp;searchPic=false" title="分享到「新浪微博」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item douban">
                        
                        <a href="https://www.douban.com/share/service?href=https://example.com/learn/av-learn/ffplay_learn/&amp;name=&amp;text=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6" title="分享到「豆瓣」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412l-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952 0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03Z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item qq">
                        
                        <a href="https://connect.qq.com/widget/shareqq/index.html?url=https://example.com/learn/av-learn/ffplay_learn/&amp;title=&amp;summary=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6&amp;pics=https://example.com/img/ffplay.png&amp;site=Hugo%20%e4%b8%bb%e9%a2%98%20MemE" title="分享到「QQ」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item qzone">
                        
                        <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://example.com/learn/av-learn/ffplay_learn/&amp;title=&amp;summary=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6&amp;pics=https://example.com/img/ffplay.png&amp;site=Hugo%20%e4%b8%bb%e9%a2%98%20MemE" title="分享到「QQ 空间」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532c-.104 0-.251.051-.349.238-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477 0 0 0 .125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061c.103-.017.201.061.201.061s6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463 0 0 0 .159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5 0 0 1 2.861-2.155c1.285-.968 3.559-2.47 3.559-2.731 0-.285-2.144-.781-4.037-.781-1.945 0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276 0 .342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688 0 .342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477 0 0 0 .127-.449z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item pocket">
                        
                        <a href="https://getpocket.com/edit.php?url=https://example.com/learn/av-learn/ffplay_learn/" title="分享到「Pocket」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon pocket-icon"><path d="M407.6 64h-367C18.5 64 0 82.5 0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4 0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9 0 30.7 13.8 30.7 30.7 0 17.8-2.9 15.7-114.8 123.2z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item hackernews">
                        
                        <a href="https://news.ycombinator.com/submitlink?u=https://example.com/learn/av-learn/ffplay_learn/&amp;t=" title="分享到Hacker News" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon hackernews-icon"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4 0 .1 0 .3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></a>
                    </div>
                
            
                
                    <div class="share-item qrcode">
                        <div class="qrcode-container" title="通过「二维码」"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                        </div>
                        <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    const typeNumber = 0;
    const errorCorrectionLevel = 'L';
    const qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/example.com\/learn\/av-learn\/ffplay_learn\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                    </div>
                
            
                
                    <div class="share-item email">
                        
                        <a href="mailto:?subject=&amp;body=[TOC]%20ffplay%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%20%e7%86%9f%e6%82%89FFmpeg%e9%a1%b9%e7%9b%ae%e4%bb%8e%e6%ba%90%e7%a0%81%e7%9c%8b%e8%b5%b7%ef%bc%8c%e4%bb%a5%e4%b8%8b%e6%98%af%e6%88%91%e9%98%85%e8%af%bbFFplay%e7%9a%84%e6%ba%90%e4%bb%a3%e2%80%a6%e2%80%a6%0Ahttps://example.com/learn/av-learn/ffplay_learn/" title="通过「电子邮件」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon email-icon"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a>
                    </div>
                
            
        </div>

    </div>




        
    
    



        
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/learn/android/mediacodec_source_learn/" rel="prev">&lt; </a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/learn/av-learn/rtp_protocol/" rel="next"> &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;1969–2023&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;reuixiy</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:reuixiy@gmail.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/reuixiy" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://twitter.com/reuixiy" target="_blank" rel="external noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://t.me/yixiuer" target="_blank" rel="external noopener" title="Telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon social-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    let imgNodes = document.querySelectorAll('div.post-body img');
    imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

    mediumZoom(imgNodes, {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>






    </body>
</html>

<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>LEAN</title>
<meta name="keywords" content="">
<meta name="description" content="Binder Driveræ¢ç´¢ binderé©±åŠ¨çš„åˆå§‹åŒ– åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›
device_initcall(binder_init); åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚
åœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.
static int __init binder_init(void) { int ret; char *device_name, *device_tmp; struct binder_device *device; struct hlist_node *tmp; char *device_names = NULL; //åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… ret = binder_alloc_shrinker_init(); if (ret) return ret; // ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚ atomic_set(&amp;binder_transaction_log.cur, ~0U); atomic_set(&amp;binder_transaction_log_failed.cur, ~0U); // åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚ binder_debugfs_dir_entry_root = debugfs_create_dir(&#34;binder&#34;, NULL); // åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(&#34;proc&#34;, binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) { // åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚ debugfs_create_file(&#34;state&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_state_fops); // åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚ debugfs_create_file(&#34;stats&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_stats_fops); // åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚ debugfs_create_file(&#34;transactions&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_transactions_fops); // åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚ debugfs_create_file(&#34;transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log, &amp;binder_transaction_log_fops); // åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ // å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops debugfs_create_file(&#34;failed_transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log_failed, &amp;binder_transaction_log_fops); } if (!">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="https://rong05.github.io/learn/android/binder_driver/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css" integrity="sha256-DE/TclFxNm8zUVWs3m&#43;zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://rong05.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://rong05.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://rong05.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://rong05.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://rong05.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://rong05.github.io/learn/android/binder_driver/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="" />
<meta property="og:description" content="Binder Driveræ¢ç´¢ binderé©±åŠ¨çš„åˆå§‹åŒ– åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›
device_initcall(binder_init); åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚
åœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.
static int __init binder_init(void) { int ret; char *device_name, *device_tmp; struct binder_device *device; struct hlist_node *tmp; char *device_names = NULL; //åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… ret = binder_alloc_shrinker_init(); if (ret) return ret; // ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚ atomic_set(&amp;binder_transaction_log.cur, ~0U); atomic_set(&amp;binder_transaction_log_failed.cur, ~0U); // åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚ binder_debugfs_dir_entry_root = debugfs_create_dir(&#34;binder&#34;, NULL); // åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(&#34;proc&#34;, binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) { // åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚ debugfs_create_file(&#34;state&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_state_fops); // åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚ debugfs_create_file(&#34;stats&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_stats_fops); // åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚ debugfs_create_file(&#34;transactions&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_transactions_fops); // åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚ debugfs_create_file(&#34;transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log, &amp;binder_transaction_log_fops); // åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ // å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops debugfs_create_file(&#34;failed_transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log_failed, &amp;binder_transaction_log_fops); } if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rong05.github.io/learn/android/binder_driver/" /><meta property="og:image" content="https://rong05.github.io/papermod-cover.png"/><meta property="article:section" content="learn" />



<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rong05.github.io/papermod-cover.png"/>

<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Binder Driveræ¢ç´¢ binderé©±åŠ¨çš„åˆå§‹åŒ– åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›
device_initcall(binder_init); åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚
åœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.
static int __init binder_init(void) { int ret; char *device_name, *device_tmp; struct binder_device *device; struct hlist_node *tmp; char *device_names = NULL; //åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… ret = binder_alloc_shrinker_init(); if (ret) return ret; // ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚ atomic_set(&amp;binder_transaction_log.cur, ~0U); atomic_set(&amp;binder_transaction_log_failed.cur, ~0U); // åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚ binder_debugfs_dir_entry_root = debugfs_create_dir(&#34;binder&#34;, NULL); // åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(&#34;proc&#34;, binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) { // åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚ debugfs_create_file(&#34;state&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_state_fops); // åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚ debugfs_create_file(&#34;stats&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_stats_fops); // åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚ debugfs_create_file(&#34;transactions&#34;, 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_transactions_fops); // åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚ debugfs_create_file(&#34;transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log, &amp;binder_transaction_log_fops); // åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ // å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops debugfs_create_file(&#34;failed_transaction_log&#34;, 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log_failed, &amp;binder_transaction_log_fops); } if (!"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Learns",
      "item": "https://rong05.github.io/learn/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "",
      "item": "https://rong05.github.io/learn/android/binder_driver/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "name": "",
  "description": "Binder Driveræ¢ç´¢ binderé©±åŠ¨çš„åˆå§‹åŒ– åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›\ndevice_initcall(binder_init); åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚\nåœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.\nstatic int __init binder_init(void) { int ret; char *device_name, *device_tmp; struct binder_device *device; struct hlist_node *tmp; char *device_names = NULL; //åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… ret = binder_alloc_shrinker_init(); if (ret) return ret; // ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚ atomic_set(\u0026amp;binder_transaction_log.cur, ~0U); atomic_set(\u0026amp;binder_transaction_log_failed.cur, ~0U); // åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚ binder_debugfs_dir_entry_root = debugfs_create_dir(\u0026#34;binder\u0026#34;, NULL); // åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(\u0026#34;proc\u0026#34;, binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) { // åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚ debugfs_create_file(\u0026#34;state\u0026#34;, 0444, binder_debugfs_dir_entry_root, NULL, \u0026amp;binder_state_fops); // åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚ debugfs_create_file(\u0026#34;stats\u0026#34;, 0444, binder_debugfs_dir_entry_root, NULL, \u0026amp;binder_stats_fops); // åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚ debugfs_create_file(\u0026#34;transactions\u0026#34;, 0444, binder_debugfs_dir_entry_root, NULL, \u0026amp;binder_transactions_fops); // åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚ debugfs_create_file(\u0026#34;transaction_log\u0026#34;, 0444, binder_debugfs_dir_entry_root, \u0026amp;binder_transaction_log, \u0026amp;binder_transaction_log_fops); // åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ // å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops debugfs_create_file(\u0026#34;failed_transaction_log\u0026#34;, 0444, binder_debugfs_dir_entry_root, \u0026amp;binder_transaction_log_failed, \u0026amp;binder_transaction_log_fops); } if (!",
  "keywords": [
    
  ],
  "articleBody": "Binder Driveræ¢ç´¢ binderé©±åŠ¨çš„åˆå§‹åŒ– åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›\ndevice_initcall(binder_init); åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚\nåœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.\nstatic int __init binder_init(void) { int ret; char *device_name, *device_tmp; struct binder_device *device; struct hlist_node *tmp; char *device_names = NULL; //åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… ret = binder_alloc_shrinker_init(); if (ret) return ret; // ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚ atomic_set(\u0026binder_transaction_log.cur, ~0U); atomic_set(\u0026binder_transaction_log_failed.cur, ~0U); // åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚ binder_debugfs_dir_entry_root = debugfs_create_dir(\"binder\", NULL); // åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(\"proc\", binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) { // åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚ debugfs_create_file(\"state\", 0444, binder_debugfs_dir_entry_root, NULL, \u0026binder_state_fops); // åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚ debugfs_create_file(\"stats\", 0444, binder_debugfs_dir_entry_root, NULL, \u0026binder_stats_fops); // åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚ debugfs_create_file(\"transactions\", 0444, binder_debugfs_dir_entry_root, NULL, \u0026binder_transactions_fops); // åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ //å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚ debugfs_create_file(\"transaction_log\", 0444, binder_debugfs_dir_entry_root, \u0026binder_transaction_log, \u0026binder_transaction_log_fops); // åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ // å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops debugfs_create_file(\"failed_transaction_log\", 0444, binder_debugfs_dir_entry_root, \u0026binder_transaction_log_failed, \u0026binder_transaction_log_fops); } if (!IS_ENABLED(CONFIG_ANDROID_BINDERFS) \u0026\u0026 strcmp(binder_devices_param, \"\") != 0) { /* * Copy the module_parameter string, because we don't want to * tokenize it in-place. */ // kzallocï¼šåˆ†é…ä¸è¶…è¿‡128KBçš„è¿ç»­çš„ç‰©ç†å†…å­˜æ˜ å°„åŒºåŸŸã€‚ // GFP_KERNELï¼šå†…å­˜åˆ†é…å™¨flagsï¼Œæ— å†…å­˜å¯ç”¨æ—¶å¯å¼•èµ·ä¼‘çœ ï¼Œå…è®¸å¯åŠ¨ç£ç›˜IOå’Œæ–‡ä»¶ç³»ç»ŸIOã€‚ // binder_devices_paramï¼šbinderï¼Œhwbinderï¼Œvndbinderã€‚ device_names = kstrdup(binder_devices_param, GFP_KERNEL); if (!device_names) { ret = -ENOMEM; goto err_alloc_device_names_failed; } // åˆ›å»ºbinderè®¾å¤‡ device_tmp = device_names; while ((device_name = strsep(\u0026device_tmp, \",\"))) { ret = init_binder_device(device_name); if (ret) goto err_init_binder_device_failed; } } //åˆå§‹åŒ–binderæ–‡ä»¶ç³»ç»Ÿ ret = init_binderfs(); if (ret) goto err_init_binder_device_failed; return ret; err_init_binder_device_failed: hlist_for_each_entry_safe(device, tmp, \u0026binder_devices, hlist) { misc_deregister(\u0026device-\u003emiscdev); hlist_del(\u0026device-\u003ehlist); kfree(device); } kfree(device_names); err_alloc_device_names_failed: debugfs_remove_recursive(binder_debugfs_dir_entry_root); return ret; } binder_initå‡½æ•°ä¸»è¦å†…å®¹æ˜¯ï¼š\nåˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é… åˆ›å»ºäº†sys/kernel/debug/binderç›®å½•ï¼Œä»¥åŠå…¶å­ç›®å½•æˆ–æ–‡ä»¶ æ³¨å†Œmiscè®¾å¤‡ï¼Œåˆ›å»ºbinderè®¾å¤‡ æŠŠbinder_deviceåŠ å…¥åˆ°å…¨å±€é“¾è¡¨binder_devicesè¿›è¡Œç®¡ç† é‚£æ¥çœ‹çœ‹init_binder_deviceæ˜¯å¦‚ä½•æ³¨å†Œmiscè®¾å¤‡ï¼Œåˆ›å»ºbinderè®¾å¤‡ï¼Œä»£ç å¦‚ä¸‹ï¼š\nstatic int __init init_binder_device(const char *name) { int ret; struct binder_device *binder_device; binder_device = kzalloc(sizeof(*binder_device), GFP_KERNEL); if (!binder_device) return -ENOMEM; //miscdeviceç»“æ„ä½“ binder_device-\u003emiscdev.fops = \u0026binder_fops; //è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯file_operationsç»“æ„ binder_device-\u003emiscdev.minor = MISC_DYNAMIC_MINOR;//æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é… binder_device-\u003emiscdev.name = name;//è®¾å¤‡å //binderè®¾å¤‡çš„å¼•ç”¨è®¡æ•° refcount_set(\u0026binder_device-\u003eref, 1); //é»˜è®¤binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… binder_device-\u003econtext.binder_context_mgr_uid = INVALID_UID; binder_device-\u003econtext.name = name; mutex_init(\u0026binder_device-\u003econtext.context_mgr_node_lock); // æ³¨å†Œmiscè®¾å¤‡ ret = misc_register(\u0026binder_device-\u003emiscdev); if (ret \u003c 0) { kfree(binder_device); return ret; } // é€šè¿‡å…¨å±€é“¾è¡¨binder_devicesç®¡ç†binder_deviceã€‚ hlist_add_head(\u0026binder_device-\u003ehlist, \u0026binder_devices); return ret; } ä»init_binder_deviceå‡½æ•°çœ‹å‡ºbinderé©±åŠ¨è®¾å¤‡èŠ‚ç‚¹æ˜¯é€šè¿‡binder_deviceç»“æ„ä½“ç®¡ç†çš„ï¼›è®¾ç½®binder_deviceçš„miscdevå‚æ•°ï¼Œmiscdevå…¶å®æ˜¯miscdeviceç»“æ„ä½“ï¼Œmisc_registerå‡½æ•°æ³¨å†Œmiscè®¾å¤‡ï¼Œmiscdeviceå‚æ•°åˆ†åˆ«æ˜¯ï¼š\nè®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯file_operationsç»“æ„ æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é… è®¾å¤‡å binder_deviceç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\nstruct binder_device { // åŠ å…¥binder_deviceså…¨å±€é“¾è¡¨çš„nodeã€‚ struct hlist_node hlist; // miscè®¾å¤‡ã€‚ struct miscdevice miscdev; // è·å–service managerå¯¹åº”çš„binder_nodeã€‚ struct binder_context context; //å±äºbindfsæŒ‚è½½çš„è¶…çº§å—çš„æ ¹èŠ‚ç‚¹çš„inodeã€‚ struct inode *binderfs_inode; //binder_deviceçš„å¼•ç”¨è®¡æ•° refcount_t ref; }; file_operationsç»“æ„ä½“,æŒ‡å®šç›¸åº”æ–‡ä»¶æ“ä½œçš„æ–¹æ³•\nconst struct file_operations binder_fops = { .owner = THIS_MODULE, .poll = binder_poll, .unlocked_ioctl = binder_ioctl, .compat_ioctl = compat_ptr_ioctl, .mmap = binder_mmap, .open = binder_open, .flush = binder_flush, .release = binder_release, }; ç”¨æˆ·æ€çš„ç¨‹åºè°ƒç”¨Kernelå±‚é©±åŠ¨æ˜¯éœ€è¦é™·å…¥å†…æ ¸æ€ï¼Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨(syscall)ï¼Œæ¯”å¦‚æ‰“å¼€Binderé©±åŠ¨æ–¹æ³•çš„è°ƒç”¨é“¾ä¸ºï¼š open-\u003e __open() -\u003e binder_open()ã€‚é€šè¿‡binder_fopsçš„å®šä¹‰å¾—å‡ºä»¥ä¸‹è°ƒç”¨è§„åˆ™ï¼›\nå›¾ç‰‡æ¥æº\nbinder_open ä¹‹å‰å·²ç»æåˆ°æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå•ç‹¬åˆ›å»ºè‡ªå·±çš„ProcessStateï¼ŒProcessStateæ˜¯è¿›ç¨‹å”¯ä¸€çš„ï¼›åœ¨ProcessStateåˆ›å»ºæ—¶ä¼šè°ƒç”¨openå‡½æ•°ï¼Œé‚£å¯¹åº”è°ƒç”¨çš„å°±æ˜¯binderé©±åŠ¨ä¸­çš„binder_open;\nstatic int binder_open(struct inode *nodp, struct file *filp) { struct binder_proc *proc, *itr; struct binder_device *binder_dev; struct binderfs_info *info; struct dentry *binder_binderfs_dir_entry_proc = NULL; bool existing_pid = false; binder_debug(BINDER_DEBUG_OPEN_CLOSE, \"%s: %d:%d\\n\", __func__, current-\u003egroup_leader-\u003epid, current-\u003epid); //åˆ›å»ºbinderé©±åŠ¨ä¸­ç®¡ç†IPCå’Œä¿å­˜è¿›ç¨‹ä¿¡æ¯çš„æ ¹ç»“æ„ä½“ proc = kzalloc(sizeof(*proc), GFP_KERNEL); if (proc == NULL) return -ENOMEM; // åˆå§‹åŒ–ä¸¤ä¸ªè‡ªæ—‹é”ã€‚ // inner_lockä¿æŠ¤çº¿ç¨‹ã€binder_nodeä»¥åŠæ‰€æœ‰ä¸è¿›ç¨‹ç›¸å…³çš„çš„todoé˜Ÿåˆ—ã€‚ // outer_lockä¿æŠ¤binder_refã€‚ spin_lock_init(\u0026proc-\u003einner_lock); spin_lock_init(\u0026proc-\u003eouter_lock); // è·å–å½“å‰è¿›ç¨‹ç»„é¢†å¤´è¿›ç¨‹ã€‚ get_task_struct(current-\u003egroup_leader); proc-\u003etsk = current-\u003egroup_leader;//å°†å½“å‰è¿›ç¨‹çš„task_structä¿å­˜åˆ°binder_proc INIT_LIST_HEAD(\u0026proc-\u003etodo);//åˆå§‹åŒ–todoåˆ—è¡¨ // åˆ¤æ–­å½“å‰è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯å¦æ”¯æŒï¼Œbinderåªæ”¯æŒSCHED_NORMAL(00b)ã€SCHED_FIFO(01b)ã€SCHED_RR(10b)ã€SCHED_BATCH(11b)ã€‚ // prioä¸ºè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œå¯é€šè¿‡normal_prioè·å–ã€‚ä¸€èˆ¬åˆ†ä¸ºå®æ—¶ä¼˜å…ˆçº§åŠé™æ€ä¼˜å…ˆçº§ã€‚ if (binder_supported_policy(current-\u003epolicy)) { proc-\u003edefault_priority.sched_policy = current-\u003epolicy; proc-\u003edefault_priority.prio = current-\u003enormal_prio; } else { proc-\u003edefault_priority.sched_policy = SCHED_NORMAL; proc-\u003edefault_priority.prio = NICE_TO_PRIO(0); } /* binderfs stashes devices in i_private */ // é€šè¿‡miscdevè·å–binder_deviceã€‚ if (is_binderfs_device(nodp)) { binder_dev = nodp-\u003ei_private; info = nodp-\u003ei_sb-\u003es_fs_info; binder_binderfs_dir_entry_proc = info-\u003eproc_log_dir; } else { binder_dev = container_of(filp-\u003eprivate_data, struct binder_device, miscdev); } //binder_deviceçš„å¼•ç”¨è®¡æ•°åŠ 1 refcount_inc(\u0026binder_dev-\u003eref); //åˆå§‹åŒ–å¯¹åº”è¿›ç¨‹ä¸­çš„binderé©±åŠ¨ä¸Šä¸‹æ–‡ç®¡ç†è€… proc-\u003econtext = \u0026binder_dev-\u003econtext; // åˆå§‹åŒ–binder_procçš„binder_allocå­—æ®µã€‚ binder_alloc_init(\u0026proc-\u003ealloc); // binderé©±åŠ¨ç»´æŠ¤é™æ€å…¨å±€æ•°ç»„binder_statsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆå‘˜æ•°ç»„obj_createdã€‚ // å½“binder_openè°ƒç”¨æ—¶ï¼Œobj_created[BINDER_STAT_PROC]å°†è‡ªå¢ã€‚è¯¥æ•°ç»„ç”¨æ¥ç»Ÿè®¡binderå¯¹è±¡çš„æ•°é‡ã€‚ binder_stats_created(BINDER_STAT_PROC); //åˆå§‹åŒ–binder_procçš„pidä¸ºé¢†å¤´è¿›ç¨‹çš„pidå€¼ã€‚ proc-\u003epid = current-\u003egroup_leader-\u003epid; // åˆå§‹åŒ–delivered_deathåŠwaiting_threadsé˜Ÿåˆ—ã€‚ INIT_LIST_HEAD(\u0026proc-\u003edelivered_death); INIT_LIST_HEAD(\u0026proc-\u003ewaiting_threads); // private_dataä¿å­˜binder_procå¯¹è±¡ã€‚ filp-\u003eprivate_data = proc; // å°†binder_procåŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—binder_procsä¸­,è¯¥æ“ä½œå¿…é¡»åŠ é”ã€‚ mutex_lock(\u0026binder_procs_lock); hlist_for_each_entry(itr, \u0026binder_procs, proc_node) { if (itr-\u003epid == proc-\u003epid) { existing_pid = true; break; } } hlist_add_head(\u0026proc-\u003eproc_node, \u0026binder_procs); mutex_unlock(\u0026binder_procs_lock); // è‹¥/sys/kernel/binder/procç›®å½•å·²ç»åˆ›å»ºå¥½ï¼Œåˆ™åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥pidä¸ºåçš„æ–‡ä»¶ã€‚ if (binder_debugfs_dir_entry_proc \u0026\u0026 !existing_pid) { char strbuf[11]; snprintf(strbuf, sizeof(strbuf), \"%u\", proc-\u003epid); /* * proc debug entries are shared between contexts. * Only create for the first PID to avoid debugfs log spamming * The printing code will anyway print all contexts for a given * PID so this is not a problem. */ // procè°ƒè¯•æ¡ç›®åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«ï¼Œå¦‚æœè¿›ç¨‹å°è¯•ä½¿ç”¨å…¶ä»–ä¸Šä¸‹æ–‡å†æ¬¡æ‰“å¼€é©±åŠ¨ç¨‹åºï¼Œåˆ™æ­¤æ“ä½œå°†å¤±è´¥ã€‚ proc-\u003edebugfs_entry = debugfs_create_file(strbuf, 0444, binder_debugfs_dir_entry_proc, (void *)(unsigned long)proc-\u003epid, \u0026proc_fops); } if (binder_binderfs_dir_entry_proc \u0026\u0026 !existing_pid) { char strbuf[11]; struct dentry *binderfs_entry; snprintf(strbuf, sizeof(strbuf), \"%u\", proc-\u003epid); /* * Similar to debugfs, the process specific log file is shared * between contexts. Only create for the first PID. * This is ok since same as debugfs, the log file will contain * information on all contexts of a given PID. */ binderfs_entry = binderfs_create_file(binder_binderfs_dir_entry_proc, strbuf, \u0026proc_fops, (void *)(unsigned long)proc-\u003epid); if (!IS_ERR(binderfs_entry)) { proc-\u003ebinderfs_entry = binderfs_entry; } else { int error; error = PTR_ERR(binderfs_entry); pr_warn(\"Unable to create file %s in binderfs (error %d)\\n\", strbuf, error); } } return 0; } ä»binder_openå‡½æ•°çš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»ºbinder_procç»“æ„ä½“ï¼Œå¹¶æŠŠå½“å‰è¿›ç¨‹ç­‰ä¿¡æ¯ä¿å­˜åˆ°binder_procï¼Œåˆå§‹åŒ–binder_procä¸­ç®¡ç†IPCæ‰€éœ€çš„å„ç§ä¿¡æ¯å¹¶åˆ›å»ºå…¶å®ƒç›¸å…³çš„å­ç»“æ„ä½“ï¼›å†æŠŠbinder_procä¿å­˜åˆ°æ–‡ä»¶æŒ‡é’ˆfilpï¼Œä»¥åŠæŠŠbinder_procåŠ å…¥åˆ°å…¨å±€é“¾è¡¨binder_procsï¼Œè¿™ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ã€‚\nbinder_procsç»“æ„ä½“ struct binder_proc { //åŠ å…¥binder_procså…¨å±€é“¾è¡¨çš„nodeèŠ‚ç‚¹ã€‚ struct hlist_node proc_node; //è®°å½•æ‰§è¡Œä¼ è¾“åŠ¨ä½œçš„çº¿ç¨‹ä¿¡æ¯, binder_threadçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ struct rb_root threads; //ç”¨äºè®°å½•binderå®ä½“ ,binder_nodeçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒæ˜¯Serveråœ¨Binderé©±åŠ¨ä¸­çš„ä½“ç° struct rb_root nodes; //binder_refçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹(ä»¥handleä¸ºkey struct rb_root refs_by_desc; //binder_refçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ˆä»¥pträ¸ºkeyï¼‰ struct rb_root refs_by_node; //è¯¥binderè¿›ç¨‹çš„çº¿ç¨‹æ± ä¸­ç­‰å¾…å¤„ç†binder_workçš„binder_threadé“¾è¡¨ struct list_head waiting_threads; //ç›¸åº”è¿›ç¨‹id int pid; //ç›¸åº”è¿›ç¨‹çš„taskç»“æ„ä½“ struct task_struct *tsk; struct hlist_node deferred_work_node; int deferred_work; bool is_dead; //è¿›ç¨‹å°†è¦åšçš„äº‹ struct list_head todo; //binderç»Ÿè®¡ä¿¡æ¯ struct binder_stats stats; //å·²åˆ†å‘çš„æ­»äº¡é€šçŸ¥ struct list_head delivered_death; //æœ€å¤§çº¿ç¨‹æ•° int max_threads; //è¯·æ±‚çš„çº¿ç¨‹æ•° int requested_threads; //å·²å¯åŠ¨çš„è¯·æ±‚çº¿ç¨‹æ•° int requested_threads_started; int tmp_ref; //é»˜è®¤ä¼˜å…ˆçº§ struct binder_priority default_priority; struct dentry *debugfs_entry; //è¿›ç¨‹é€šä¿¡æ•°æ®å†…å­˜åˆ†é…ç›¸å…³ struct binder_alloc alloc; //binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… struct binder_context *context; spinlock_t inner_lock; spinlock_t outer_lock; struct dentry *binderfs_entry; }; struct binder_alloc { struct mutex mutex; //æŒ‡å‘è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„æŒ‡é’ˆ struct vm_area_struct *vma; //ç›¸åº”è¿›ç¨‹çš„å†…å­˜ç»“æ„ä½“ struct mm_struct *vma_vm_mm; // map çš„åœ°å€å°±æ˜¯è¿™é‡Œäº† void __user *buffer; //æ‰€æœ‰çš„buffersåˆ—è¡¨ struct list_head buffers; //åªè¿›è¡Œäº†é¢„å®šï¼Œæ²¡æœ‰åˆ†é…ï¼ŒæŒ‰å¤§å°æ’åº struct rb_root free_buffers; //å·²ç»åˆ†é…äº†,æŒ‰åœ°å€æ’åº struct rb_root allocated_buffers; //ç”¨äºå¼‚æ­¥è¯·æ±‚çš„ç©ºé—´ size_t free_async_space; //æ‰€æœ‰çš„pagesæŒ‡å‘ç‰©ç†å†…å­˜é¡µ struct binder_lru_page *pages; //æ˜ å°„çš„å†…æ ¸ç©ºé—´å¤§å° size_t buffer_size; uint32_t buffer_free; int pid; size_t pages_high; }; binder_mmap ä¸»è¦åŠŸèƒ½ï¼š\nä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…ä¸€å—å†…æ ¸ç©ºé—´ä½œä¸ºç¼“å†²åŒºï¼Œå¹¶æŠŠåˆ†é…çš„ç¼“å†²åŒºæŒ‡é’ˆå­˜æ”¾åˆ°binder_procçš„bufferå­—æ®µï¼› åˆ†é…pagesç©ºé—´ï¼Œå¹¶å†…æ ¸åˆ†é…ä¸€å—åŒæ ·é¡µæ•°çš„å†…æ ¸ç©ºé—´,å¹¶æŠŠå®ƒçš„ç‰©ç†å†…å­˜å’Œå‰é¢ä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…çš„å†…å­˜åœ°å€å…³è”ï¼› åˆ†é…çš„å†…å­˜å—åŠ å…¥ç”¨æˆ·è¿›ç¨‹å†…å­˜é“¾è¡¨ï¼› static int binder_mmap(struct file *filp, struct vm_area_struct *vma) { //private_dataä¿å­˜äº†æˆ‘ä»¬openè®¾å¤‡æ—¶åˆ›å»ºçš„binder_procä¿¡æ¯ struct binder_proc *proc = filp-\u003eprivate_data; if (proc-\u003etsk != current-\u003egroup_leader) return -EINVAL; binder_debug(BINDER_DEBUG_OPEN_CLOSE, \"%s: %d %lx-%lx (%ld K) vma %lx pagep %lx\\n\", __func__, proc-\u003epid, vma-\u003evm_start, vma-\u003evm_end, (vma-\u003evm_end - vma-\u003evm_start) / SZ_1K, vma-\u003evm_flags, (unsigned long)pgprot_val(vma-\u003evm_page_prot)); //mmap çš„ buffer ç¦æ­¢ç”¨æˆ·è¿›è¡Œå†™æ“ä½œã€‚mmap åªæ˜¯ä¸ºäº†åˆ†é…å†…æ ¸ç©ºé—´ï¼Œä¼ é€’æ•°æ®é€šè¿‡ ioctl() if (vma-\u003evm_flags \u0026 FORBIDDEN_MMAP_FLAGS) { pr_err(\"%s: %d %lx-%lx %s failed %d\\n\", __func__, proc-\u003epid, vma-\u003evm_start, vma-\u003evm_end, \"bad vm_flags\", -EPERM); return -EPERM; } // å°† VM_DONTCOP ç½®èµ·ï¼Œç¦æ­¢ æ‹·è´ï¼Œç¦æ­¢ å†™æ“ä½œ vma-\u003evm_flags |= VM_DONTCOPY | VM_MIXEDMAP; vma-\u003evm_flags \u0026= ~VM_MAYWRITE; vma-\u003evm_ops = \u0026binder_vm_ops; vma-\u003evm_private_data = proc; // å†æ¬¡å®Œå–„ binder buffer allocator return binder_alloc_mmap_handler(\u0026proc-\u003ealloc, vma); } int binder_alloc_mmap_handler(struct binder_alloc *alloc, struct vm_area_struct *vma) { int ret; const char *failure_string; //æ¯ä¸€æ¬¡Binderä¼ è¾“æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆä»Binderå†…å­˜ç¼“å­˜åŒºä¸­åˆ†é…ä¸€ä¸ªbinder_bufferæ¥å­˜å‚¨ä¼ è¾“æ•°æ® struct binder_buffer *buffer; //åŒæ­¥é” mutex_lock(\u0026binder_alloc_mmap_lock); // ä¸éœ€è¦é‡å¤mmap if (alloc-\u003ebuffer_size) { ret = -EBUSY; failure_string = \"already mapped\"; goto err_already_mapped; } //vma-\u003evm_end, vma-\u003evm_start æŒ‡å‘è¦ æ˜ å°„çš„ç”¨æˆ·ç©ºé—´åœ°å€, map size ä¸å…è®¸ å¤§äº 4M alloc-\u003ebuffer_size = min_t(unsigned long, vma-\u003evm_end - vma-\u003evm_start, SZ_4M); mutex_unlock(\u0026binder_alloc_mmap_lock); //æŒ‡å‘ç”¨æˆ·è¿›ç¨‹å†…æ ¸è™šæ‹Ÿç©ºé—´çš„ startåœ°å€ alloc-\u003ebuffer = (void __user *)vma-\u003evm_start; //åˆ†é…ç‰©ç†é¡µçš„æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å¤§å°ä¸ºvmaçš„ç­‰æ•ˆpageä¸ªæ•° alloc-\u003epages = kcalloc(alloc-\u003ebuffer_size / PAGE_SIZE, sizeof(alloc-\u003epages[0]), GFP_KERNEL); if (alloc-\u003epages == NULL) { ret = -ENOMEM; failure_string = \"alloc page array\"; goto err_alloc_pages_failed; } //ç”³è¯·ä¸€ä¸ªbinder_bufferçš„å†…å­˜ buffer = kzalloc(sizeof(*buffer), GFP_KERNEL); if (!buffer) { ret = -ENOMEM; failure_string = \"alloc buffer struct\"; goto err_alloc_buf_struct_failed; } //æŒ‡å‘ç”¨æˆ·è¿›ç¨‹å†…æ ¸è™šæ‹Ÿç©ºé—´çš„ startåœ°å€ï¼Œå³ä¸ºå½“å‰è¿›ç¨‹mmapçš„å†…æ ¸ç©ºé—´åœ°å€ buffer-\u003euser_data = alloc-\u003ebuffer; //å°†binder_bufferåœ°å€ï¼ŒåŠ å…¥åˆ°æ‰€å±è¿›ç¨‹çš„buffersé˜Ÿåˆ— list_add(\u0026buffer-\u003eentry, \u0026alloc-\u003ebuffers); buffer-\u003efree = 1; //å°†å½“å‰bufferåŠ å…¥åˆ°çº¢é»‘æ ‘alloc-\u003efree_buffersä¸­ï¼Œè¡¨ç¤ºå½“å‰bufferæ˜¯ç©ºé—²buffer binder_insert_free_buffer(alloc, buffer); // å°†å¼‚æ­¥äº‹åŠ¡çš„ç©ºé—´å¤§å°è®¾ç½®ä¸º æ•´ä¸ªç©ºé—´çš„ä¸€åŠ alloc-\u003efree_async_space = alloc-\u003ebuffer_size / 2; binder_alloc_set_vma(alloc, vma); mmgrab(alloc-\u003evma_vm_mm); return 0; err_alloc_buf_struct_failed: kfree(alloc-\u003epages); alloc-\u003epages = NULL; err_alloc_pages_failed: alloc-\u003ebuffer = NULL; mutex_lock(\u0026binder_alloc_mmap_lock); alloc-\u003ebuffer_size = 0; err_already_mapped: mutex_unlock(\u0026binder_alloc_mmap_lock); binder_alloc_debug(BINDER_DEBUG_USER_ERROR, \"%s: %d %lx-%lx %s failed %d\\n\", __func__, alloc-\u003epid, vma-\u003evm_start, vma-\u003evm_end, failure_string, ret); return ret; } static void binder_insert_free_buffer(struct binder_alloc *alloc, struct binder_buffer *new_buffer) { struct rb_node **p = \u0026alloc-\u003efree_buffers.rb_node; struct rb_node *parent = NULL; struct binder_buffer *buffer; size_t buffer_size; size_t new_buffer_size; BUG_ON(!new_buffer-\u003efree); // é€šè¿‡binder_alloc_buffer_sizeè®¡ç®—å½“å‰new_bufferçš„å¤§å°ï¼Œä¹‹åå°†ç”¨äºæ¯”è¾ƒã€‚ new_buffer_size = binder_alloc_buffer_size(alloc, new_buffer); binder_alloc_debug(BINDER_DEBUG_BUFFER_ALLOC, \"%d: add free buffer, size %zd, at %pK\\n\", alloc-\u003epid, new_buffer_size, new_buffer); while (*p) { parent = *p; // è·å–å½“å‰çº¢é»‘æ ‘èŠ‚ç‚¹çš„bufferã€‚ buffer = rb_entry(parent, struct binder_buffer, rb_node); BUG_ON(!buffer-\u003efree); // è®¡ç®—å½“å‰çº¢é»‘æ ‘èŠ‚ç‚¹çš„bufferå¤§å°ã€‚ buffer_size = binder_alloc_buffer_size(alloc, buffer); // çº¢é»‘æ ‘éµå¾ªäºŒå‰æ ‘è§„åˆ™ï¼šå½“æ–°çš„bufferæ¯”å½“å‰èŠ‚ç‚¹çš„bufferå°æ—¶ï¼Œå‘å·¦å­èŠ‚ç‚¹ç»§ç»­é‡å¤ï¼Œå¦åˆ™è½¬å‘å³å­èŠ‚ç‚¹ã€‚ if (new_buffer_size \u003c buffer_size) p = \u0026parent-\u003erb_left; else p = \u0026parent-\u003erb_right; } // æ‰¾åˆ°åˆé€‚ä½ç½®åï¼Œå°†new_bufferæ’å…¥åˆ°è¯¥ä½ç½®ã€‚ rb_link_node(\u0026new_buffer-\u003erb_node, parent, p); rb_insert_color(\u0026new_buffer-\u003erb_node, \u0026alloc-\u003efree_buffers); } binder_mmapé€šè¿‡åŠ é”ï¼Œä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªè¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¿è¯å¤šè¿›ç¨‹é—´çš„å¹¶å‘è®¿é—®ã€‚å°†åˆ†é…ä¸€å—å†…æ ¸ç©ºé—´ç¼“å†²åŒºbufferåŠ å…¥åˆ°çº¢é»‘æ ‘alloc-\u003efree_buffersä¸­ï¼Œè¡¨ç¤ºå½“å‰bufferæ˜¯ç©ºé—²bufferï¼›æ¯ä¸€æ¬¡Binderä¼ è¾“æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆä»Binderå†…å­˜ç¼“å­˜åŒºä¸­åˆ†é…ä¸€ä¸ªbinder_bufferæ¥å­˜å‚¨ä¼ è¾“æ•°æ®ã€‚\nbinder_bufferç»“æ„ä½“ struct binder_buffer { //bufferå®ä½“çš„åœ°å€ struct list_head entry; /* free and allocated entries by address */ struct rb_node rb_node; /* free entry by size or allocated entry */ /* by address */ //æ ‡è®°æ˜¯å¦æ˜¯ç©ºé—²bufferï¼Œå ä½1bit unsigned free:1; //æ˜¯å¦å…è®¸ç”¨æˆ·é‡Šæ”¾ï¼Œå ä½1bit unsigned clear_on_free:1; unsigned allow_user_free:1; unsigned async_transaction:1; unsigned debug_id:28; //è¯¥ç¼“å­˜åŒºçš„éœ€è¦å¤„ç†çš„äº‹åŠ¡ struct binder_transaction *transaction; //è¯¥ç¼“å­˜åŒºæ‰€éœ€å¤„ç†çš„Binderå®ä½“ struct binder_node *target_node; //æ•°æ®å¤§å° size_t data_size; //æ•°æ®åç§»é‡ size_t offsets_size; size_t extra_buffers_size; //ç”¨æˆ·æ•°æ® void __user *user_data; int pid; }; struct binder_lru_page { struct list_head lru;//binder_alloc_lruä¸­çš„æ¡ç›® struct page *page_ptr;//æŒ‡å‘mmapç©ºé—´ä¸­çš„ç‰©ç†é¡µé¢çš„æŒ‡é’ˆ struct binder_alloc *alloc;//procçš„binder_alloc }; binder_mmapè¿™é‡Œä¸»è¦æ˜ å°„çš„å†…å­˜åªå…è®¸ç”¨æˆ·ç©ºé—´è¯»ï¼Œä¸å…è®¸ç”¨æˆ·ç©ºé—´å†™ï¼›binderé©±åŠ¨å¯ä»¥è¯»å†™è¿™å—å†…å­˜ï¼›å­˜æ˜ å°„å®ç°ä¸€æ¬¡æ‹·è´çš„æ¦‚å¿µæ˜¯ï¼š\nç”¨æˆ·ç©ºé—´ç»™binderé©±åŠ¨ä¼ å…¥ä¿¡æ¯æ—¶ï¼Œéƒ½éœ€è¦å†…å­˜æ‹·è´ï¼› binderé©±åŠ¨ç»™å‘é€ç”¨æˆ·ç©ºé—´åˆ™ä¸éœ€è¦ï¼› ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ binder_update_page_rangeå‡½æ•°ä¸»è¦çš„ä½œç”¨æ˜¯åˆ†é…å’Œé‡Šæ”¾ç‰©ç†å†…å­˜ï¼›\nbinder_ioctl binder_ioctl()å‡½æ•°è´Ÿè´£åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´æ”¶å‘IPCæ•°æ®å’ŒIPC replyæ•°æ®ã€‚\nioctlå‘½ä»¤å’Œæ•°æ®ç±»å‹æ˜¯ä¸€ä½“çš„ï¼Œä¸åŒçš„å‘½ä»¤å¯¹åº”ä¸åŒçš„æ•°æ®ç±»å‹\nioctlå‘½ä»¤ æ•°æ®ç±»å‹ æ“ä½œ BINDER_WRITE_READ struct binder_write_read æ”¶å‘Binder IPCæ•°æ® BINDER_SET_MAX_THREADS __u32 è®¾ç½®Binderçº¿ç¨‹æœ€å¤§ä¸ªæ•° BINDER_SET_CONTEXT_MGR __s32 è®¾ç½®Service ManagerèŠ‚ç‚¹ BINDER_THREAD_EXIT __s32 é‡Šæ”¾Binderçº¿ç¨‹ BINDER_VERSION struct binder_version è·å–Binderç‰ˆæœ¬ä¿¡æ¯ BINDER_SET_IDLE_TIMEOUT __s64 æ²¡æœ‰ä½¿ç”¨ BINDER_SET_IDLE_PRIORITY __s32 æ²¡æœ‰ä½¿ç”¨ è¿™äº›å‘½ä»¤ä¸­BINDER_WRITE_READå‘½ä»¤ä½¿ç”¨ç‡æœ€ä¸ºé¢‘ç¹ï¼Œä¹Ÿæ˜¯ioctlæœ€ä¸ºæ ¸å¿ƒçš„å‘½ä»¤ã€‚\nstatic long binder_ioctl(struct file *filp, unsigned int cmd, unsigned long arg) { int ret; //oepnçš„æ—¶å€™åŒ…åœ¨filpçš„private_data struct binder_proc *proc = filp-\u003eprivate_data; struct binder_thread *thread; unsigned int size = _IOC_SIZE(cmd); void __user *ubuf = (void __user *)arg; /*pr_info(\"binder_ioctl: %d:%d %x %lx\\n\", proc-\u003epid, current-\u003epid, cmd, arg);*/ binder_selftest_alloc(\u0026proc-\u003ealloc); trace_binder_ioctl(cmd, arg); //è¿™é‡Œæ—¶ä¸€ä¸ªé˜»å¡ä»£ç ï¼Œå¦‚æœbinder_stop_on_user_error å¤§äº2è¿™é‡Œä¼šè¢«ä¼‘çœ  //è¿™é‡Œå…ˆæ— è§†å³å¯ ret = wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error \u003c 2); if (ret) goto err_unlocked; //è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ç»“æ„ä½“ï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªæ”¾å…¥åˆ°procçš„çº¢é»‘æ ‘ thread = binder_get_thread(proc); if (thread == NULL) { ret = -ENOMEM; goto err; } switch (cmd) { case BINDER_WRITE_READ://è¿›è¡Œbinderçš„è¯»å†™æ“ä½œ ret = binder_ioctl_write_read(filp, cmd, arg, thread); if (ret) goto err; break; case BINDER_SET_MAX_THREADS: {//è®¾ç½®binderæœ€å¤§æ”¯æŒçš„çº¿ç¨‹æ•° int max_threads; if (copy_from_user(\u0026max_threads, ubuf, sizeof(max_threads))) { ret = -EINVAL; goto err; } binder_inner_proc_lock(proc); proc-\u003emax_threads = max_threads; binder_inner_proc_unlock(proc); break; } case BINDER_SET_CONTEXT_MGR_EXT: { //è®¾ç½®Service ManagerèŠ‚ç‚¹ï¼Œå¸¦flagå‚æ•°ï¼Œ servicemanagerè¿›ç¨‹æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€… struct flat_binder_object fbo; if (copy_from_user(\u0026fbo, ubuf, sizeof(fbo))) { ret = -EINVAL; goto err; } ret = binder_ioctl_set_ctx_mgr(filp, \u0026fbo); if (ret) goto err; break; } case BINDER_SET_CONTEXT_MGR://æˆä¸ºbinderçš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œä¸å¸¦flagå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ServiceManageræˆä¸ºå®ˆæŠ¤è¿›ç¨‹ ret = binder_ioctl_set_ctx_mgr(filp, NULL); if (ret) goto err; break; case BINDER_THREAD_EXIT://å½“binderçº¿ç¨‹é€€å‡ºï¼Œé‡Šæ”¾binderçº¿ç¨‹ binder_debug(BINDER_DEBUG_THREADS, \"%d:%d exit\\n\", proc-\u003epid, thread-\u003epid); binder_thread_release(proc, thread); thread = NULL; break; case BINDER_VERSION: {//è·å–binderçš„ç‰ˆæœ¬å· struct binder_version __user *ver = ubuf; if (size != sizeof(struct binder_version)) { ret = -EINVAL; goto err; } if (put_user(BINDER_CURRENT_PROTOCOL_VERSION, \u0026ver-\u003eprotocol_version)) { ret = -EINVAL; goto err; } break; } case BINDER_GET_NODE_INFO_FOR_REF: { struct binder_node_info_for_ref info; if (copy_from_user(\u0026info, ubuf, sizeof(info))) { ret = -EFAULT; goto err; } ret = binder_ioctl_get_node_info_for_ref(proc, \u0026info); if (ret \u003c 0) goto err; if (copy_to_user(ubuf, \u0026info, sizeof(info))) { ret = -EFAULT; goto err; } break; } case BINDER_GET_NODE_DEBUG_INFO: { struct binder_node_debug_info info; if (copy_from_user(\u0026info, ubuf, sizeof(info))) { ret = -EFAULT; goto err; } ret = binder_ioctl_get_node_debug_info(proc, \u0026info); if (ret \u003c 0) goto err; if (copy_to_user(ubuf, \u0026info, sizeof(info))) { ret = -EFAULT; goto err; } break; } default: ret = -EINVAL; goto err; } ret = 0; err: if (thread) thread-\u003elooper_need_return = false; wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error \u003c 2); if (ret \u0026\u0026 ret != -ERESTARTSYS) pr_info(\"%d:%d ioctl %x %lx returned %d\\n\", proc-\u003epid, current-\u003epid, cmd, arg, ret); err_unlocked: trace_binder_ioctl_done(ret); return ret; } è·å–binderçº¿ç¨‹ ä»binder_procä¸­æŸ¥æ‰¾binder_thread,å¦‚æœå½“å‰çº¿ç¨‹å·²ç»åŠ å…¥åˆ°procçš„çº¿ç¨‹é˜Ÿåˆ—åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºbinder_threadï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°å½“å‰çš„proc\nstatic struct binder_thread *binder_get_thread(struct binder_proc *proc) { struct binder_thread *thread; struct binder_thread *new_thread; binder_inner_proc_lock(proc); //ä»å½“å‰è¿›ç¨‹ä¸­è·å–çº¿ç¨‹ thread = binder_get_thread_ilocked(proc, NULL); binder_inner_proc_unlock(proc); if (!thread) { //å¦‚æœå½“å‰è¿›ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹ï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ª new_thread = kzalloc(sizeof(*thread), GFP_KERNEL); if (new_thread == NULL) return NULL; binder_inner_proc_lock(proc); thread = binder_get_thread_ilocked(proc, new_thread); binder_inner_proc_unlock(proc); if (thread != new_thread) kfree(new_thread); } return thread; } binder_threadç»“æ„ä½“ binder_threadæ˜¯å½“å‰binderæ“ä½œæ‰€åœ¨çš„çº¿ç¨‹ï¼›\nstruct binder_thread { struct binder_proc *proc;//çº¿ç¨‹æ‰€å±çš„è¿›ç¨‹ struct rb_node rb_node; //çº¢é»‘æ ‘èŠ‚ç‚¹ struct list_head waiting_thread_node; int pid;//çº¿ç¨‹pid int looper; /* only modified by this thread */ bool looper_need_return; /* can be written by other thread */ struct binder_transaction *transaction_stack;//çº¿ç¨‹æ­£åœ¨å¤„ç†çš„äº‹åŠ¡ struct list_head todo;//å°†è¦å¤„ç†çš„é“¾è¡¨ bool process_todo; struct binder_error return_error;//writeå¤±è´¥åï¼Œè¿”å›çš„é”™è¯¯ç  struct binder_error reply_error; wait_queue_head_t wait; //ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå¤´ struct binder_stats stats;//binderçº¿ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯ atomic_t tmp_ref; bool is_dead; struct task_struct *task; }; ServiceManageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… ServiceManageråœ¨nativeå±‚ä¸­ProcessStateçš„becomeContextManagerå‡½æ•°é€šè¿‡ioctlå‘é€BINDER_SET_CONTEXT_MGR_EXT å‘½ä»¤ï¼Œè®©è‡ªèº«æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…;ç„¶ååœ¨binderé©±åŠ¨ä¸­çš„binder_ioctlæ¥æ”¶åˆ°äº†BINDER_SET_CONTEXT_MGR_EXTæŒ‡ä»¤åï¼›é€šè¿‡binder_ioctl_set_ctx_mgrå‡½æ•°è¿›è¡Œå¤„ç†ï¼›\nbinder_ioctl_set_ctx_mgr()å¤„ç†å¦‚ä¸‹ï¼š\né€šè¿‡filp-\u003eprivate_dataæ‰¾åˆ°binder_proc; å¯¹å½“å‰è¿›ç¨‹è¿›è¡Œæ˜¯å¦å…·æ³¨å†ŒContext Managerçš„SELinuxå®‰å…¨æƒé™çš„æ£€æŸ¥ è¿›è¡Œuidæ£€æŸ¥ï¼Œçº¿ç¨‹åªèƒ½æ³¨å†Œè‡ªå·±ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºContext Manager è®¾ç½®å½“å‰çº¿ç¨‹euidä½œä¸ºServiceManagerçš„uidï¼› åˆ›å»ºä¸€ä¸ªbinderå®ä½“binder_nodeï¼Œå¹¶åŠ å…¥åˆ°å½“å‰è¿›ç¨‹çš„nodesçº¢é»‘æ ‘ä¸­ï¼› æŠŠæ–°åˆ›å»ºçš„binder_node,èµ‹å€¼ç»™å½“å‰è¿›ç¨‹çš„binder_context_mgr_nodeï¼Œè¿™æ ·å°±çº¦å®šè¯¥è¿›ç¨‹å°±æˆä¸ºäº†binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡çš„ç®¡ç†è€…ï¼› static int binder_ioctl_set_ctx_mgr(struct file *filp, struct flat_binder_object *fbo) { int ret = 0; //filp-\u003eprivate_data åœ¨open()binderé©±åŠ¨æ—¶ï¼Œä¿å­˜äº†ä¸€ä¸ªåˆ›å»ºçš„binder_procï¼Œå³æ˜¯æ­¤æ—¶è°ƒç”¨è¿›ç¨‹çš„binder_proc. struct binder_proc *proc = filp-\u003eprivate_data; //è·å¾—å½“å‰è¿›ç¨‹çš„context struct binder_context *context = proc-\u003econtext; struct binder_node *new_node; kuid_t curr_euid = current_euid(); mutex_lock(\u0026context-\u003econtext_mgr_node_lock); //ä¿è¯åªåˆ›å»ºä¸€æ¬¡mgr_nodeå¯¹è±¡ if (context-\u003ebinder_context_mgr_node) { pr_err(\"BINDER_SET_CONTEXT_MGR already set\\n\"); ret = -EBUSY; goto out; } //æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦å…·æ³¨å†ŒContext Managerçš„SEAndroidå®‰å…¨æƒé™ ret = security_binder_set_context_mgr(proc-\u003etsk); if (ret \u003c 0) goto out; //æ£€æŸ¥å·²çš„uidæ˜¯å¦æœ‰æ•ˆ if (uid_valid(context-\u003ebinder_context_mgr_uid)) { //uidæœ‰æ•ˆä½†æ˜¯ä¸å½“å‰è¿è¡Œçº¿ç¨‹çš„æ•ˆç”¨æˆ·IDä¸ç›¸ç­‰ï¼Œåˆ™å‡ºé”™ã€‚ //å³çº¿ç¨‹åªèƒ½æ³¨å†Œè‡ªå·±ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºContext Manager if (!uid_eq(context-\u003ebinder_context_mgr_uid, curr_euid)) { pr_err(\"BINDER_SET_CONTEXT_MGR bad uid %d != %d\\n\", from_kuid(\u0026init_user_ns, curr_euid), from_kuid(\u0026init_user_ns, context-\u003ebinder_context_mgr_uid)); ret = -EPERM; goto out; } } else { //è®¾ç½®å½“å‰çº¿ç¨‹euidä½œä¸ºServiceManagerçš„uid context-\u003ebinder_context_mgr_uid = curr_euid; } //åˆ›å»ºbinderå®ä½“ï¼Œå¹¶åŠ å…¥åˆ°å½“å‰è¿›ç¨‹çš„nodesçº¢é»‘æ ‘ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥æ˜¯ServiceManager new_node = binder_new_node(proc, fbo); if (!new_node) { ret = -ENOMEM; goto out; } binder_node_lock(new_node); //æ›´æ–°new_nodeçš„ç›¸å…³å¼ºå¼±å¼•ç”¨è®¡æ•° new_node-\u003elocal_weak_refs++; new_node-\u003elocal_strong_refs++; new_node-\u003ehas_strong_ref = 1; new_node-\u003ehas_weak_ref = 1; //new_node èµ‹å€¼ç»™è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ç®¡ç†èŠ‚ç‚¹ï¼Œä½œä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€… context-\u003ebinder_context_mgr_node = new_node; binder_node_unlock(new_node); binder_put_node(new_node); out: mutex_unlock(\u0026context-\u003econtext_mgr_node_lock); return ret; } binder_nodeç»“æ„ä½“ binder_nodeä»£è¡¨ä¸€ä¸ªbinderå®ä½“\nstruct binder_node { int debug_id;//èŠ‚ç‚¹åˆ›å»ºæ—¶åˆ†é…ï¼Œå…·æœ‰å…¨å±€å”¯ä¸€æ€§ï¼Œç”¨äºè°ƒè¯•ä½¿ç”¨ spinlock_t lock; struct binder_work work; union { struct rb_node rb_node;//binderèŠ‚ç‚¹æ­£å¸¸ä½¿ç”¨ï¼Œunion struct hlist_node dead_node;//binderèŠ‚ç‚¹å·²é”€æ¯ï¼Œunion }; struct binder_proc *proc;//binderæ‰€åœ¨çš„è¿›ç¨‹ struct hlist_head refs;//æ‰€æœ‰æŒ‡å‘è¯¥èŠ‚ç‚¹çš„binderå¼•ç”¨é˜Ÿåˆ— int internal_strong_refs; int local_weak_refs; int local_strong_refs; int tmp_refs; binder_uintptr_t ptr;//æŒ‡å‘ç”¨æˆ·ç©ºé—´binder_nodeçš„æŒ‡é’ˆï¼Œå¯¹åº”flat_binder_object.binder binder_uintptr_t cookie;//æ•°æ®ï¼Œå¯¹åº”flat_binder_object.cooki struct { /* * bitfield elements protected by * proc inner_lock */ u8 has_strong_ref:1; u8 pending_strong_ref:1; u8 has_weak_ref:1; u8 pending_weak_ref:1; }; struct { /* * invariant after initialization */ u8 sched_policy:2; u8 inherit_rt:1; u8 accept_fds:1; u8 txn_security_ctx:1; u8 min_priority; }; bool has_async_transaction; struct list_head async_todo;//å¼‚æ­¥todoé˜Ÿåˆ— }; binder_ioctl_write_read binder_ioctl_write_readæ˜¯binderæ•°æ®äº¤äº’çš„æ ¸å¿ƒå…¥å£,åœ¨nativeå±‚ä¸­é€šè¿‡ioctlå‘é€BINDER_WRITE_READå‘½ä»¤æ‰§è¡Œè¯¥å‡½æ•°ï¼Œargæ˜¯ä¸€ä¸ªbinder_write_readç»“æ„ä½“;\nstatic int binder_ioctl_write_read(struct file *filp, unsigned int cmd, unsigned long arg, struct binder_thread *thread) { int ret = 0; struct binder_proc *proc = filp-\u003eprivate_data; unsigned int size = _IOC_SIZE(cmd); void __user *ubuf = (void __user *)arg; struct binder_write_read bwr; if (size != sizeof(struct binder_write_read)) { ret = -EINVAL; goto out; } //æŠŠç”¨æˆ·ç©ºé—´æ•°æ®ubufæ‹·è´åˆ°bwr if (copy_from_user(\u0026bwr, ubuf, sizeof(bwr))) { ret = -EFAULT; goto out; } binder_debug(BINDER_DEBUG_READ_WRITE, \"%d:%d write %lld at %016llx, read %lld at %016llx\\n\", proc-\u003epid, thread-\u003epid, (u64)bwr.write_size, (u64)bwr.write_buffer, (u64)bwr.read_size, (u64)bwr.read_buffer); if (bwr.write_size \u003e 0) { //å½“å†™ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinderå†™æ“ä½œ ret = binder_thread_write(proc, thread, bwr.write_buffer, bwr.write_size, \u0026bwr.write_consumed); trace_binder_write_done(ret); if (ret \u003c 0) { //binder_thread_writeä¸­æœ‰é”™è¯¯å‘ç”Ÿï¼Œåˆ™read_consumedè®¾ä¸º0ï¼Œè¡¨ç¤ºkernelæ²¡æœ‰æ•°æ®è¿”å›ç»™è¿›ç¨‹ bwr.read_consumed = 0; //å°†bwrè¿”å›ç»™ç”¨æˆ·æ€è°ƒç”¨è€…ï¼Œbwråœ¨binder_thread_writeä¸­ä¼šè¢«ä¿®æ”¹ if (copy_to_user(ubuf, \u0026bwr, sizeof(bwr))) ret = -EFAULT; goto out; } } if (bwr.read_size \u003e 0) { //å½“è¯»ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinderè¯»æ“ä½œ ret = binder_thread_read(proc, thread, bwr.read_buffer, bwr.read_size, \u0026bwr.read_consumed, filp-\u003ef_flags \u0026 O_NONBLOCK); trace_binder_read_done(ret); binder_inner_proc_lock(proc); //è¯»å–å®Œåï¼Œå¦‚æœproc-\u003etodoé“¾è¡¨ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’åœ¨proc-\u003ewaitç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹ if (!binder_worklist_empty_ilocked(\u0026proc-\u003etodo)) binder_wakeup_proc_ilocked(proc); binder_inner_proc_unlock(proc); if (ret \u003c 0) { //å¦‚æœbinder_thread_readè¿”å›å°äº0ï¼Œå¯èƒ½å¤„ç†ä¸€åŠå°±ä¸­æ–­äº†ï¼Œéœ€è¦å°†bwræ‹·è´å›è¿›ç¨‹çš„ç”¨æˆ·æ€åœ°å€ if (copy_to_user(ubuf, \u0026bwr, sizeof(bwr))) ret = -EFAULT; goto out; } } binder_debug(BINDER_DEBUG_READ_WRITE, \"%d:%d wrote %lld of %lld, read return %lld of %lld\\n\", proc-\u003epid, thread-\u003epid, (u64)bwr.write_consumed, (u64)bwr.write_size, (u64)bwr.read_consumed, (u64)bwr.read_size); //å°†å†…æ ¸æ•°æ®bwræ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ubuf if (copy_to_user(ubuf, \u0026bwr, sizeof(bwr))) { ret = -EFAULT; goto out; } out: return ret; } æµç¨‹:\nç”¨æˆ·ç©ºé—´æ•°æ®ubufæ‹·è´åˆ°å†…æ ¸ç©ºé—´bwr; å½“bwrå†™ç¼“å­˜æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinder_thread_writeï¼›å½“å†™å¤±è´¥åˆ™read_consumedè®¾ä¸º0ï¼Œå¹¶å°†bwræ•°æ®å†™å›ç”¨æˆ·ç©ºé—´å¹¶é€€å‡ºï¼› å½“bwrè¯»ç¼“å­˜æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinder_thread_readï¼Œè¯»å–å®Œåï¼Œå¦‚æœproc-\u003etodoé“¾è¡¨ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’åœ¨proc-\u003ewaitç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹;å½“è¯»å¤±è´¥åˆ™å†å°†bwræ•°æ®å†™å›ç”¨æˆ·ç©ºé—´å¹¶é€€å‡ºï¼› æŠŠå†…æ ¸æ•°æ®bwræ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ubufã€‚ ",
  "wordCount" : "2127",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://rong05.github.io/learn/android/binder_driver/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LEAN",
    "logo": {
      "@type": "ImageObject",
      "url": "https://rong05.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://rong05.github.io/" accesskey="h" title="LEAN (Alt + H)">LEAN</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://rong05.github.io/fr/" title="French"
                            aria-label=":fr:">ğŸ‡«ğŸ‡·</a>
                    </li>
                    <li>
                        <a href="https://rong05.github.io/fa/" title="Fa"
                            aria-label="Fa">Fa</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://rong05.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://rong05.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://rong05.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://discord.gg/ahpmTvhVmp" title="Discord">
                    <span>Discord</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://rong05.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://rong05.github.io/learn/">Learns</a></div>
    <h1 class="post-title">
      
    </h1>
    <div class="post-meta">10 min&nbsp;Â·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/learn/android/Binder_Driver.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#binder-driver%e6%8e%a2%e7%b4%a2" aria-label="Binder Driveræ¢ç´¢">Binder Driveræ¢ç´¢</a><ul>
                        
                <li>
                    <a href="#binder%e9%a9%b1%e5%8a%a8%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="binderé©±åŠ¨çš„åˆå§‹åŒ–">binderé©±åŠ¨çš„åˆå§‹åŒ–</a></li>
                <li>
                    <a href="#binder_open" aria-label="binder_open">binder_open</a><ul>
                        
                <li>
                    <a href="#binder_procs%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="binder_procsç»“æ„ä½“">binder_procsç»“æ„ä½“</a></li></ul>
                </li>
                <li>
                    <a href="#binder_mmap" aria-label="binder_mmap">binder_mmap</a><ul>
                        
                <li>
                    <a href="#binder_buffer%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="binder_bufferç»“æ„ä½“">binder_bufferç»“æ„ä½“</a></li>
                <li>
                    <a href="#%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e7%9a%84%e5%88%86%e9%85%8d%e5%92%8c%e9%87%8a%e6%94%be" aria-label="ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾">ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾</a></li></ul>
                </li>
                <li>
                    <a href="#binder_ioctl" aria-label="binder_ioctl">binder_ioctl</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96binder%e7%ba%bf%e7%a8%8b" aria-label="è·å–binderçº¿ç¨‹">è·å–binderçº¿ç¨‹</a></li>
                <li>
                    <a href="#binder_thread%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="binder_threadç»“æ„ä½“">binder_threadç»“æ„ä½“</a></li>
                <li>
                    <a href="#servicemanager%e6%98%af%e5%a6%82%e4%bd%95%e6%88%90binder%e9%a9%b1%e5%8a%a8%e7%9a%84%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e8%80%85" aria-label="ServiceManageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…">ServiceManageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…</a></li>
                <li>
                    <a href="#binder_node%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="binder_nodeç»“æ„ä½“">binder_nodeç»“æ„ä½“</a></li>
                <li>
                    <a href="#binder_ioctl_write_read" aria-label="binder_ioctl_write_read">binder_ioctl_write_read</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="binder-driveræ¢ç´¢">Binder Driveræ¢ç´¢<a hidden class="anchor" aria-hidden="true" href="#binder-driveræ¢ç´¢">#</a></h1>
<h2 id="binderé©±åŠ¨çš„åˆå§‹åŒ–">binderé©±åŠ¨çš„åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#binderé©±åŠ¨çš„åˆå§‹åŒ–">#</a></h2>
<p>åœ¨binder.cä¸­æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼›</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">device_initcall</span><span class="p">(</span><span class="n">binder_init</span><span class="p">);</span>
</span></span></code></pre></div><p>åœ¨Linuxå†…æ ¸çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé©±åŠ¨çš„æ³¨å†Œç”¨module_initè°ƒç”¨ï¼Œå³device_initcallï¼Œå®ƒå¯ä»¥å°†é©±åŠ¨è®¾å¤‡åŠ è½½è¿›å†…æ ¸ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚</p>
<p>åœ¨Android8.0ä¹‹åï¼Œç°åœ¨Binderé©±åŠ¨æœ‰ä¸‰ä¸ªï¼š/dev/binder; /dev/hwbinder; /dev/vndbinder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">binder_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">device_name</span><span class="p">,</span> <span class="o">*</span><span class="n">device_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">device_names</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_alloc_shrinker_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ~0Uï¼šæ— ç¬¦å·æ•´å‹ï¼Œå¯¹0å–åã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_transaction_log</span><span class="p">.</span><span class="n">cur</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_transaction_log_failed</span><span class="p">.</span><span class="n">cur</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ›å»º/sys/kernel/debug/binderç›®å½•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">binder_debugfs_dir_entry_root</span> <span class="o">=</span> <span class="nf">debugfs_create_dir</span><span class="p">(</span><span class="s">&#34;binder&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/procç›®å½•ç”¨äºè®°å½•æ¯ä¸ªè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">binder_debugfs_dir_entry_proc</span> <span class="o">=</span> <span class="nf">debugfs_create_dir</span><span class="p">(</span><span class="s">&#34;proc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">binder_debugfs_dir_entry_root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/stateæ–‡ä»¶ç”¨äºè®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_state_fopsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="s">&#34;state&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_state_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/statsæ–‡ä»¶ç”¨äºè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_stats_fopsã€‚     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="s">&#34;stats&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_stats_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/transactionsæ–‡ä»¶ç”¨äºè®°å½•transactionç›¸å…³ä¿¡æ¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">//å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transactions_fopsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="s">&#34;transactions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_transactions_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionæ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fopsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="s">&#34;transaction_log&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_transaction_log</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_transaction_log_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º/sys/kernel/debug/binder/failed_transaction_logæ–‡ä»¶ç”¨äºè®°å½•transactionå¤±è´¥æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¹¶æ³¨å†Œæ“ä½œå‡½æ•°binder_transaction_log_fops
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="s">&#34;failed_transaction_log&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_transaction_log_failed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">binder_transaction_log_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_ANDROID_BINDERFS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">strcmp</span><span class="p">(</span><span class="n">binder_devices_param</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Copy the module_parameter string, because we don&#39;t want to
</span></span></span><span class="line"><span class="cl"><span class="cm">    * tokenize it in-place.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// kzallocï¼šåˆ†é…ä¸è¶…è¿‡128KBçš„è¿ç»­çš„ç‰©ç†å†…å­˜æ˜ å°„åŒºåŸŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// GFP_KERNELï¼šå†…å­˜åˆ†é…å™¨flagsï¼Œæ— å†…å­˜å¯ç”¨æ—¶å¯å¼•èµ·ä¼‘çœ ï¼Œå…è®¸å¯åŠ¨ç£ç›˜IOå’Œæ–‡ä»¶ç³»ç»ŸIOã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// binder_devices_paramï¼šbinderï¼Œhwbinderï¼Œvndbinderã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">device_names</span> <span class="o">=</span> <span class="nf">kstrdup</span><span class="p">(</span><span class="n">binder_devices_param</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_names</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err_alloc_device_names_failed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// åˆ›å»ºbinderè®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">device_tmp</span> <span class="o">=</span> <span class="n">device_names</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">((</span><span class="n">device_name</span> <span class="o">=</span> <span class="nf">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_tmp</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="nf">init_binder_device</span><span class="p">(</span><span class="n">device_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">err_init_binder_device_failed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆå§‹åŒ–binderæ–‡ä»¶ç³»ç»Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ret</span> <span class="o">=</span> <span class="nf">init_binderfs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err_init_binder_device_failed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err_init_binder_device_failed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_devices</span><span class="p">,</span> <span class="n">hlist</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hlist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">kfree</span><span class="p">(</span><span class="n">device_names</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err_alloc_device_names_failed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">debugfs_remove_recursive</span><span class="p">(</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>binder_init</code>å‡½æ•°ä¸»è¦å†…å®¹æ˜¯ï¼š</p>
<ul>
<li>åˆå§‹åŒ–binderç¼“å†²åŒºåˆ†é…</li>
<li>åˆ›å»ºäº†sys/kernel/debug/binderç›®å½•ï¼Œä»¥åŠå…¶å­ç›®å½•æˆ–æ–‡ä»¶</li>
<li>æ³¨å†Œmiscè®¾å¤‡ï¼Œåˆ›å»ºbinderè®¾å¤‡</li>
<li>æŠŠbinder_deviceåŠ å…¥åˆ°å…¨å±€é“¾è¡¨binder_devicesè¿›è¡Œç®¡ç†</li>
</ul>
<p>é‚£æ¥çœ‹çœ‹<code>init_binder_device</code>æ˜¯å¦‚ä½•æ³¨å†Œmiscè®¾å¤‡ï¼Œåˆ›å»ºbinderè®¾å¤‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_binder_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_device</span> <span class="o">*</span><span class="n">binder_device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">binder_device</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">binder_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">binder_device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//miscdeviceç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">binder_fops</span><span class="p">;</span> <span class="c1">//è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯file_operationsç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">;</span><span class="c1">//æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span><span class="c1">//è®¾å¤‡å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//binderè®¾å¤‡çš„å¼•ç”¨è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">refcount_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//é»˜è®¤binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">binder_context_mgr_uid</span> <span class="o">=</span> <span class="n">INVALID_UID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">context_mgr_node_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ³¨å†Œmiscè®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ret</span> <span class="o">=</span> <span class="nf">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">binder_device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é€šè¿‡å…¨å±€é“¾è¡¨binder_devicesç®¡ç†binder_deviceã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_device</span><span class="o">-&gt;</span><span class="n">hlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_devices</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä»<code>init_binder_device</code>å‡½æ•°çœ‹å‡ºbinderé©±åŠ¨è®¾å¤‡èŠ‚ç‚¹æ˜¯é€šè¿‡<code>binder_device</code>ç»“æ„ä½“ç®¡ç†çš„ï¼›è®¾ç½®<code>binder_device</code>çš„<code>miscdev</code>å‚æ•°ï¼Œ<code>miscdev</code>å…¶å®æ˜¯<code>miscdevice</code>ç»“æ„ä½“ï¼Œmisc_registerå‡½æ•°æ³¨å†Œmiscè®¾å¤‡ï¼Œ<code>miscdevice</code>å‚æ•°åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯file_operationsç»“æ„</li>
<li>æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é…</li>
<li>è®¾å¤‡å</li>
</ol>
<p><code>binder_device</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_device</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åŠ å…¥binder_deviceså…¨å±€é“¾è¡¨çš„nodeã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">hlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// miscè®¾å¤‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">miscdev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// è·å–service managerå¯¹åº”çš„binder_nodeã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_context</span> <span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å±äºbindfsæŒ‚è½½çš„è¶…çº§å—çš„æ ¹èŠ‚ç‚¹çš„inodeã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">binderfs_inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binder_deviceçš„å¼•ç”¨è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">refcount_t</span> <span class="n">ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p><code>file_operations</code>ç»“æ„ä½“,æŒ‡å®šç›¸åº”æ–‡ä»¶æ“ä½œçš„æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">binder_fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">binder_poll</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">binder_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">compat_ptr_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">binder_mmap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">binder_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">binder_flush</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">binder_release</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>ç”¨æˆ·æ€çš„ç¨‹åºè°ƒç”¨Kernelå±‚é©±åŠ¨æ˜¯éœ€è¦é™·å…¥å†…æ ¸æ€ï¼Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨(<code>syscall</code>)ï¼Œæ¯”å¦‚æ‰“å¼€Binderé©±åŠ¨æ–¹æ³•çš„è°ƒç”¨é“¾ä¸ºï¼š open-&gt; __open() -&gt; binder_open()ã€‚é€šè¿‡<code>binder_fops</code>çš„å®šä¹‰å¾—å‡ºä»¥ä¸‹è°ƒç”¨è§„åˆ™ï¼›</p>
<p><img loading="lazy" src="./img/binder_syscall.png" alt="binder_syscall"  />
</p>
<p><a href="http://gityuan.com/2015/11/01/binder-driver/">å›¾ç‰‡æ¥æº</a></p>
<h2 id="binder_open">binder_open<a hidden class="anchor" aria-hidden="true" href="#binder_open">#</a></h2>
<p>ä¹‹å‰å·²ç»æåˆ°æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå•ç‹¬åˆ›å»ºè‡ªå·±çš„<code>ProcessState</code>ï¼Œ<code>ProcessState</code>æ˜¯è¿›ç¨‹å”¯ä¸€çš„ï¼›åœ¨<code>ProcessState</code>åˆ›å»ºæ—¶ä¼šè°ƒç”¨<code>open</code>å‡½æ•°ï¼Œé‚£å¯¹åº”è°ƒç”¨çš„å°±æ˜¯binderé©±åŠ¨ä¸­çš„<code>binder_open</code>;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">nodp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_device</span> <span class="o">*</span><span class="n">binder_dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binderfs_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">binder_binderfs_dir_entry_proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">existing_pid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span> <span class="s">&#34;%s: %d:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆ›å»ºbinderé©±åŠ¨ä¸­ç®¡ç†IPCå’Œä¿å­˜è¿›ç¨‹ä¿¡æ¯çš„æ ¹ç»“æ„ä½“  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">proc</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆå§‹åŒ–ä¸¤ä¸ªè‡ªæ—‹é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// inner_lockä¿æŠ¤çº¿ç¨‹ã€binder_nodeä»¥åŠæ‰€æœ‰ä¸è¿›ç¨‹ç›¸å…³çš„çš„todoé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// outer_lockä¿æŠ¤binder_refã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">inner_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">outer_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å–å½“å‰è¿›ç¨‹ç»„é¢†å¤´è¿›ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">get_task_struct</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="p">;</span><span class="c1">//å°†å½“å‰è¿›ç¨‹çš„task_structä¿å­˜åˆ°binder_proc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span><span class="c1">//åˆå§‹åŒ–todoåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// åˆ¤æ–­å½“å‰è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯å¦æ”¯æŒï¼Œbinderåªæ”¯æŒSCHED_NORMAL(00b)ã€SCHED_FIFO(01b)ã€SCHED_RR(10b)ã€SCHED_BATCH(11b)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// prioä¸ºè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œå¯é€šè¿‡normal_prioè·å–ã€‚ä¸€èˆ¬åˆ†ä¸ºå®æ—¶ä¼˜å…ˆçº§åŠé™æ€ä¼˜å…ˆçº§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">binder_supported_policy</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span><span class="p">.</span><span class="n">sched_policy</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">normal_prio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span><span class="p">.</span><span class="n">sched_policy</span> <span class="o">=</span> <span class="n">SCHED_NORMAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="nf">NICE_TO_PRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* binderfs stashes devices in i_private */</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// é€šè¿‡miscdevè·å–binder_deviceã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">is_binderfs_device</span><span class="p">(</span><span class="n">nodp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">binder_dev</span> <span class="o">=</span> <span class="n">nodp</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span> <span class="o">=</span> <span class="n">nodp</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">binder_binderfs_dir_entry_proc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">proc_log_dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">binder_dev</span> <span class="o">=</span> <span class="nf">container_of</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">binder_device</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binder_deviceçš„å¼•ç”¨è®¡æ•°åŠ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">refcount_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_dev</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆå§‹åŒ–å¯¹åº”è¿›ç¨‹ä¸­çš„binderé©±åŠ¨ä¸Šä¸‹æ–‡ç®¡ç†è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">binder_dev</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆå§‹åŒ–binder_procçš„binder_allocå­—æ®µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">binder_alloc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// binderé©±åŠ¨ç»´æŠ¤é™æ€å…¨å±€æ•°ç»„binder_statsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆå‘˜æ•°ç»„obj_createdã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“binder_openè°ƒç”¨æ—¶ï¼Œobj_created[BINDER_STAT_PROC]å°†è‡ªå¢ã€‚è¯¥æ•°ç»„ç”¨æ¥ç»Ÿè®¡binderå¯¹è±¡çš„æ•°é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_PROC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆå§‹åŒ–binder_procçš„pidä¸ºé¢†å¤´è¿›ç¨‹çš„pidå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆå§‹åŒ–delivered_deathåŠwaiting_threadsé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">delivered_death</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">waiting_threads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// private_dataä¿å­˜binder_procå¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†binder_procåŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—binder_procsä¸­,è¯¥æ“ä½œå¿…é¡»åŠ é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_procs_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">hlist_for_each_entry</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">,</span> <span class="n">proc_node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">existing_pid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">proc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_procs_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è‹¥/sys/kernel/binder/procç›®å½•å·²ç»åˆ›å»ºå¥½ï¼Œåˆ™åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥pidä¸ºåçš„æ–‡ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_proc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">existing_pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strbuf</span><span class="p">),</span> <span class="s">&#34;%u&#34;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * proc debug entries are shared between contexts.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Only create for the first PID to avoid debugfs log spamming
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The printing code will anyway print all contexts for a given
</span></span></span><span class="line"><span class="cl"><span class="cm">     * PID so this is not a problem.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// procè°ƒè¯•æ¡ç›®åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«ï¼Œå¦‚æœè¿›ç¨‹å°è¯•ä½¿ç”¨å…¶ä»–ä¸Šä¸‹æ–‡å†æ¬¡æ‰“å¼€é©±åŠ¨ç¨‹åºï¼Œåˆ™æ­¤æ“ä½œå°†å¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span> <span class="o">=</span> <span class="nf">debugfs_create_file</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">binder_debugfs_dir_entry_proc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">proc_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">binder_binderfs_dir_entry_proc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">existing_pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">binderfs_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strbuf</span><span class="p">),</span> <span class="s">&#34;%u&#34;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Similar to debugfs, the process specific log file is shared
</span></span></span><span class="line"><span class="cl"><span class="cm">     * between contexts. Only create for the first PID.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This is ok since same as debugfs, the log file will contain
</span></span></span><span class="line"><span class="cl"><span class="cm">     * information on all contexts of a given PID.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">binderfs_entry</span> <span class="o">=</span> <span class="nf">binderfs_create_file</span><span class="p">(</span><span class="n">binder_binderfs_dir_entry_proc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">strbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_fops</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">binderfs_entry</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">proc</span><span class="o">-&gt;</span><span class="n">binderfs_entry</span> <span class="o">=</span> <span class="n">binderfs_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">error</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">binderfs_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">pr_warn</span><span class="p">(</span><span class="s">&#34;Unable to create file %s in binderfs (error %d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">strbuf</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä»<code>binder_open</code>å‡½æ•°çš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»º<code>binder_proc</code>ç»“æ„ä½“ï¼Œå¹¶æŠŠå½“å‰è¿›ç¨‹ç­‰ä¿¡æ¯ä¿å­˜åˆ°<code>binder_proc</code>ï¼Œåˆå§‹åŒ–<code>binder_proc</code>ä¸­ç®¡ç†IPCæ‰€éœ€çš„å„ç§ä¿¡æ¯å¹¶åˆ›å»ºå…¶å®ƒç›¸å…³çš„å­ç»“æ„ä½“ï¼›å†æŠŠ<code>binder_proc</code>ä¿å­˜åˆ°æ–‡ä»¶æŒ‡é’ˆ<code>filp</code>ï¼Œä»¥åŠæŠŠ<code>binder_proc</code>åŠ å…¥åˆ°å…¨å±€é“¾è¡¨<code>binder_procs</code>ï¼Œè¿™ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ã€‚</p>
<h3 id="binder_procsç»“æ„ä½“">binder_procsç»“æ„ä½“<a hidden class="anchor" aria-hidden="true" href="#binder_procsç»“æ„ä½“">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_proc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åŠ å…¥binder_procså…¨å±€é“¾è¡¨çš„nodeèŠ‚ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">proc_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è®°å½•æ‰§è¡Œä¼ è¾“åŠ¨ä½œçš„çº¿ç¨‹ä¿¡æ¯, binder_threadçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç”¨äºè®°å½•binderå®ä½“  ,binder_nodeçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒæ˜¯Serveråœ¨Binderé©±åŠ¨ä¸­çš„ä½“ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">nodes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binder_refçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹(ä»¥handleä¸ºkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">refs_by_desc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binder_refçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ˆä»¥pträ¸ºkeyï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">refs_by_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è¯¥binderè¿›ç¨‹çš„çº¿ç¨‹æ± ä¸­ç­‰å¾…å¤„ç†binder_workçš„binder_threadé“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">waiting_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç›¸åº”è¿›ç¨‹id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç›¸åº”è¿›ç¨‹çš„taskç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">deferred_work_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">deferred_work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">is_dead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//è¿›ç¨‹å°†è¦åšçš„äº‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">todo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binderç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">stats</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å·²åˆ†å‘çš„æ­»äº¡é€šçŸ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">delivered_death</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æœ€å¤§çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">max_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è¯·æ±‚çš„çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">requested_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å·²å¯åŠ¨çš„è¯·æ±‚çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">requested_threads_started</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">tmp_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//é»˜è®¤ä¼˜å…ˆçº§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_priority</span> <span class="n">default_priority</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//è¿›ç¨‹é€šä¿¡æ•°æ®å†…å­˜åˆ†é…ç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_alloc</span> <span class="n">alloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">spinlock_t</span> <span class="n">inner_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">spinlock_t</span> <span class="n">outer_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">binderfs_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_alloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æŒ‡å‘è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç›¸åº”è¿›ç¨‹çš„å†…å­˜ç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">vma_vm_mm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// map çš„åœ°å€å°±æ˜¯è¿™é‡Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ‰€æœ‰çš„buffersåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">buffers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åªè¿›è¡Œäº†é¢„å®šï¼Œæ²¡æœ‰åˆ†é…ï¼ŒæŒ‰å¤§å°æ’åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">free_buffers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å·²ç»åˆ†é…äº†,æŒ‰åœ°å€æ’åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">allocated_buffers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç”¨äºå¼‚æ­¥è¯·æ±‚çš„ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">free_async_space</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ‰€æœ‰çš„pagesæŒ‡å‘ç‰©ç†å†…å­˜é¡µ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_lru_page</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ˜ å°„çš„å†…æ ¸ç©ºé—´å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">buffer_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">pages_high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h2 id="binder_mmap">binder_mmap<a hidden class="anchor" aria-hidden="true" href="#binder_mmap">#</a></h2>
<p>ä¸»è¦åŠŸèƒ½ï¼š</p>
<ol>
<li>ä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…ä¸€å—å†…æ ¸ç©ºé—´ä½œä¸ºç¼“å†²åŒºï¼Œå¹¶æŠŠåˆ†é…çš„ç¼“å†²åŒºæŒ‡é’ˆå­˜æ”¾åˆ°binder_procçš„bufferå­—æ®µï¼›</li>
<li>åˆ†é…pagesç©ºé—´ï¼Œå¹¶å†…æ ¸åˆ†é…ä¸€å—åŒæ ·é¡µæ•°çš„å†…æ ¸ç©ºé—´,å¹¶æŠŠå®ƒçš„ç‰©ç†å†…å­˜å’Œå‰é¢ä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…çš„å†…å­˜åœ°å€å…³è”ï¼›</li>
<li>åˆ†é…çš„å†…å­˜å—åŠ å…¥ç”¨æˆ·è¿›ç¨‹å†…å­˜é“¾è¡¨ï¼›</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//private_dataä¿å­˜äº†æˆ‘ä»¬openè®¾å¤‡æ—¶åˆ›å»ºçš„binder_procä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">!=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="nf">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;%s: %d %lx-%lx (%ld K) vma %lx pagep %lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">__func__</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">SZ_1K</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nf">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//mmap çš„ buffer ç¦æ­¢ç”¨æˆ·è¿›è¡Œå†™æ“ä½œã€‚mmap åªæ˜¯ä¸ºäº†åˆ†é…å†…æ ¸ç©ºé—´ï¼Œä¼ é€’æ•°æ®é€šè¿‡ ioctl()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">FORBIDDEN_MMAP_FLAGS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;%s: %d %lx-%lx %s failed %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="s">&#34;bad vm_flags&#34;</span><span class="p">,</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°† VM_DONTCOP ç½®èµ·ï¼Œç¦æ­¢ æ‹·è´ï¼Œç¦æ­¢ å†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_DONTCOPY</span> <span class="o">|</span> <span class="n">VM_MIXEDMAP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VM_MAYWRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">binder_vm_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å†æ¬¡å®Œå–„ binder buffer allocator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nf">binder_alloc_mmap_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">binder_alloc_mmap_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_alloc</span> <span class="o">*</span><span class="n">alloc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">failure_string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ¯ä¸€æ¬¡Binderä¼ è¾“æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆä»Binderå†…å­˜ç¼“å­˜åŒºä¸­åˆ†é…ä¸€ä¸ªbinder_bufferæ¥å­˜å‚¨ä¼ è¾“æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åŒæ­¥é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_alloc_mmap_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ä¸éœ€è¦é‡å¤mmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">failure_string</span> <span class="o">=</span> <span class="s">&#34;already mapped&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err_already_mapped</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//vma-&gt;vm_end, vma-&gt;vm_start æŒ‡å‘è¦ æ˜ å°„çš„ç”¨æˆ·ç©ºé—´åœ°å€, map size ä¸å…è®¸ å¤§äº 4M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">SZ_4M</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_alloc_mmap_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æŒ‡å‘ç”¨æˆ·è¿›ç¨‹å†…æ ¸è™šæ‹Ÿç©ºé—´çš„ startåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆ†é…ç‰©ç†é¡µçš„æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å¤§å°ä¸ºvmaçš„ç­‰æ•ˆpageä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nf">kcalloc</span><span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="k">sizeof</span><span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">             <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">failure_string</span> <span class="o">=</span> <span class="s">&#34;alloc page array&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err_alloc_pages_failed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//ç”³è¯·ä¸€ä¸ªbinder_bufferçš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">failure_string</span> <span class="o">=</span> <span class="s">&#34;alloc buffer struct&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err_alloc_buf_struct_failed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//æŒ‡å‘ç”¨æˆ·è¿›ç¨‹å†…æ ¸è™šæ‹Ÿç©ºé—´çš„ startåœ°å€ï¼Œå³ä¸ºå½“å‰è¿›ç¨‹mmapçš„å†…æ ¸ç©ºé—´åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å°†binder_bufferåœ°å€ï¼ŒåŠ å…¥åˆ°æ‰€å±è¿›ç¨‹çš„buffersé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å°†å½“å‰bufferåŠ å…¥åˆ°çº¢é»‘æ ‘alloc-&gt;free_buffersä¸­ï¼Œè¡¨ç¤ºå½“å‰bufferæ˜¯ç©ºé—²buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">binder_insert_free_buffer</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†å¼‚æ­¥äº‹åŠ¡çš„ç©ºé—´å¤§å°è®¾ç½®ä¸º æ•´ä¸ªç©ºé—´çš„ä¸€åŠ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">free_async_space</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_alloc_set_vma</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mmgrab</span><span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">vma_vm_mm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err_alloc_buf_struct_failed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">kfree</span><span class="p">(</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">err_alloc_pages_failed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_alloc_mmap_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">err_already_mapped</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_alloc_mmap_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_alloc_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_USER_ERROR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;%s: %d %lx-%lx %s failed %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">failure_string</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_insert_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_alloc</span> <span class="o">*</span><span class="n">alloc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">new_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">new_buffer_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é€šè¿‡binder_alloc_buffer_sizeè®¡ç®—å½“å‰new_bufferçš„å¤§å°ï¼Œä¹‹åå°†ç”¨äºæ¯”è¾ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">new_buffer_size</span> <span class="o">=</span> <span class="nf">binder_alloc_buffer_size</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span> <span class="n">new_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">binder_alloc_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;%d: add free buffer, size %zd, at %pK</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">alloc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_buffer_size</span><span class="p">,</span> <span class="n">new_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰çº¢é»‘æ ‘èŠ‚ç‚¹çš„bufferã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span> <span class="o">=</span> <span class="nf">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// è®¡ç®—å½“å‰çº¢é»‘æ ‘èŠ‚ç‚¹çš„bufferå¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer_size</span> <span class="o">=</span> <span class="nf">binder_alloc_buffer_size</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çº¢é»‘æ ‘éµå¾ªäºŒå‰æ ‘è§„åˆ™ï¼šå½“æ–°çš„bufferæ¯”å½“å‰èŠ‚ç‚¹çš„bufferå°æ—¶ï¼Œå‘å·¦å­èŠ‚ç‚¹ç»§ç»­é‡å¤ï¼Œå¦åˆ™è½¬å‘å³å­èŠ‚ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">new_buffer_size</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ‰¾åˆ°åˆé€‚ä½ç½®åï¼Œå°†new_bufferæ’å…¥åˆ°è¯¥ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>binder_mmap</code>é€šè¿‡åŠ é”ï¼Œä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªè¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¿è¯å¤šè¿›ç¨‹é—´çš„å¹¶å‘è®¿é—®ã€‚å°†åˆ†é…ä¸€å—å†…æ ¸ç©ºé—´ç¼“å†²åŒºbufferåŠ å…¥åˆ°çº¢é»‘æ ‘alloc-&gt;free_buffersä¸­ï¼Œè¡¨ç¤ºå½“å‰bufferæ˜¯ç©ºé—²bufferï¼›æ¯ä¸€æ¬¡Binderä¼ è¾“æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆä»Binderå†…å­˜ç¼“å­˜åŒºä¸­åˆ†é…ä¸€ä¸ªbinder_bufferæ¥å­˜å‚¨ä¼ è¾“æ•°æ®ã€‚</p>
<h3 id="binder_bufferç»“æ„ä½“">binder_bufferç»“æ„ä½“<a hidden class="anchor" aria-hidden="true" href="#binder_bufferç»“æ„ä½“">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_buffer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//bufferå®ä½“çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span> <span class="cm">/* free and allocated entries by address */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span> <span class="cm">/* free entry by size or allocated entry */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* by address */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ ‡è®°æ˜¯å¦æ˜¯ç©ºé—²bufferï¼Œå ä½1bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="nl">free</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ˜¯å¦å…è®¸ç”¨æˆ·é‡Šæ”¾ï¼Œå ä½1bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="nl">clear_on_free</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="nl">allow_user_free</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="nl">async_transaction</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="nl">debug_id</span><span class="p">:</span><span class="mi">28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//è¯¥ç¼“å­˜åŒºçš„éœ€è¦å¤„ç†çš„äº‹åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">transaction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//è¯¥ç¼“å­˜åŒºæ‰€éœ€å¤„ç†çš„Binderå®ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">target_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">//æ•°æ®å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">data_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ•°æ®åç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">offsets_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">extra_buffers_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ç”¨æˆ·æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_lru_page</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">lru</span><span class="p">;</span><span class="c1">//binder_alloc_lruä¸­çš„æ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page_ptr</span><span class="p">;</span><span class="c1">//æŒ‡å‘mmapç©ºé—´ä¸­çš„ç‰©ç†é¡µé¢çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_alloc</span> <span class="o">*</span><span class="n">alloc</span><span class="p">;</span><span class="c1">//procçš„binder_alloc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><p><code>binder_mmap</code>è¿™é‡Œä¸»è¦æ˜ å°„çš„å†…å­˜åªå…è®¸ç”¨æˆ·ç©ºé—´è¯»ï¼Œä¸å…è®¸ç”¨æˆ·ç©ºé—´å†™ï¼›<code>binder</code>é©±åŠ¨å¯ä»¥è¯»å†™è¿™å—å†…å­˜ï¼›å­˜æ˜ å°„å®ç°ä¸€æ¬¡æ‹·è´çš„æ¦‚å¿µæ˜¯ï¼š</p>
<ol>
<li>ç”¨æˆ·ç©ºé—´ç»™<code>binder</code>é©±åŠ¨ä¼ å…¥ä¿¡æ¯æ—¶ï¼Œéƒ½éœ€è¦å†…å­˜æ‹·è´ï¼›</li>
<li><code>binder</code>é©±åŠ¨ç»™å‘é€ç”¨æˆ·ç©ºé—´åˆ™ä¸éœ€è¦ï¼›</li>
</ol>
<h3 id="ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾">ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾<a hidden class="anchor" aria-hidden="true" href="#ç‰©ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾">#</a></h3>
<p><code>binder_update_page_range</code>å‡½æ•°ä¸»è¦çš„ä½œç”¨æ˜¯åˆ†é…å’Œé‡Šæ”¾ç‰©ç†å†…å­˜ï¼›</p>
<h2 id="binder_ioctl">binder_ioctl<a hidden class="anchor" aria-hidden="true" href="#binder_ioctl">#</a></h2>
<p>binder_ioctl()å‡½æ•°è´Ÿè´£åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´æ”¶å‘IPCæ•°æ®å’ŒIPC replyæ•°æ®ã€‚</p>
<p>ioctlå‘½ä»¤å’Œæ•°æ®ç±»å‹æ˜¯ä¸€ä½“çš„ï¼Œä¸åŒçš„å‘½ä»¤å¯¹åº”ä¸åŒçš„æ•°æ®ç±»å‹</p>
<table>
<thead>
<tr>
<th style="text-align:left">ioctlå‘½ä»¤</th>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">æ“ä½œ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>BINDER_WRITE_READ</strong></td>
<td style="text-align:left">struct binder_write_read</td>
<td style="text-align:left">æ”¶å‘Binder IPCæ•°æ®</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_MAX_THREADS</td>
<td style="text-align:left">__u32</td>
<td style="text-align:left">è®¾ç½®Binderçº¿ç¨‹æœ€å¤§ä¸ªæ•°</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_CONTEXT_MGR</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">è®¾ç½®Service ManagerèŠ‚ç‚¹</td>
</tr>
<tr>
<td style="text-align:left">BINDER_THREAD_EXIT</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">é‡Šæ”¾Binderçº¿ç¨‹</td>
</tr>
<tr>
<td style="text-align:left">BINDER_VERSION</td>
<td style="text-align:left">struct binder_version</td>
<td style="text-align:left">è·å–Binderç‰ˆæœ¬ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_IDLE_TIMEOUT</td>
<td style="text-align:left">__s64</td>
<td style="text-align:left">æ²¡æœ‰ä½¿ç”¨</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_IDLE_PRIORITY</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">æ²¡æœ‰ä½¿ç”¨</td>
</tr>
</tbody>
</table>
<p>è¿™äº›å‘½ä»¤ä¸­<code>BINDER_WRITE_READ</code>å‘½ä»¤ä½¿ç”¨ç‡æœ€ä¸ºé¢‘ç¹ï¼Œä¹Ÿæ˜¯ioctlæœ€ä¸ºæ ¸å¿ƒçš„å‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">binder_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//oepnçš„æ—¶å€™åŒ…åœ¨filpçš„private_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*pr_info(&#34;binder_ioctl: %d:%d %x %lx\n&#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">      proc-&gt;pid, current-&gt;pid, cmd, arg);*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">binder_selftest_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">trace_binder_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//è¿™é‡Œæ—¶ä¸€ä¸ªé˜»å¡ä»£ç ï¼Œå¦‚æœbinder_stop_on_user_error å¤§äº2è¿™é‡Œä¼šè¢«ä¼‘çœ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//è¿™é‡Œå…ˆæ— è§†å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ret</span> <span class="o">=</span> <span class="nf">wait_event_interruptible</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">,</span> <span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err_unlocked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ç»“æ„ä½“ï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªæ”¾å…¥åˆ°procçš„çº¢é»‘æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">thread</span> <span class="o">=</span> <span class="nf">binder_get_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_WRITE_READ</span><span class="p">:</span><span class="c1">//è¿›è¡Œbinderçš„è¯»å†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_ioctl_write_read</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_SET_MAX_THREADS</span><span class="p">:</span> <span class="p">{</span><span class="c1">//è®¾ç½®binderæœ€å¤§æ”¯æŒçš„çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">max_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max_threads</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="k">sizeof</span><span class="p">(</span><span class="n">max_threads</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_lock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">max_threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_unlock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_SET_CONTEXT_MGR_EXT</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//è®¾ç½®Service ManagerèŠ‚ç‚¹ï¼Œå¸¦flagå‚æ•°ï¼Œ servicemanagerè¿›ç¨‹æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="n">fbo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbo</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbo</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_ioctl_set_ctx_mgr</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_SET_CONTEXT_MGR</span><span class="p">:</span><span class="c1">//æˆä¸ºbinderçš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œä¸å¸¦flagå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ServiceManageræˆä¸ºå®ˆæŠ¤è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_ioctl_set_ctx_mgr</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_THREAD_EXIT</span><span class="p">:</span><span class="c1">//å½“binderçº¿ç¨‹é€€å‡ºï¼Œé‡Šæ”¾binderçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span> <span class="s">&#34;%d:%d exit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_thread_release</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_VERSION</span><span class="p">:</span> <span class="p">{</span><span class="c1">//è·å–binderçš„ç‰ˆæœ¬å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">binder_version</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ubuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_version</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">put_user</span><span class="p">(</span><span class="n">BINDER_CURRENT_PROTOCOL_VERSION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">protocol_version</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_GET_NODE_INFO_FOR_REF</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">binder_node_info_for_ref</span> <span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_ioctl_get_node_info_for_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">BINDER_GET_NODE_DEBUG_INFO</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">binder_node_debug_info</span> <span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_ioctl_get_node_debug_info</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper_need_return</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">wait_event_interruptible</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">,</span> <span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;%d:%d ioctl %x %lx returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">err_unlocked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">trace_binder_ioctl_done</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="è·å–binderçº¿ç¨‹">è·å–binderçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è·å–binderçº¿ç¨‹">#</a></h3>
<p>ä»binder_procä¸­æŸ¥æ‰¾binder_thread,å¦‚æœå½“å‰çº¿ç¨‹å·²ç»åŠ å…¥åˆ°procçš„çº¿ç¨‹é˜Ÿåˆ—åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºbinder_threadï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°å½“å‰çš„proc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="nf">binder_get_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">new_thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">binder_inner_proc_lock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//ä»å½“å‰è¿›ç¨‹ä¸­è·å–çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">thread</span> <span class="o">=</span> <span class="nf">binder_get_thread_ilocked</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_inner_proc_unlock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœå½“å‰è¿›ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹ï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_thread</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="kr">thread</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">new_thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_lock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">thread</span> <span class="o">=</span> <span class="nf">binder_get_thread_ilocked</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">new_thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_unlock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">!=</span> <span class="n">new_thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">kfree</span><span class="p">(</span><span class="n">new_thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="binder_threadç»“æ„ä½“">binder_threadç»“æ„ä½“<a hidden class="anchor" aria-hidden="true" href="#binder_threadç»“æ„ä½“">#</a></h3>
<p><code>binder_thread</code>æ˜¯å½“å‰binderæ“ä½œæ‰€åœ¨çš„çº¿ç¨‹ï¼›</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_thread</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span><span class="c1">//çº¿ç¨‹æ‰€å±çš„è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span> <span class="c1">//çº¢é»‘æ ‘èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">waiting_thread_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span><span class="c1">//çº¿ç¨‹pid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">looper</span><span class="p">;</span>              <span class="cm">/* only modified by this thread */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">looper_need_return</span><span class="p">;</span> <span class="cm">/* can be written by other thread */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">transaction_stack</span><span class="p">;</span><span class="c1">//çº¿ç¨‹æ­£åœ¨å¤„ç†çš„äº‹åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">todo</span><span class="p">;</span><span class="c1">//å°†è¦å¤„ç†çš„é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">process_todo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_error</span> <span class="n">return_error</span><span class="p">;</span><span class="c1">//writeå¤±è´¥åï¼Œè¿”å›çš„é”™è¯¯ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_error</span> <span class="n">reply_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span> <span class="c1">//ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">stats</span><span class="p">;</span><span class="c1">//binderçº¿ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">atomic_t</span> <span class="n">tmp_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">is_dead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h3 id="servicemanageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…">ServiceManageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…<a hidden class="anchor" aria-hidden="true" href="#servicemanageræ˜¯å¦‚ä½•æˆbinderé©±åŠ¨çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…">#</a></h3>
<p><code>ServiceManager</code>åœ¨nativeå±‚ä¸­<code>ProcessState</code>çš„<code>becomeContextManager</code>å‡½æ•°é€šè¿‡<code>ioctl</code>å‘é€<code>BINDER_SET_CONTEXT_MGR_EXT</code> å‘½ä»¤ï¼Œè®©è‡ªèº«æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…;ç„¶ååœ¨binderé©±åŠ¨ä¸­çš„<code>binder_ioctl</code>æ¥æ”¶åˆ°äº†<code>BINDER_SET_CONTEXT_MGR_EXT</code>æŒ‡ä»¤åï¼›é€šè¿‡<code>binder_ioctl_set_ctx_mgr</code>å‡½æ•°è¿›è¡Œå¤„ç†ï¼›</p>
<p><strong>binder_ioctl_set_ctx_mgr()å¤„ç†å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li>é€šè¿‡<code>filp-&gt;private_data</code>æ‰¾åˆ°<code>binder_proc</code>;</li>
<li>å¯¹å½“å‰è¿›ç¨‹è¿›è¡Œæ˜¯å¦å…·æ³¨å†ŒContext Managerçš„SELinuxå®‰å…¨æƒé™çš„æ£€æŸ¥</li>
<li>è¿›è¡Œuidæ£€æŸ¥ï¼Œçº¿ç¨‹åªèƒ½æ³¨å†Œè‡ªå·±ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºContext Manager</li>
<li>è®¾ç½®å½“å‰çº¿ç¨‹euidä½œä¸ºServiceManagerçš„uidï¼›</li>
<li>åˆ›å»ºä¸€ä¸ªbinderå®ä½“binder_nodeï¼Œå¹¶åŠ å…¥åˆ°å½“å‰è¿›ç¨‹çš„nodesçº¢é»‘æ ‘ä¸­ï¼›</li>
<li>æŠŠæ–°åˆ›å»ºçš„binder_node,èµ‹å€¼ç»™å½“å‰è¿›ç¨‹çš„binder_context_mgr_nodeï¼Œè¿™æ ·å°±çº¦å®šè¯¥è¿›ç¨‹å°±æˆä¸ºäº†binderé©±åŠ¨çš„ä¸Šä¸‹æ–‡çš„ç®¡ç†è€…ï¼›</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_ioctl_set_ctx_mgr</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="o">*</span><span class="n">fbo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//filp-&gt;private_data åœ¨open()binderé©±åŠ¨æ—¶ï¼Œä¿å­˜äº†ä¸€ä¸ªåˆ›å»ºçš„binder_procï¼Œå³æ˜¯æ­¤æ—¶è°ƒç”¨è¿›ç¨‹çš„binder_proc.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//è·å¾—å½“å‰è¿›ç¨‹çš„context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">binder_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">new_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">kuid_t</span> <span class="n">curr_euid</span> <span class="o">=</span> <span class="nf">current_euid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">context_mgr_node_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ä¿è¯åªåˆ›å»ºä¸€æ¬¡mgr_nodeå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;BINDER_SET_CONTEXT_MGR already set</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦å…·æ³¨å†ŒContext Managerçš„SEAndroidå®‰å…¨æƒé™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ret</span> <span class="o">=</span> <span class="nf">security_binder_set_context_mgr</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ£€æŸ¥å·²çš„uidæ˜¯å¦æœ‰æ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">uid_valid</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_uid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//uidæœ‰æ•ˆä½†æ˜¯ä¸å½“å‰è¿è¡Œçº¿ç¨‹çš„æ•ˆç”¨æˆ·IDä¸ç›¸ç­‰ï¼Œåˆ™å‡ºé”™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å³çº¿ç¨‹åªèƒ½æ³¨å†Œè‡ªå·±ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºContext Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">uid_eq</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_uid</span><span class="p">,</span> <span class="n">curr_euid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;BINDER_SET_CONTEXT_MGR bad uid %d != %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nf">from_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">curr_euid</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="nf">from_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_uid</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è®¾ç½®å½“å‰çº¿ç¨‹euidä½œä¸ºServiceManagerçš„uid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_uid</span> <span class="o">=</span> <span class="n">curr_euid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆ›å»ºbinderå®ä½“ï¼Œå¹¶åŠ å…¥åˆ°å½“å‰è¿›ç¨‹çš„nodesçº¢é»‘æ ‘ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥æ˜¯ServiceManager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">new_node</span> <span class="o">=</span> <span class="nf">binder_new_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fbo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_node_lock</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ›´æ–°new_nodeçš„ç›¸å…³å¼ºå¼±å¼•ç”¨è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//new_node èµ‹å€¼ç»™è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ç®¡ç†èŠ‚ç‚¹ï¼Œä½œä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">context</span><span class="o">-&gt;</span><span class="n">binder_context_mgr_node</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_node_unlock</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_put_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">context_mgr_node_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="binder_nodeç»“æ„ä½“">binder_nodeç»“æ„ä½“<a hidden class="anchor" aria-hidden="true" href="#binder_nodeç»“æ„ä½“">#</a></h3>
<p><code>binder_node</code>ä»£è¡¨ä¸€ä¸ªbinderå®ä½“</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">binder_node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">debug_id</span><span class="p">;</span><span class="c1">//èŠ‚ç‚¹åˆ›å»ºæ—¶åˆ†é…ï¼Œå…·æœ‰å…¨å±€å”¯ä¸€æ€§ï¼Œç”¨äºè°ƒè¯•ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_work</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span><span class="c1">//binderèŠ‚ç‚¹æ­£å¸¸ä½¿ç”¨ï¼Œunion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">dead_node</span><span class="p">;</span><span class="c1">//binderèŠ‚ç‚¹å·²é”€æ¯ï¼Œunion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span><span class="c1">//binderæ‰€åœ¨çš„è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">refs</span><span class="p">;</span><span class="c1">//æ‰€æœ‰æŒ‡å‘è¯¥èŠ‚ç‚¹çš„binderå¼•ç”¨é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">internal_strong_refs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_weak_refs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_strong_refs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">tmp_refs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">binder_uintptr_t</span> <span class="n">ptr</span><span class="p">;</span><span class="c1">//æŒ‡å‘ç”¨æˆ·ç©ºé—´binder_nodeçš„æŒ‡é’ˆï¼Œå¯¹åº”flat_binder_object.binder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">binder_uintptr_t</span> <span class="n">cookie</span><span class="p">;</span><span class="c1">//æ•°æ®ï¼Œå¯¹åº”flat_binder_object.cooki
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * bitfield elements protected by
</span></span></span><span class="line"><span class="cl"><span class="cm">     * proc inner_lock
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">has_strong_ref</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">pending_strong_ref</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">has_weak_ref</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">pending_weak_ref</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * invariant after initialization
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">sched_policy</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">inherit_rt</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">accept_fds</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="nl">txn_security_ctx</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="n">min_priority</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">has_async_transaction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">async_todo</span><span class="p">;</span><span class="c1">//å¼‚æ­¥todoé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><h3 id="binder_ioctl_write_read">binder_ioctl_write_read<a hidden class="anchor" aria-hidden="true" href="#binder_ioctl_write_read">#</a></h3>
<p><code>binder_ioctl_write_read</code>æ˜¯binderæ•°æ®äº¤äº’çš„æ ¸å¿ƒå…¥å£,åœ¨nativeå±‚ä¸­é€šè¿‡<code>ioctl</code>å‘é€<code>BINDER_WRITE_READ</code>å‘½ä»¤æ‰§è¡Œè¯¥å‡½æ•°ï¼Œ<code>arg</code>æ˜¯ä¸€ä¸ª<code>binder_write_read</code>ç»“æ„ä½“;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_ioctl_write_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">binder_write_read</span> <span class="n">bwr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_write_read</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æŠŠç”¨æˆ·ç©ºé—´æ•°æ®ubufæ‹·è´åˆ°bwr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_READ_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;%d:%d write %lld at %016llx, read %lld at %016llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å½“å†™ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinderå†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_thread_write</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">bwr</span><span class="p">.</span><span class="n">write_buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_consumed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">trace_binder_write_done</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//binder_thread_writeä¸­æœ‰é”™è¯¯å‘ç”Ÿï¼Œåˆ™read_consumedè®¾ä¸º0ï¼Œè¡¨ç¤ºkernelæ²¡æœ‰æ•°æ®è¿”å›ç»™è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å°†bwrè¿”å›ç»™ç”¨æˆ·æ€è°ƒç”¨è€…ï¼Œbwråœ¨binder_thread_writeä¸­ä¼šè¢«ä¿®æ”¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å½“è¯»ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinderè¯»æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">binder_thread_read</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">read_buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="o">&amp;</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">trace_binder_read_done</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_lock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¯»å–å®Œåï¼Œå¦‚æœproc-&gt;todoé“¾è¡¨ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’åœ¨proc-&gt;waitç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">binder_worklist_empty_ilocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="nf">binder_wakeup_proc_ilocked</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">binder_inner_proc_unlock</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœbinder_thread_readè¿”å›å°äº0ï¼Œå¯èƒ½å¤„ç†ä¸€åŠå°±ä¸­æ–­äº†ï¼Œéœ€è¦å°†bwræ‹·è´å›è¿›ç¨‹çš„ç”¨æˆ·æ€åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_READ_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;%d:%d wrote %lld of %lld, read return %lld of %lld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_consumed</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å°†å†…æ ¸æ•°æ®bwræ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ubuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>æµç¨‹:</strong></p>
<ol>
<li>ç”¨æˆ·ç©ºé—´æ•°æ®ubufæ‹·è´åˆ°å†…æ ¸ç©ºé—´bwr;</li>
<li>å½“bwrå†™ç¼“å­˜æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinder_thread_writeï¼›å½“å†™å¤±è´¥åˆ™read_consumedè®¾ä¸º0ï¼Œå¹¶å°†bwræ•°æ®å†™å›ç”¨æˆ·ç©ºé—´å¹¶é€€å‡ºï¼›</li>
<li>å½“bwrè¯»ç¼“å­˜æœ‰æ•°æ®ï¼Œåˆ™æ‰§è¡Œbinder_thread_readï¼Œè¯»å–å®Œåï¼Œå¦‚æœproc-&gt;todoé“¾è¡¨ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’åœ¨proc-&gt;waitç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹;å½“è¯»å¤±è´¥åˆ™å†å°†bwræ•°æ®å†™å›ç”¨æˆ·ç©ºé—´å¹¶é€€å‡ºï¼›</li>
<li>æŠŠå†…æ ¸æ•°æ®bwræ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ubufã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://rong05.github.io/learn/android/android_selinux/">
    <span class="title">Â« Prev</span>
    <br>
    <span></span>
  </a>
  <a class="next" href="https://rong05.github.io/learn/android/mediacodec_learn/">
    <span class="title">Next Â»</span>
    <br>
    <span></span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on x"
        href="https://x.com/intent/tweet/?text=&amp;url=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z"/>
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f&amp;title=&amp;summary=&amp;source=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f&title=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on whatsapp"
        href="https://api.whatsapp.com/send?text=%20-%20https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on telegram"
        href="https://telegram.me/share/url?text=&amp;url=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share  on ycombinator"
        href="https://news.ycombinator.com/submitlink?t=&u=https%3a%2f%2frong05.github.io%2flearn%2fandroid%2fbinder_driver%2f">
        <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
            <path
                d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://rong05.github.io/">LEAN</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
